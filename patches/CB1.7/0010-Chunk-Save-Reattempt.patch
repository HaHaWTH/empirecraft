From d31af08ba8aed6029eff02467969573f4a36f164 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Mon, 4 Mar 2013 23:46:10 -0500
Subject: [PATCH] Chunk Save Reattempt

We commonly have "Stream Closed" errors on chunk saving, so this code should re-try to save the chunk in the event of failure and hopefully prevent rollbacks.
---
 src/main/java/net/minecraft/server/ChunkRegionLoader.java | 3 +++
 src/main/java/net/minecraft/server/RegionFile.java        | 5 +++--
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/src/main/java/net/minecraft/server/ChunkRegionLoader.java b/src/main/java/net/minecraft/server/ChunkRegionLoader.java
index 1875494..387fd94 100644
--- a/src/main/java/net/minecraft/server/ChunkRegionLoader.java
+++ b/src/main/java/net/minecraft/server/ChunkRegionLoader.java
@@ -168,11 +168,14 @@ public class ChunkRegionLoader implements IAsyncChunkSaver, IChunkLoader {
         }
 
         if (pendingchunktosave != null) {
+            int attempts = 0; while (attempts++ < 5) { // EMC
             try {
                 this.a(pendingchunktosave);
+                if (attempts > 1) { System.err.println("Successfully prevented a chunk rollback with " + attempts + " attempts."); } break; // EMC
             } catch (Exception exception) {
                 exception.printStackTrace();
             }
+            try {Thread.sleep(10);} catch (InterruptedException e) {e.printStackTrace();} } // EMC
         }
 
         return true;
diff --git a/src/main/java/net/minecraft/server/RegionFile.java b/src/main/java/net/minecraft/server/RegionFile.java
index e9cb09f..690a313 100644
--- a/src/main/java/net/minecraft/server/RegionFile.java
+++ b/src/main/java/net/minecraft/server/RegionFile.java
@@ -177,7 +177,7 @@ public class RegionFile {
         return this.d(i, j) ? null : new DataOutputStream(new DeflaterOutputStream(new ChunkBuffer(this, i, j)));
     }
 
-    protected synchronized void a(int i, int j, byte[] abyte, int k) {
+    protected synchronized void a(int i, int j, byte[] abyte, int k) throws Exception { // EMC - Add exception
         try {
             int l = this.e(i, j);
             int i1 = l >> 8;
@@ -246,7 +246,8 @@ public class RegionFile {
 
             this.b(i, j, (int) (MinecraftServer.aq() / 1000L));
         } catch (IOException ioexception) {
-            ioexception.printStackTrace();
+            //ioexception.printStackTrace(); // EMC
+            throw (Exception) ioexception; // EMC - we want the upper try/catch to retry this
         }
     }
 
-- 
1.8.4.4

