From 5dd2f8e06ee2746b4e037f908b84fe00168a3cf8 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Wed, 7 Aug 2013 19:52:14 -0400
Subject: [PATCH] VehicleExitEvent Dismount Reason API

---
 src/main/java/net/minecraft/server/Entity.java       | 5 +++++
 src/main/java/net/minecraft/server/EntityHuman.java  | 2 ++
 src/main/java/net/minecraft/server/EntityLiving.java | 1 +
 src/main/java/net/minecraft/server/World.java        | 2 ++
 4 files changed, 10 insertions(+)

diff --git a/src/main/java/net/minecraft/server/Entity.java b/src/main/java/net/minecraft/server/Entity.java
index d04c8d4..0aed468 100644
--- a/src/main/java/net/minecraft/server/Entity.java
+++ b/src/main/java/net/minecraft/server/Entity.java
@@ -1415,7 +1415,10 @@ public abstract class Entity {
         return this.bukkitEntity;
     }
 
+    VehicleExitEvent.DismountReason dismountReason = VehicleExitEvent.DismountReason.UNKNOWN; // EMC
     public void setPassengerOf(Entity entity) {
+        VehicleExitEvent.DismountReason reason = dismountReason; // EMC
+        dismountReason = VehicleExitEvent.DismountReason.UNKNOWN; // EMC
         // b(null) doesn't really fly for overloaded methods,
         // so this method is needed
 
@@ -1431,6 +1434,7 @@ public abstract class Entity {
                 // CraftBukkit start
                 if ((this.bukkitEntity instanceof LivingEntity) && (this.vehicle.getBukkitEntity() instanceof Vehicle)) {
                     VehicleExitEvent event = new VehicleExitEvent((Vehicle) this.vehicle.getBukkitEntity(), (LivingEntity) this.bukkitEntity);
+                    event.reason = reason; // EMC
                     pluginManager.callEvent(event);
 
                     if (event.isCancelled() || this.vehicle != originalVehicle) {
@@ -1452,6 +1456,7 @@ public abstract class Entity {
                 VehicleExitEvent exitEvent = null;
                 if (this.vehicle != null && this.vehicle.getBukkitEntity() instanceof Vehicle) {
                     exitEvent = new VehicleExitEvent((Vehicle) this.vehicle.getBukkitEntity(), (LivingEntity) this.bukkitEntity);
+                    exitEvent.reason = VehicleExitEvent.DismountReason.TRANSFER; // EMC
                     pluginManager.callEvent(exitEvent);
 
                     if (exitEvent.isCancelled() || this.vehicle != originalVehicle || (this.vehicle != null && this.vehicle.passenger != originalPassenger)) {
diff --git a/src/main/java/net/minecraft/server/EntityHuman.java b/src/main/java/net/minecraft/server/EntityHuman.java
index 49eec01..fdad2f1 100644
--- a/src/main/java/net/minecraft/server/EntityHuman.java
+++ b/src/main/java/net/minecraft/server/EntityHuman.java
@@ -336,6 +336,7 @@ public abstract class EntityHuman extends EntityLiving implements ICommandListen
 
     public void V() {
         if (!this.world.isStatic && this.isSneaking()) {
+            this.dismountReason = org.bukkit.event.vehicle.VehicleExitEvent.DismountReason.PLAYER; // EMC
             this.mount((Entity) null);
             this.setSneaking(false);
         } else {
@@ -1009,6 +1010,7 @@ public abstract class EntityHuman extends EntityLiving implements ICommandListen
         }
 
         if (this.ag()) {
+            this.dismountReason = org.bukkit.event.vehicle.VehicleExitEvent.DismountReason.PLAYER; // EMC
             this.mount((Entity) null);
         }
 
diff --git a/src/main/java/net/minecraft/server/EntityLiving.java b/src/main/java/net/minecraft/server/EntityLiving.java
index a9835b4..d8095a9 100644
--- a/src/main/java/net/minecraft/server/EntityLiving.java
+++ b/src/main/java/net/minecraft/server/EntityLiving.java
@@ -182,6 +182,7 @@ public abstract class EntityLiving extends Entity {
 
             this.extinguish();
             if (!this.world.isStatic && this.ag() && this.vehicle instanceof EntityLiving) {
+                this.dismountReason = org.bukkit.event.vehicle.VehicleExitEvent.DismountReason.WATER; // EMC
                 this.mount((Entity) null);
             }
         } else {
diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index 7913a8c..90e2efd 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -1040,10 +1040,12 @@ public abstract class World implements IBlockAccess {
 
     public void kill(Entity entity) {
         if (entity.passenger != null) {
+            entity.passenger.dismountReason = org.bukkit.event.vehicle.VehicleExitEvent.DismountReason.DEAD; // EMC
             entity.passenger.mount((Entity) null);
         }
 
         if (entity.vehicle != null) {
+            entity.dismountReason = org.bukkit.event.vehicle.VehicleExitEvent.DismountReason.DEAD; // EMC
             entity.mount((Entity) null);
         }
 
-- 
1.8.4.4

