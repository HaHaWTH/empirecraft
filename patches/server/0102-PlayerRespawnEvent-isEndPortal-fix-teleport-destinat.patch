From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: chickeneer <emcchickeneer@gmail.com>
Date: Tue, 17 Mar 2020 12:25:11 -0500
Subject: [PATCH] PlayerRespawnEvent#isEndPortal / fix teleport destination for
 end respawn

Ability to detect if it is the end portal being used.

When respawning, use current dimension instead of forced overworld

So only END -> OVERWORLD occurs in using portal or teleporting,
where location is not null
---
 src/main/java/net/minecraft/server/PlayerConnection.java     | 2 +-
 src/main/java/net/minecraft/server/PlayerList.java           | 3 ++-
 src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java | 2 +-
 3 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index 5d87cf7725b09740e6baf3f0dbb6560d411fe673..43fd87d52f26dd14d6956829b3949dab64f067b6 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -2143,7 +2143,7 @@ public class PlayerConnection implements PacketListenerPlayIn {
                         return;
                     }
 
-                    this.player = this.minecraftServer.getPlayerList().moveToWorld(this.player, DimensionManager.OVERWORLD, false);
+                    this.player = this.minecraftServer.getPlayerList().moveToWorld(this.player, this.player.getWorldServer().worldProvider.getDimensionManager(), false); // EMC
                     if (this.minecraftServer.isHardcore()) {
                         this.player.a(EnumGamemode.SPECTATOR);
                         ((GameRules.GameRuleBoolean) this.player.getWorldServer().getGameRules().get(GameRules.SPECTATORS_GENERATE_CHUNKS)).a(false, this.minecraftServer);
diff --git a/src/main/java/net/minecraft/server/PlayerList.java b/src/main/java/net/minecraft/server/PlayerList.java
index c5094f8f17389250cec85582a4bc7b6f87cf54f8..d98ea28d89a0f39f15855541a71874cad94faa4a 100644
--- a/src/main/java/net/minecraft/server/PlayerList.java
+++ b/src/main/java/net/minecraft/server/PlayerList.java
@@ -743,7 +743,8 @@ public abstract class PlayerList {
             }
 
             Player respawnPlayer = cserver.getPlayer(entityplayer1);
-            PlayerRespawnEvent respawnEvent = new PlayerRespawnEvent(respawnPlayer, location, isBedSpawn);
+            boolean isEndPortal = dimensionmanager.getType() == DimensionManager.OVERWORLD && entityplayer.world.worldProvider.getDimensionManager().getType() == DimensionManager.THE_END; // EMC
+            PlayerRespawnEvent respawnEvent = new PlayerRespawnEvent(respawnPlayer, location, isBedSpawn, isEndPortal); // EMC - add isLeavingEnd
             cserver.getPluginManager().callEvent(respawnEvent);
             // Spigot Start
             if (entityplayer.playerConnection.isDisconnected()) {
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index d8bb10554c5cdb5943fa159735dfde5f298491e1..15183d4d7e71b57bcb117beca92c74bc2aa1a256 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -2050,7 +2050,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         {
             if ( getHealth() <= 0 && isOnline() )
             {
-                server.getServer().getPlayerList().moveToWorld( getHandle(), net.minecraft.server.DimensionManager.OVERWORLD, false );
+                server.getServer().getPlayerList().moveToWorld( getHandle(), getHandle().world.worldProvider.getDimensionManager(), false ); // EMC
             }
         }
 
