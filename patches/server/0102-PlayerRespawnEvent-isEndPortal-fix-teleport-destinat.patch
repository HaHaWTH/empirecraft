From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: chickeneer <emcchickeneer@gmail.com>
Date: Tue, 17 Mar 2020 12:25:11 -0500
Subject: [PATCH] PlayerRespawnEvent#isEndPortal / fix teleport destination for
 end respawn

Ability to detect if it is the end portal being used.

When respawning, use current dimension instead of forced overworld

So only END -> OVERWORLD occurs in using portal or teleporting,
where location is not null
---
 src/main/java/net/minecraft/server/PlayerConnection.java     | 2 +-
 src/main/java/net/minecraft/server/PlayerList.java           | 3 ++-
 src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java | 2 +-
 3 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index 6a4e0e013c8f6585229eae9d9029b6089f0dbe01..27a780c06e8fa0d4e2650e7076e106ee2cac7e95 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -2148,7 +2148,7 @@ public class PlayerConnection implements PacketListenerPlayIn {
                         return;
                     }
 
-                    this.player = this.minecraftServer.getPlayerList().moveToWorld(this.player, DimensionManager.OVERWORLD, false);
+                    this.player = this.minecraftServer.getPlayerList().moveToWorld(this.player, this.player.getWorldServer().worldProvider.getDimensionManager(), false); // EMC
                     if (this.minecraftServer.isHardcore()) {
                         this.player.a(EnumGamemode.SPECTATOR);
                         ((GameRules.GameRuleBoolean) this.player.getWorldServer().getGameRules().get(GameRules.SPECTATORS_GENERATE_CHUNKS)).a(false, this.minecraftServer);
diff --git a/src/main/java/net/minecraft/server/PlayerList.java b/src/main/java/net/minecraft/server/PlayerList.java
index 17ceb0e4b30b024907e03ecdb6ab277dd0b5c620..a31d95c13a52a23b2398d685b31502a7ae2b920b 100644
--- a/src/main/java/net/minecraft/server/PlayerList.java
+++ b/src/main/java/net/minecraft/server/PlayerList.java
@@ -743,7 +743,8 @@ public abstract class PlayerList {
             }
 
             Player respawnPlayer = cserver.getPlayer(entityplayer1);
-            PlayerRespawnEvent respawnEvent = new PlayerRespawnEvent(respawnPlayer, location, isBedSpawn);
+            boolean isEndPortal = dimensionmanager.getType() == DimensionManager.OVERWORLD && entityplayer.world.worldProvider.getDimensionManager().getType() == DimensionManager.THE_END; // EMC
+            PlayerRespawnEvent respawnEvent = new PlayerRespawnEvent(respawnPlayer, location, isBedSpawn, isEndPortal); // EMC - add isLeavingEnd
             cserver.getPluginManager().callEvent(respawnEvent);
             // Spigot Start
             if (entityplayer.playerConnection.isDisconnected()) {
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 2f24742a7c337d1c441cf07d935006bc2145c4e3..ee7409f75937f22f75f9283822aede84df4d5967 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -2057,7 +2057,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         {
             if ( getHealth() <= 0 && isOnline() )
             {
-                server.getServer().getPlayerList().moveToWorld( getHandle(), net.minecraft.server.DimensionManager.OVERWORLD, false );
+                server.getServer().getPlayerList().moveToWorld( getHandle(), getHandle().world.worldProvider.getDimensionManager(), false ); // EMC
             }
         }
 
