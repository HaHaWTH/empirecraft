From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Tue, 11 Jun 2013 23:15:00 -0400
Subject: [PATCH] EntityTasks API

Allows scheduling repeating task timers on an entity level.
Avoids Bukkit system so that tasks will simply maintain themselves on entity removal.
---
 .../empireminecraft/EntityTasksHandler.java   | 61 +++++++++++++++++++
 .../empireminecraft/api/CraftEAPI_Entity.java | 15 +++++
 .../minecraft/server/level/WorldServer.java   |  3 +
 .../net/minecraft/world/entity/Entity.java    |  2 +
 .../org/bukkit/craftbukkit/CraftServer.java   |  1 +
 5 files changed, 82 insertions(+)
 create mode 100644 src/main/java/com/empireminecraft/EntityTasksHandler.java

diff --git a/src/main/java/com/empireminecraft/EntityTasksHandler.java b/src/main/java/com/empireminecraft/EntityTasksHandler.java
new file mode 100644
index 0000000000000000000000000000000000000000..71c4b3170e2c38fe38adeff3633a04ae0348e6f8
--- /dev/null
+++ b/src/main/java/com/empireminecraft/EntityTasksHandler.java
@@ -0,0 +1,61 @@
+package com.empireminecraft;
+
+import com.empireminecraft.api.EntityTask;
+import net.minecraft.server.MinecraftServer;
+import net.minecraft.server.level.PlayerChunk;
+import net.minecraft.server.level.WorldServer;
+import net.minecraft.world.entity.Entity;
+import net.minecraft.world.level.chunk.Chunk;
+
+import java.util.ArrayList;
+import java.util.Collection;
+import java.util.Iterator;
+import java.util.List;
+
+public final class EntityTasksHandler {
+
+    private EntityTasksHandler() {}
+
+    public static void tickHandler(Entity entity) {
+        if (entity.entityTasks.isEmpty()) {
+            return;
+        }
+        List<EntityTask> tasksToRun = new ArrayList<>();
+        final Iterator<EntityTask> it = entity.entityTasks.iterator();
+        while (it.hasNext()) {
+            EntityTask task = it.next();
+            if (!task.isValid()) {
+                it.remove();
+                continue;
+            }
+            if (task.isReady()) {
+                tasksToRun.add(task);
+            }
+        }
+
+        tasksToRun.forEach(EntityTask::tick);
+    }
+
+    public static void reload() {
+        for (WorldServer world : MinecraftServer.getServer().getWorlds()) {
+            clearTasks(world.getChunkProvider().playerChunkMap.visibleChunks.values());
+            clearTasks(world.getChunkProvider().playerChunkMap.updatingChunks.values());
+        }
+    }
+
+    private static void clearTasks(Collection<PlayerChunk> playerChunks) {
+        for (PlayerChunk playerChunk : playerChunks) {
+            Chunk chunk = playerChunk.getChunk();
+            if (chunk == null) {
+                continue;
+            }
+            for (List<Entity> entitySlice : chunk.entitySlices) {
+                for (Entity entity : entitySlice) {
+                    entity.entityTasks.clear();
+                }
+            }
+        }
+    }
+
+    public static class TaskList extends ArrayList<EntityTask> {}
+}
diff --git a/src/main/java/com/empireminecraft/api/CraftEAPI_Entity.java b/src/main/java/com/empireminecraft/api/CraftEAPI_Entity.java
index e7bb9003da73c8200e1b0bb8d0fadb9009a9f253..fb4ebf8e637ff0b2fb878166c310f82b0bfb3e6f 100644
--- a/src/main/java/com/empireminecraft/api/CraftEAPI_Entity.java
+++ b/src/main/java/com/empireminecraft/api/CraftEAPI_Entity.java
@@ -23,5 +23,20 @@
 
 package com.empireminecraft.api;
 
+import com.empireminecraft.EntityTasksHandler;
+import org.bukkit.craftbukkit.entity.CraftEntity;
+import org.bukkit.entity.Entity;
+
 public class CraftEAPI_Entity implements EAPI_Entity {
+
+    public <T extends Entity> EntityTask<T> scheduleTask(T entity, int interval, EntityTask<T> task) {
+        final EntityTasksHandler.TaskList entityTasks = ((CraftEntity) entity).getHandle().entityTasks;
+        entityTasks.add(task);
+        task.init(entity, interval);
+        return task;
+    }
+
+    public void cancelTasks(Entity entity) {
+        ((CraftEntity) entity).getHandle().entityTasks.clear();
+    }
 }
diff --git a/src/main/java/net/minecraft/server/level/WorldServer.java b/src/main/java/net/minecraft/server/level/WorldServer.java
index c3db36bd4b000106c931458071ebdf738c4e0318..589447349afc44f4c3e3c3fd4945fa04aa858556 100644
--- a/src/main/java/net/minecraft/server/level/WorldServer.java
+++ b/src/main/java/net/minecraft/server/level/WorldServer.java
@@ -68,6 +68,7 @@ import net.minecraft.network.protocol.game.PacketPlayOutWorldEvent;
 import net.minecraft.network.protocol.game.PacketPlayOutWorldParticles;
 import net.minecraft.resources.MinecraftKey;
 import net.minecraft.resources.ResourceKey;
+import com.empireminecraft.EntityTasksHandler;
 import net.minecraft.server.MCUtil;
 import net.minecraft.server.MinecraftServer;
 import net.minecraft.server.ScoreboardServer;
@@ -949,6 +950,7 @@ public class WorldServer extends World implements GeneratorAccessSeed {
             entity.lastPitch = entity.pitch;
             if (entity.inChunk) {
                 ++entity.ticksLived;
+                EntityTasksHandler.tickHandler(entity); // EMC
                 GameProfilerFiller gameprofilerfiller = this.getMethodProfiler();
 
                 gameprofilerfiller.a(() -> {
@@ -992,6 +994,7 @@ public class WorldServer extends World implements GeneratorAccessSeed {
                 entity1.lastPitch = entity1.pitch;
                 if (entity1.inChunk) {
                     ++entity1.ticksLived;
+                    EntityTasksHandler.tickHandler(entity1); // EMC
                     GameProfilerFiller gameprofilerfiller = this.getMethodProfiler();
 
                     gameprofilerfiller.a(() -> {
diff --git a/src/main/java/net/minecraft/world/entity/Entity.java b/src/main/java/net/minecraft/world/entity/Entity.java
index 8fac406de29f1f496d8b98cbe31d9c77ae2b8ba4..82106d7a4da988bb4b8c41808aa58931636097e4 100644
--- a/src/main/java/net/minecraft/world/entity/Entity.java
+++ b/src/main/java/net/minecraft/world/entity/Entity.java
@@ -46,6 +46,7 @@ import net.minecraft.network.syncher.DataWatcherObject;
 import net.minecraft.network.syncher.DataWatcherRegistry;
 import net.minecraft.resources.MinecraftKey;
 import net.minecraft.resources.ResourceKey;
+import com.empireminecraft.EntityTasksHandler;
 import net.minecraft.server.MCUtil;
 import com.empireminecraft.MetaApiAccessor;
 import net.minecraft.server.MinecraftServer;
@@ -147,6 +148,7 @@ public abstract class Entity implements INamableTileEntity, ICommandListener, ne
 
     // CraftBukkit start
     public com.empireminecraft.api.meta.PersistentMetaMap metaMap = null; // EMC
+    public EntityTasksHandler.TaskList entityTasks = new EntityTasksHandler.TaskList(); // EMC
     private static final int CURRENT_LEVEL = 2;
     public boolean preserveMotion = true; // Paper - keep initial motion on first setPositionRotation
     static boolean isLevelAtLeast(NBTTagCompound tag, int level) {
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index 6cd56a8f98909886beb0ea37a81f0ba3ce435fef..6805f9d171cf3202d3d3511cb4cc9821f4be1b11 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -963,6 +963,7 @@ public final class CraftServer implements Server {
         }
         // EMC start
         com.empireminecraft.MetaApiAccessor.reload();
+        com.empireminecraft.EntityTasksHandler.reload();
         // EMC end
         loadPlugins();
         enablePlugins(PluginLoadOrder.STARTUP);
