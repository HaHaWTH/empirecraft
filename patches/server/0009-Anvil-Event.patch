From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Mon, 31 Dec 2012 01:25:46 -0500
Subject: [PATCH] Anvil Event

Fire an event for anvil usage, remove cap from server, send level to client
---
 .../world/inventory/ContainerAnvil.java          | 16 ++++++++++++++++
 .../world/inventory/ContainerProperty.java       |  2 ++
 2 files changed, 18 insertions(+)

diff --git a/src/main/java/net/minecraft/world/inventory/ContainerAnvil.java b/src/main/java/net/minecraft/world/inventory/ContainerAnvil.java
index ae5674ae9c539720a657838a640050cd3b4dc5b5..3d34978c9549c43946f7ef1da13c43e075b8c19c 100644
--- a/src/main/java/net/minecraft/world/inventory/ContainerAnvil.java
+++ b/src/main/java/net/minecraft/world/inventory/ContainerAnvil.java
@@ -20,6 +20,10 @@ import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
 
 // CraftBukkit start
+import com.empireminecraft.customevents.AnvilEvent; // EMC
+import org.bukkit.Bukkit; // EMC
+import org.bukkit.entity.Player; // EMC
+import org.bukkit.craftbukkit.inventory.CraftItemStack; // EMC
 import org.bukkit.craftbukkit.inventory.CraftInventoryView;
 // CraftBukkit end
 
@@ -269,6 +273,18 @@ public class ContainerAnvil extends ContainerAnvilAbstract {
             if (this.levelCost.get() >= maximumRepairCost && !this.player.abilities.canInstantlyBuild) { // CraftBukkit
                 itemstack1 = ItemStack.b;
             }
+            // EMC start
+            final int origCost = this.levelCost.get();
+            AnvilEvent event = new AnvilEvent((Player) player.getBukkitEntity(), CraftItemStack.asBukkitCopy(itemstack), CraftItemStack.asBukkitCopy(itemstack2), CraftItemStack.asBukkitCopy(itemstack1), this.levelCost.get());
+            Bukkit.getPluginManager().callEvent(event);
+            if (event.isCancelled()) {
+                itemstack1 = ItemStack.NULL_ITEM;
+            } else {
+                itemstack1 = CraftItemStack.asNMSCopy(event.getResult());
+                this.levelCost.set(event.getCost());
+                this.levelCost.forceUpdate = origCost != event.getCost();
+            }
+            // EMC end
 
             if (!itemstack1.isEmpty()) {
                 int k2 = itemstack1.getRepairCost();
diff --git a/src/main/java/net/minecraft/world/inventory/ContainerProperty.java b/src/main/java/net/minecraft/world/inventory/ContainerProperty.java
index b9c82e68a811c2ef6bf2d5ce3ae9f858bcb263d5..5e5e6fa711b87059df8c451511cb3d6fa0ef5a38 100644
--- a/src/main/java/net/minecraft/world/inventory/ContainerProperty.java
+++ b/src/main/java/net/minecraft/world/inventory/ContainerProperty.java
@@ -3,6 +3,7 @@ package net.minecraft.world.inventory;
 public abstract class ContainerProperty {
 
     private int a;
+    public boolean forceUpdate = false; // EMC
 
     public ContainerProperty() {}
 
@@ -55,6 +56,7 @@ public abstract class ContainerProperty {
     public abstract void set(int i);
 
     public boolean checkAndClearUpdateFlag() { return c(); } public boolean c() { // Paper - OBFHELPER
+        if (this.forceUpdate) { return true; } // EMC
         int i = this.get();
         boolean flag = i != this.a;
 
