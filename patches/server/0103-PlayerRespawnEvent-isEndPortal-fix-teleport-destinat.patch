From 45aa53d7cb201ac9ea4d83d24301bb6c71e2770e Mon Sep 17 00:00:00 2001
From: chickeneer <emcchickeneer@gmail.com>
Date: Tue, 17 Mar 2020 12:25:11 -0500
Subject: [PATCH] PlayerRespawnEvent#isEndPortal / fix teleport destination for
 end respawn

Ability to detect if it is the end portal being used.

When respawning, use current dimension instead of forced overworld

So only END -> OVERWORLD occurs in using portal or teleporting,
where location is not null
---
 src/main/java/net/minecraft/server/PlayerConnection.java     | 2 +-
 src/main/java/net/minecraft/server/PlayerList.java           | 3 ++-
 src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java | 2 +-
 3 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index 2b982d4340..5a78cd1211 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -2108,7 +2108,7 @@ public class PlayerConnection implements PacketListenerPlayIn {
                         return;
                     }
 
-                    this.player = this.minecraftServer.getPlayerList().moveToWorld(this.player, DimensionManager.OVERWORLD, false);
+                    this.player = this.minecraftServer.getPlayerList().moveToWorld(this.player, this.player.getWorldServer().worldProvider.getDimensionManager(), false); // EMC
                     if (this.minecraftServer.isHardcore()) {
                         this.player.a(EnumGamemode.SPECTATOR);
                         ((GameRules.GameRuleBoolean) this.player.getWorldServer().getGameRules().get(GameRules.SPECTATORS_GENERATE_CHUNKS)).a(false, this.minecraftServer);
diff --git a/src/main/java/net/minecraft/server/PlayerList.java b/src/main/java/net/minecraft/server/PlayerList.java
index a67aed68ef..d2f78db610 100644
--- a/src/main/java/net/minecraft/server/PlayerList.java
+++ b/src/main/java/net/minecraft/server/PlayerList.java
@@ -737,7 +737,8 @@ public abstract class PlayerList {
             }
 
             Player respawnPlayer = cserver.getPlayer(entityplayer1);
-            PlayerRespawnEvent respawnEvent = new PlayerRespawnEvent(respawnPlayer, location, isBedSpawn);
+            boolean isEndPortal = dimensionmanager.getType() == DimensionManager.OVERWORLD && entityplayer.world.worldProvider.getDimensionManager().getType() == DimensionManager.THE_END; // EMC
+            PlayerRespawnEvent respawnEvent = new PlayerRespawnEvent(respawnPlayer, location, isBedSpawn, isEndPortal); // EMC - add isLeavingEnd
             cserver.getPluginManager().callEvent(respawnEvent);
             // Spigot Start
             if (entityplayer.playerConnection.isDisconnected()) {
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 87866ab752..ef5a9f22c7 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -2050,7 +2050,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         {
             if ( getHealth() <= 0 && isOnline() )
             {
-                server.getServer().getPlayerList().moveToWorld( getHandle(), net.minecraft.server.DimensionManager.OVERWORLD, false );
+                server.getServer().getPlayerList().moveToWorld( getHandle(), getHandle().world.worldProvider.getDimensionManager(), false ); // EMC
             }
         }
 
-- 
2.26.2

