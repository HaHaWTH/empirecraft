From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Fri, 15 May 2015 21:21:19 -0400
Subject: [PATCH] Remove "Copy of" from Written Books

---
 .../net/minecraft/world/item/ItemStack.java   |   1 +
 .../world/item/crafting/RecipeBookClone.java  | 105 ++++++++++++++++++
 2 files changed, 106 insertions(+)
 create mode 100644 src/main/java/net/minecraft/world/item/crafting/RecipeBookClone.java

diff --git a/src/main/java/net/minecraft/world/item/ItemStack.java b/src/main/java/net/minecraft/world/item/ItemStack.java
index e2570c74c2574eea5ea471ccfa70ea034ee6d53e..8d832b717bf43dae36e06e46a1c562e2f4a860ec 100644
--- a/src/main/java/net/minecraft/world/item/ItemStack.java
+++ b/src/main/java/net/minecraft/world/item/ItemStack.java
@@ -222,6 +222,7 @@ public final class ItemStack {
             this.tag = (NBTTagCompound) nbttagcompound.getCompound("tag").clone();
             processEnchantOrder(this.tag); // Paper
             processText(); // Paper
+            if (item == Items.WRITTEN_BOOK && tag.hasKey("generation")) tag.remove("generation"); // EMC
             this.getItem().b(this.tag);
             // CraftBukkit end
         }
diff --git a/src/main/java/net/minecraft/world/item/crafting/RecipeBookClone.java b/src/main/java/net/minecraft/world/item/crafting/RecipeBookClone.java
new file mode 100644
index 0000000000000000000000000000000000000000..85e72e6462f5d36691d9721cc0ea9c2515bf3c25
--- /dev/null
+++ b/src/main/java/net/minecraft/world/item/crafting/RecipeBookClone.java
@@ -0,0 +1,105 @@
+package net.minecraft.world.item.crafting;
+
+import net.minecraft.core.NonNullList;
+import net.minecraft.nbt.NBTTagCompound;
+import net.minecraft.resources.MinecraftKey;
+import net.minecraft.world.inventory.InventoryCrafting;
+import net.minecraft.world.item.ItemStack;
+import net.minecraft.world.item.ItemWrittenBook;
+import net.minecraft.world.item.Items;
+import net.minecraft.world.level.World;
+
+public class RecipeBookClone extends IRecipeComplex {
+
+    public RecipeBookClone(MinecraftKey minecraftkey) {
+        super(minecraftkey);
+    }
+
+    public boolean a(InventoryCrafting inventorycrafting, World world) {
+        int i = 0;
+        ItemStack itemstack = ItemStack.b;
+
+        for (int j = 0; j < inventorycrafting.getSize(); ++j) {
+            ItemStack itemstack1 = inventorycrafting.getItem(j);
+
+            if (!itemstack1.isEmpty()) {
+                if (itemstack1.getItem() == Items.WRITTEN_BOOK) {
+                    if (!itemstack.isEmpty()) {
+                        return false;
+                    }
+
+                    itemstack = itemstack1;
+                } else {
+                    if (itemstack1.getItem() != Items.WRITABLE_BOOK) {
+                        return false;
+                    }
+
+                    ++i;
+                }
+            }
+        }
+
+        return !itemstack.isEmpty() && itemstack.hasTag() && i > 0;
+    }
+
+    public ItemStack a(InventoryCrafting inventorycrafting) {
+        int i = 0;
+        ItemStack itemstack = ItemStack.b;
+
+        for (int j = 0; j < inventorycrafting.getSize(); ++j) {
+            ItemStack itemstack1 = inventorycrafting.getItem(j);
+
+            if (!itemstack1.isEmpty()) {
+                if (itemstack1.getItem() == Items.WRITTEN_BOOK) {
+                    if (!itemstack.isEmpty()) {
+                        return ItemStack.b;
+                    }
+
+                    itemstack = itemstack1;
+                } else {
+                    if (itemstack1.getItem() != Items.WRITABLE_BOOK) {
+                        return ItemStack.b;
+                    }
+
+                    ++i;
+                }
+            }
+        }
+
+        if (!itemstack.isEmpty() && itemstack.hasTag() && i >= 1 && ItemWrittenBook.d(itemstack) < 2) {
+            ItemStack itemstack2 = new ItemStack(Items.WRITTEN_BOOK, i);
+            NBTTagCompound nbttagcompound = itemstack.getTag().clone();
+
+            //nbttagcompound.setInt("generation", ItemWrittenBook.d(itemstack) + 1); // EMC
+            itemstack2.setTag(nbttagcompound);
+            return itemstack2;
+        } else {
+            return ItemStack.b;
+        }
+    }
+
+    public NonNullList<ItemStack> b(InventoryCrafting inventorycrafting) {
+        NonNullList<ItemStack> nonnulllist = NonNullList.a(inventorycrafting.getSize(), ItemStack.b);
+
+        for (int i = 0; i < nonnulllist.size(); ++i) {
+            ItemStack itemstack = inventorycrafting.getItem(i);
+
+            if (itemstack.getItem().p()) {
+                nonnulllist.set(i, new ItemStack(itemstack.getItem().getCraftingRemainingItem()));
+            } else if (itemstack.getItem() instanceof ItemWrittenBook) {
+                ItemStack itemstack1 = itemstack.cloneItemStack();
+
+                itemstack1.setCount(1);
+                nonnulllist.set(i, itemstack1);
+                break;
+            }
+        }
+
+        return nonnulllist;
+    }
+
+    @Override
+    public RecipeSerializer<?> getRecipeSerializer() {
+        return RecipeSerializer.d;
+    }
+}
