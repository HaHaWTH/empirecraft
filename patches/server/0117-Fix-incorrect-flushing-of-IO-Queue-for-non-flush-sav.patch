From cea0e5a4bd5ddbd1e11c48c393b72abe067b1eea Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Fri, 27 Mar 2020 17:54:28 -0400
Subject: [PATCH] Fix incorrect flushing of IO Queue for non flush saves

---
 src/main/java/net/minecraft/server/PlayerChunkMap.java | 4 +---
 1 file changed, 1 insertion(+), 3 deletions(-)

diff --git a/src/main/java/net/minecraft/server/PlayerChunkMap.java b/src/main/java/net/minecraft/server/PlayerChunkMap.java
index da92f91110..f9e843288a 100644
--- a/src/main/java/net/minecraft/server/PlayerChunkMap.java
+++ b/src/main/java/net/minecraft/server/PlayerChunkMap.java
@@ -435,8 +435,7 @@ public class PlayerChunkMap extends IChunkLoader implements PlayerChunk.d {
             this.b(() -> {
                 return true;
             });
-            this.world.asyncChunkTaskManager.flush(); // Paper - flush to preserve behavior compat with pre-async behaviour
-//            this.i(); // Paper - nuke IOWorker
+            this.world.asyncChunkTaskManager.flush(); // Paper - flag = flush and block until saved to disk for /save-all flush and shutdown
             PlayerChunkMap.LOGGER.info("ThreadedAnvilChunkStorage ({}): All chunks are saved", this.w.getName());
         } else {
             this.visibleChunks.values().stream().filter(PlayerChunk::hasBeenLoaded).forEach((playerchunk) -> {
@@ -448,7 +447,6 @@ public class PlayerChunkMap extends IChunkLoader implements PlayerChunk.d {
                 }
 
             });
-            com.destroystokyo.paper.io.PaperFileIOThread.Holder.INSTANCE.flush(); // Paper - flush to preserve behavior compat with pre-async behaviour
         }
 
     }
-- 
2.25.1

