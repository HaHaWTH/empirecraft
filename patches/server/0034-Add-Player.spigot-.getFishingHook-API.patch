From 6892acdf7fc409d4f76a181c1633a2682daf03d3 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 14 Aug 2014 18:23:33 -0400
Subject: [PATCH] Add Player.spigot().getFishingHook() API

---
 src/main/java/net/minecraft/server/EntityFishingHook.java | 5 +++--
 src/main/java/net/minecraft/server/ItemFishingRod.java    | 3 ++-
 .../java/org/bukkit/craftbukkit/entity/CraftPlayer.java   | 8 ++++++++
 3 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/src/main/java/net/minecraft/server/EntityFishingHook.java b/src/main/java/net/minecraft/server/EntityFishingHook.java
index 8d48154e5..f9ce94fe5 100644
--- a/src/main/java/net/minecraft/server/EntityFishingHook.java
+++ b/src/main/java/net/minecraft/server/EntityFishingHook.java
@@ -433,8 +433,9 @@ public class EntityFishingHook extends Entity {
             }
             // CraftBukkit end
 
-            this.die();
-            return i;
+            // this.die(); // Spigot - move to after damage event
+            // this.owner.hookedFish = null; // Spigot - moved to after damage event
+            return i == 0 ? -1 : i; // Spigot - use -1 to represent "0 but kill entity"
         } else {
             return 0;
         }
diff --git a/src/main/java/net/minecraft/server/ItemFishingRod.java b/src/main/java/net/minecraft/server/ItemFishingRod.java
index eb90edfbd..b8a2c02c1 100644
--- a/src/main/java/net/minecraft/server/ItemFishingRod.java
+++ b/src/main/java/net/minecraft/server/ItemFishingRod.java
@@ -34,9 +34,10 @@ public class ItemFishingRod extends Item {
         if (entityhuman.hookedFish != null) {
             if (!world.isClientSide) {
                 i = entityhuman.hookedFish.b(itemstack);
-                itemstack.damage(i, entityhuman, (entityhuman1) -> {
+                itemstack.damage(Math.max(0, i), entityhuman, (entityhuman1) -> { // Spigot - Ignore -1 return using Math.max
                     entityhuman1.d(enumhand);
                 });
+                if (i != 0) { entityhuman.hookedFish.die(); entityhuman.hookedFish = null; } // Spigot - removed from e(), and 0 = cancelled
             }
 
             world.playSound((EntityHuman) null, entityhuman.locX(), entityhuman.locY(), entityhuman.locZ(), SoundEffects.ENTITY_FISHING_BOBBER_RETRIEVE, SoundCategory.NEUTRAL, 1.0F, 0.4F / (ItemFishingRod.i.nextFloat() * 0.4F + 0.8F));
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 712056cad..104326135 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -1981,6 +1981,14 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
     private final Player.Spigot spigot = new Player.Spigot()
     {
 
+        @Override
+        public org.bukkit.entity.Fish getFishingHook() {
+            if (getHandle().hookedFish == null) {
+                return null;
+            }
+            return (org.bukkit.entity.Fish) getHandle().hookedFish.getBukkitEntity();
+        }
+
         @Override
         public InetSocketAddress getRawAddress()
         {
-- 
2.24.1

