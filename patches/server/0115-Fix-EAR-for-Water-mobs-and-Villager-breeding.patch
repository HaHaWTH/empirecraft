From efa97a725661b3a945f0542bb4ce62e78d7c89ad Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 26 Mar 2020 02:58:11 -0400
Subject: [PATCH] Fix EAR for Water mobs and Villager breeding

---
 src/main/java/org/spigotmc/ActivationRange.java | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/src/main/java/org/spigotmc/ActivationRange.java b/src/main/java/org/spigotmc/ActivationRange.java
index 8a65ccee32..215c65802a 100644
--- a/src/main/java/org/spigotmc/ActivationRange.java
+++ b/src/main/java/org/spigotmc/ActivationRange.java
@@ -3,6 +3,7 @@ package org.spigotmc;
 import java.util.Collection;
 import java.util.List;
 import net.minecraft.server.AxisAlignedBB;
+import net.minecraft.server.BehaviorController;
 import net.minecraft.server.Chunk;
 import net.minecraft.server.Entity;
 import net.minecraft.server.EntityAmbient;
@@ -30,6 +31,7 @@ import net.minecraft.server.EntityThrownTrident;
 import net.minecraft.server.EntityVillager;
 import net.minecraft.server.EntityWither;
 import net.minecraft.server.MathHelper;
+import net.minecraft.server.MemoryModuleType;
 import net.minecraft.server.MinecraftServer;
 import net.minecraft.server.World;
 import co.aikar.timings.MinecraftTimings;
@@ -202,7 +204,7 @@ public class ActivationRange
     public static boolean checkEntityImmunities(Entity entity)
     {
         // quick checks.
-        if ( entity.inWater || entity.fireTicks > 0 )
+        if ( (entity.activationType != ActivationType.WATER && entity.inWater) || entity.fireTicks > 0 ) // Paper
         {
             return true;
         }
@@ -228,9 +230,14 @@ public class ActivationRange
             {
                 return true;
             }
+            // Paper start
             if ( entity instanceof EntityVillager && ( (EntityVillager) entity ).canBreed() )
             {
-                return true;
+                BehaviorController<EntityVillager> behaviorController = ((EntityVillager) entity).getBehaviorController();
+                if (behaviorController.hasMemory(MemoryModuleType.BREED_TARGET)) {
+                    return true;
+                }
+                // Paper end
             }
             // Paper start
             if ( entity instanceof EntityLlama && ( (EntityLlama ) entity ).inCaravan() )
-- 
2.25.1

