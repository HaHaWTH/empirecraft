From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: chickeneer <emcchickeneer@gmail.com>
Date: Sat, 6 Jun 2020 21:17:28 -0500
Subject: [PATCH] Raid total waves API

---
 .../net/minecraft/world/entity/raid/PersistentRaid.java   | 2 +-
 src/main/java/net/minecraft/world/entity/raid/Raid.java   | 4 +++-
 src/main/java/org/bukkit/craftbukkit/CraftRaid.java       | 8 +++++++-
 .../org/bukkit/craftbukkit/event/CraftEventFactory.java   | 2 +-
 4 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/src/main/java/net/minecraft/world/entity/raid/PersistentRaid.java b/src/main/java/net/minecraft/world/entity/raid/PersistentRaid.java
index c939ca087af4588e14669a2d53d7c116dcb59f16..8ca1a21abe168cdcd38253f57d28a6136ba7d746 100644
--- a/src/main/java/net/minecraft/world/entity/raid/PersistentRaid.java
+++ b/src/main/java/net/minecraft/world/entity/raid/PersistentRaid.java
@@ -132,7 +132,7 @@ public class PersistentRaid extends PersistentBase {
                         entityplayer.removeEffect(MobEffects.BAD_OMEN);
                         return null;
                     }
-
+                    raid.firstTrigger = false; // EMC
                     if (!this.raids.containsKey(raid.getId())) {
                         this.raids.put(raid.getId(), raid);
                     }
diff --git a/src/main/java/net/minecraft/world/entity/raid/Raid.java b/src/main/java/net/minecraft/world/entity/raid/Raid.java
index 457cbdab3fa96fdf7fad1b0206bec9c0aa7847d8..5643bf9441509a96d078e8b073b8f20c8c4c444e 100644
--- a/src/main/java/net/minecraft/world/entity/raid/Raid.java
+++ b/src/main/java/net/minecraft/world/entity/raid/Raid.java
@@ -82,7 +82,8 @@ public class Raid {
     private int postRaidTicks;
     private int preRaidTicks;
     private final Random random;
-    public final int numGroups;
+    public int numGroups; // EMC
+    public boolean firstTrigger = false; // EMC
     private Raid.Status status;
     private int x;
     private Optional<BlockPosition> y;
@@ -99,6 +100,7 @@ public class Raid {
         this.center = blockposition;
         this.numGroups = this.a(worldserver.getDifficulty());
         this.status = Raid.Status.ONGOING;
+        this.firstTrigger = true; // EMC
     }
 
     public Raid(WorldServer worldserver, NBTTagCompound nbttagcompound) {
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftRaid.java b/src/main/java/org/bukkit/craftbukkit/CraftRaid.java
index aa405523dd2bff8b7948178d8be995cd3b8734da..29c748163fca8400ac3ca45a80b61965410a1865 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftRaid.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftRaid.java
@@ -79,7 +79,13 @@ public final class CraftRaid implements Raid {
     public int getTotalWaves() {
         return handle.numGroups;
     }
-
+    // EMC start
+    @Override
+    public void setTotalWaves(int total) {
+        Preconditions.checkArgument(1 <= total && total <= 7, "Total waves out of bounds 1 <= %s <= 7", total);
+        handle.numGroups = total;
+    }
+    // EMC end
     @Override
     public float getTotalHealth() {
         return handle.sumMobHealth();
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index 2bf8116414cbf8d7d01efe7b463347a22faad5ac..328277c238f96cb5b4c238bc66b4659a3ac3a1e6 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -1759,7 +1759,7 @@ public class CraftEventFactory {
      * Raid events
      */
     public static boolean callRaidTriggerEvent(Raid raid, EntityPlayer player) {
-        RaidTriggerEvent event = new RaidTriggerEvent(new CraftRaid(raid), raid.getWorld().getWorld(), player.getBukkitEntity());
+        RaidTriggerEvent event = new RaidTriggerEvent(new CraftRaid(raid), raid.getWorld().getWorld(), player.getBukkitEntity(), raid.firstTrigger); // EMC
         Bukkit.getPluginManager().callEvent(event);
         return !event.isCancelled();
     }
