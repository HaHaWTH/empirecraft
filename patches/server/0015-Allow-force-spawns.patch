From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Fri, 26 Jul 2013 22:19:29 -0400
Subject: [PATCH] Allow force spawns

Pass spawn reason force to not allow plugins to block
Force some cases where plugins should not be allowed to block it.
---
 src/main/java/net/minecraft/server/WorldServer.java           | 4 ++--
 .../java/org/bukkit/craftbukkit/event/CraftEventFactory.java  | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/src/main/java/net/minecraft/server/WorldServer.java b/src/main/java/net/minecraft/server/WorldServer.java
index 17a5a23f573d98ddd0b9330a60c1330f5e4a2bab..f5abb4ff58cbe767d0d8d4aa15e803afc17f0d92 100644
--- a/src/main/java/net/minecraft/server/WorldServer.java
+++ b/src/main/java/net/minecraft/server/WorldServer.java
@@ -1099,7 +1099,7 @@ public class WorldServer extends World implements GeneratorAccessSeed {
         boolean flag = entity.attachedToPlayer;
 
         entity.attachedToPlayer = true;
-        this.addEntitySerialized(entity);
+        this.addEntitySerialized(entity, org.bukkit.event.entity.CreatureSpawnEvent.SpawnReason.FORCE); // EMC
         entity.attachedToPlayer = flag;
         this.chunkCheck(entity);
     }
@@ -1179,7 +1179,7 @@ public class WorldServer extends World implements GeneratorAccessSeed {
             // CraftBukkit end
             IChunkAccess ichunkaccess = this.getChunkAt(MathHelper.floor(entity.locX() / 16.0D), MathHelper.floor(entity.locZ() / 16.0D), ChunkStatus.FULL, true); // Paper - always load chunks for entity adds
 
-            if (!(ichunkaccess instanceof Chunk)) {
+            if (spawnReason != CreatureSpawnEvent.SpawnReason.FORCE && !(ichunkaccess instanceof Chunk)) { // EMC
                 return false;
             } else {
                 ichunkaccess.a(entity);
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index ef6a796dcfdfc42b5d6e8c8f69817d9d5f3526b9..81350a8d3d639074cd99f346d42450759241f947 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -636,7 +636,7 @@ public class CraftEventFactory {
             event = CraftEventFactory.callEntitySpawnEvent(entity);
         }
 
-        if (event != null && (event.isCancelled() || entity.dead)) {
+        if (spawnReason != SpawnReason.FORCE && event != null && (event.isCancelled() || entity.dead)) { // EMC - add != force
             Entity vehicle = entity.getVehicle();
             if (vehicle != null) {
                 vehicle.dead = true;
