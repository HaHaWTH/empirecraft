From dcdf2e5c44891cc5bd1acd96a6f5ee66f0ff1283 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 29 Nov 2012 10:48:07 -0500
Subject: [PATCH] SpawnerInitiateEvent

---
 .../net/minecraft/server/EntityHuman.java     |  1 +
 .../minecraft/server/MobSpawnerAbstract.java  | 23 ++++++++++++++++++-
 src/main/java/net/minecraft/server/World.java |  1 +
 3 files changed, 24 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/EntityHuman.java b/src/main/java/net/minecraft/server/EntityHuman.java
index 14a61f68e1..1e1aad3632 100644
--- a/src/main/java/net/minecraft/server/EntityHuman.java
+++ b/src/main/java/net/minecraft/server/EntityHuman.java
@@ -74,6 +74,7 @@ public abstract class EntityHuman extends EntityLiving {
     public EntityFishingHook hookedFish;
     // Paper start
     public boolean affectsSpawning = true;
+    static Predicate<Entity> affectsSpawningPredicate = (player) -> (player instanceof EntityHuman && ((EntityHuman) player).affectsSpawning);
     // Paper end
 
     // CraftBukkit start
diff --git a/src/main/java/net/minecraft/server/MobSpawnerAbstract.java b/src/main/java/net/minecraft/server/MobSpawnerAbstract.java
index d10196fcbd..ed9baaf82d 100644
--- a/src/main/java/net/minecraft/server/MobSpawnerAbstract.java
+++ b/src/main/java/net/minecraft/server/MobSpawnerAbstract.java
@@ -49,7 +49,28 @@ public abstract class MobSpawnerAbstract {
     private boolean h() {
         BlockPosition blockposition = this.b();
 
-        return this.a().isPlayerNearby((double) blockposition.getX() + 0.5D, (double) blockposition.getY() + 0.5D, (double) blockposition.getZ() + 0.5D, (double) this.requiredPlayerRange);
+        // Paper start - Add in SpawnerInitiateEvent
+        //return this.a().isPlayerNearby((double) blockposition.getX() + 0.5D, (double) blockposition.getY() + 0.5D, (double) blockposition.getZ() + 0.5D, (double) this.requiredPlayerRange);
+
+        final World world = this.a();
+        final int x = blockposition.getX();
+        final int y = blockposition.getY();
+        final int z = blockposition.getZ();
+        MinecraftKey mobName = this.getMobName();
+        if (mobName == null) {
+            return false;
+        }
+        EntityHuman entity = world.findNearbyPlayer((double) x + 0.5D,
+            (double) y + 0.5D,
+            (double) z + 0.5D,
+            (double) this.requiredPlayerRange, EntityHuman.affectsSpawningPredicate);
+        if (entity == null) {
+            return false;
+        }
+        org.bukkit.Location loc = new org.bukkit.Location(world.getWorld(), x, y, z);
+
+        return new com.empireminecraft.customevents.SpawnerInitiateEvent(org.bukkit.craftbukkit.util.CraftNamespacedKey.fromMinecraft(mobName), world.getWorld(), loc, entity.getBukkitEntity()).callEvent();
+        // Paper end
     }
 
     public void c() {
diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index 4fc3c2c354..fd9c4f9024 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -2565,6 +2565,7 @@ public abstract class World implements GeneratorAccess, IIBlockAccess, AutoClose
         return i;
     }
 
+    @Nullable public EntityHuman findNearbyPlayer(double d0, double d1, double d2, double d3, Predicate<Entity> predicate) { return this.a(d0, d1, d2, d3, predicate); } // Paper - OBFHELPER
     @Nullable
     public EntityHuman a(double d0, double d1, double d2, double d3, Predicate<Entity> predicate) {
         double d4 = -1.0D;
-- 
2.18.0

