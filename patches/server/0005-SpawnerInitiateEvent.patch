From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 29 Nov 2012 10:48:07 -0500
Subject: [PATCH] SpawnerInitiateEvent


diff --git a/src/main/java/net/minecraft/world/entity/player/Player.java b/src/main/java/net/minecraft/world/entity/player/Player.java
index 2c00a766130a7f682fc6c4c74321e10637ca7932..38a7ab86542c7c3c013b4e597979123a5b7545c7 100644
--- a/src/main/java/net/minecraft/world/entity/player/Player.java
+++ b/src/main/java/net/minecraft/world/entity/player/Player.java
@@ -179,6 +179,7 @@ public abstract class Player extends LivingEntity {
     public FishingHook fishing;
     // Paper start
     public boolean affectsSpawning = true;
+    public static Predicate<Entity> affectsSpawningPredicate = (player) -> (player instanceof Player && ((Player) player).affectsSpawning);
     // Paper end
 
     // CraftBukkit start
diff --git a/src/main/java/net/minecraft/world/level/BaseSpawner.java b/src/main/java/net/minecraft/world/level/BaseSpawner.java
index 03726227fdd60e9cf77213d50184abff438e01ef..3c13a7231a1792a29f0abbf6ed1d1bcabd407f05 100644
--- a/src/main/java/net/minecraft/world/level/BaseSpawner.java
+++ b/src/main/java/net/minecraft/world/level/BaseSpawner.java
@@ -20,6 +20,7 @@ import net.minecraft.world.entity.Mob;
 import net.minecraft.world.entity.MobSpawnType;
 import net.minecraft.world.entity.SpawnGroupData;
 import net.minecraft.world.entity.SpawnPlacements;
+import net.minecraft.world.entity.player.Player;
 import net.minecraft.world.phys.AABB;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
@@ -52,7 +53,25 @@ public abstract class BaseSpawner {
     }
 
     public boolean isNearPlayer(Level world, BlockPos pos) {
-        return world.isAffectsSpawningPlayerNearby((double) pos.getX() + 0.5D, (double) pos.getY() + 0.5D, (double) pos.getZ() + 0.5D, (double) this.requiredPlayerRange); // Paper
+        // Paper start - Add in SpawnerInitiateEvent
+        //return world.isAffectsSpawningPlayerNearby((double) pos.getX() + 0.5D, (double) pos.getY() + 0.5D, (double) pos.getZ() + 0.5D, (double) this.requiredPlayerRange); // Paper
+        final int x = pos.getX();
+        final int y = pos.getY();
+        final int z = pos.getZ();
+        Optional<net.minecraft.world.entity.EntityType<?>> type = net.minecraft.world.entity.EntityType.by(this.nextSpawnData.getEntityToSpawn());
+        if (type.isEmpty()) {
+            return false;
+        }
+        Player entity = world.getNearestPlayer((double) x + 0.5D, (double) y + 0.5D, (double) z + 0.5D, this.requiredPlayerRange, Player.affectsSpawningPredicate);
+        if (entity == null) {
+            return false;
+        }
+        org.bukkit.Location loc = new org.bukkit.Location(world.getWorld(), x, y, z);
+
+        return new com.empireminecraft.customevents.SpawnerInitiateEvent(
+            org.bukkit.entity.EntityType.fromName(net.minecraft.world.entity.EntityType.getKey(type.get()).getPath()),
+            world.getWorld(), loc, entity.getBukkitEntity()).callEvent();
+        // Paper end
     }
 
     public void clientTick(Level world, BlockPos pos) {
