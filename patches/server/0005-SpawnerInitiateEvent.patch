From 7db55edf32276778980364bf1c7f10e68276e5d9 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 29 Nov 2012 10:48:07 -0500
Subject: [PATCH] SpawnerInitiateEvent

---
 src/main/java/net/minecraft/server/EntityHuman.java   |  1 +
 .../java/net/minecraft/server/MobSpawnerAbstract.java | 19 ++++++++++++++++++-
 src/main/java/net/minecraft/server/World.java         |  6 ++++++
 3 files changed, 25 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/EntityHuman.java b/src/main/java/net/minecraft/server/EntityHuman.java
index 3472370550..b5c3bc68a1 100644
--- a/src/main/java/net/minecraft/server/EntityHuman.java
+++ b/src/main/java/net/minecraft/server/EntityHuman.java
@@ -65,6 +65,7 @@ public abstract class EntityHuman extends EntityLiving {
     @Nullable
     public EntityFishingHook hookedFish;
     public boolean affectsSpawning = true;
+    static com.google.common.base.Predicate<Entity> affectsSpawningPredicate = (player) -> (player instanceof EntityHuman && ((EntityHuman) player).affectsSpawning); // EMC
 
     // CraftBukkit start
     public boolean fauxSleeping;
diff --git a/src/main/java/net/minecraft/server/MobSpawnerAbstract.java b/src/main/java/net/minecraft/server/MobSpawnerAbstract.java
index 9d580ea019..a6b04884a6 100644
--- a/src/main/java/net/minecraft/server/MobSpawnerAbstract.java
+++ b/src/main/java/net/minecraft/server/MobSpawnerAbstract.java
@@ -1,6 +1,7 @@
 package net.minecraft.server;
 
 import com.google.common.collect.Lists;
+import org.bukkit.craftbukkit.util.CraftNamespacedKey;
 
 import java.util.Iterator;
 import java.util.List;
@@ -42,7 +43,23 @@ public abstract class MobSpawnerAbstract {
     private boolean h() {
         BlockPosition blockposition = this.b();
 
-        return this.a().isPlayerNearby((double) blockposition.getX() + 0.5D, (double) blockposition.getY() + 0.5D, (double) blockposition.getZ() + 0.5D, (double) this.requiredPlayerRange);
+        //return this.a().isPlayerNearby((double) blockposition.getX() + 0.5D, (double) blockposition.getY() + 0.5D, (double) blockposition.getZ() + 0.5D, (double) this.requiredPlayerRange); // Paper - affectsSpawning filter
+
+        // EMC start - Add in SpawnerInitiateEvent
+        final World world = this.a();
+        final int x = blockposition.getX();
+        final int y = blockposition.getY();
+        final int z = blockposition.getZ();
+        EntityHuman entity = world.findNearbyPlayer((double) x + 0.5D,
+            (double) y + 0.5D,
+            (double) z + 0.5D,
+            (double) this.requiredPlayerRange, EntityHuman.affectsSpawningPredicate);
+        if (entity == null) {
+            return false;
+        }
+        org.bukkit.Location loc = new org.bukkit.Location(world.getWorld(), x, y, z);
+        return new com.empireminecraft.customevents.SpawnerInitiateEvent(CraftNamespacedKey.fromMinecraft(this.getMobName()), world.getWorld(), loc, entity.getBukkitEntity()).callEvent();
+        // EMC end
     }
 
     public void c() {
diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index 9f5388ed9c..dfbfed9303 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -2855,6 +2855,12 @@ public abstract class World implements IBlockAccess {
         return this.a(d0, d1, d2, d3, predicate);
     }
 
+    // EMC start // OBF HELPER
+    @Nullable
+    public EntityHuman findNearbyPlayer(double d0, double d1, double d2, double d3, Predicate<Entity> predicate) {
+        return this.a(d0, d1, d2, d3, predicate);
+    }
+    // EMC end
     @Nullable
     public EntityHuman a(double d0, double d1, double d2, double d3, Predicate<Entity> predicate) {
         double d4 = -1.0D;
-- 
2.16.1

