From f7fe742310781eb5b15b75e932d51f59ae00b628 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 18 Dec 2014 22:48:46 -0500
Subject: [PATCH] Add BlockBreakNaturally Event

To give reliable control over all blocks dropping to world to restore custom item meta
---
 src/main/java/net/minecraft/server/Block.java                 | 3 ++-
 src/main/java/net/minecraft/server/PlayerInteractManager.java | 7 +++++--
 src/main/java/net/minecraft/server/World.java                 | 2 +-
 3 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/src/main/java/net/minecraft/server/Block.java b/src/main/java/net/minecraft/server/Block.java
index 3523109603..b43ed75288 100644
--- a/src/main/java/net/minecraft/server/Block.java
+++ b/src/main/java/net/minecraft/server/Block.java
@@ -380,9 +380,10 @@ public class Block {
             entityitem.q();
             // CraftBukkit start
             if (world.captureDrops != null) {
-                world.captureDrops.add(entityitem);
+                world.captureDrops.add(new Tuple<>(blockposition, entityitem)); // EMC
             } else {
                 world.addEntity(entityitem);
+                new com.empireminecraft.customevents.BlockBreakNaturallyEvent(MCUtil.toLocation(world, blockposition), (org.bukkit.entity.Item) entityitem.getBukkitEntity()).callEvent(); // EMC
             }
             // CraftBukkit end
         }
diff --git a/src/main/java/net/minecraft/server/PlayerInteractManager.java b/src/main/java/net/minecraft/server/PlayerInteractManager.java
index dda83700f3..8d017147b6 100644
--- a/src/main/java/net/minecraft/server/PlayerInteractManager.java
+++ b/src/main/java/net/minecraft/server/PlayerInteractManager.java
@@ -359,9 +359,12 @@ public class PlayerInteractManager {
                 world.captureDrops = new ArrayList<>();
                 boolean flag = this.c(blockposition);
                 if (event.isDropItems()) {
-                    for (EntityItem item : world.captureDrops) {
-                        world.addEntity(item);
+                    // EMC start - use tuple
+                    for (Tuple<BlockPosition, EntityItem> item : world.captureDrops) {
+                        world.addEntity(item.b());
+                        new com.empireminecraft.customevents.BlockBreakNaturallyEvent(MCUtil.toLocation(world, item.a()), (org.bukkit.entity.Item) item.b().getBukkitEntity()).callEvent();
                     }
+                    // EMC end
                 }
                 world.captureDrops = null;
                 // CraftBukkit end
diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index 28f2fbd6ce..c70d1e6590 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -132,7 +132,7 @@ public abstract class World implements IBlockAccess {
             return super.add( blockState );
         }
     };
-    public List<EntityItem> captureDrops;
+    public List<Tuple<BlockPosition, EntityItem>> captureDrops; // EMC
     public long ticksPerAnimalSpawns;
     public long ticksPerMonsterSpawns;
     public boolean populating;
-- 
2.15.0

