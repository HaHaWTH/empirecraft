From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Fri, 28 Feb 2014 22:25:04 -0500
Subject: [PATCH] Fire EntityTargetLivingEntityEvent for
 GoalNearestAttackableTarget

If cancelled, move to next in list
---
 .../java/net/minecraft/world/entity/Entity.java     |  1 +
 .../PathfinderGoalNearestAttackableTarget.java      | 13 ++++++++++++-
 2 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/world/entity/Entity.java b/src/main/java/net/minecraft/world/entity/Entity.java
index 2fd539624a039bfa759ec9e1090443093771dc19..a8fb0b3755524f787e6b487c42adb53247620106 100644
--- a/src/main/java/net/minecraft/world/entity/Entity.java
+++ b/src/main/java/net/minecraft/world/entity/Entity.java
@@ -1465,6 +1465,7 @@ public abstract class Entity implements INamableTileEntity, ICommandListener, ne
         return d3 * d3 + d4 * d4 + d5 * d5;
     }
 
+    public double distanceToSquared(Entity entity) { return h(entity); }
     public double h(Entity entity) {
         return this.e(entity.getPositionVector());
     }
diff --git a/src/main/java/net/minecraft/world/entity/ai/goal/target/PathfinderGoalNearestAttackableTarget.java b/src/main/java/net/minecraft/world/entity/ai/goal/target/PathfinderGoalNearestAttackableTarget.java
index 44f21c3f7af17e9d39777a48c6715a22fc085da6..e6aa5854ad5e6dcd7567cf587c6529e7287c5150 100644
--- a/src/main/java/net/minecraft/world/entity/ai/goal/target/PathfinderGoalNearestAttackableTarget.java
+++ b/src/main/java/net/minecraft/world/entity/ai/goal/target/PathfinderGoalNearestAttackableTarget.java
@@ -51,7 +51,18 @@ public class PathfinderGoalNearestAttackableTarget<T extends EntityLiving> exten
 
     protected void g() {
         if (this.a != EntityHuman.class && this.a != EntityPlayer.class) {
-            this.c = this.e.world.b(this.a, this.d, this.e, this.e.locX(), this.e.getHeadY(), this.e.locZ(), this.a(this.k()));
+            // EMC start
+            java.util.List<T> list = this.e.world.a(this.a, this.d, this.e, this.a(this.k()));
+            list.sort(java.util.Comparator.comparingDouble(this.e::distanceToSquared));
+            for (T entity : list) {
+                if (org.bukkit.craftbukkit.event.CraftEventFactory.callEntityTargetLivingEvent(
+                        this.e, entity,
+                        org.bukkit.event.entity.EntityTargetEvent.TargetReason.CLOSEST_PLAYER
+                ).isCancelled()) continue;
+                this.c = entity;
+                break;
+            }
+            // EMC end
         } else {
             this.c = this.e.world.a(this.d, this.e, this.e.locX(), this.e.getHeadY(), this.e.locZ());
         }
