From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 18 Dec 2014 22:48:46 -0500
Subject: [PATCH] Add BlockBreakNaturally Event

To give reliable control over all blocks dropping to world to restore custom item meta
---
 .../java/net/minecraft/server/level/WorldServer.java   |  1 +
 .../net/minecraft/world/entity/item/EntityItem.java    |  1 +
 .../java/net/minecraft/world/level/block/Block.java    |  3 +++
 .../bukkit/craftbukkit/event/CraftEventFactory.java    | 10 ++++++++++
 4 files changed, 15 insertions(+)

diff --git a/src/main/java/net/minecraft/server/level/WorldServer.java b/src/main/java/net/minecraft/server/level/WorldServer.java
index 0716e93394a6aba330916654846f3d4e27bd1828..327321b13a5e971a9cfd1bd37b0b52e80be0a2b4 100644
--- a/src/main/java/net/minecraft/server/level/WorldServer.java
+++ b/src/main/java/net/minecraft/server/level/WorldServer.java
@@ -1297,6 +1297,7 @@ public class WorldServer extends World implements GeneratorAccessSeed {
         } else {
             // Paper start - capture all item additions to the world
             if (captureDrops != null && entity instanceof EntityItem) {
+                ((EntityItem) entity).droppedPosition = new BlockPosition(entity.locX(), entity.locY(), entity.locZ()); // EMC
                 captureDrops.add((EntityItem) entity);
                 return true;
             }
diff --git a/src/main/java/net/minecraft/world/entity/item/EntityItem.java b/src/main/java/net/minecraft/world/entity/item/EntityItem.java
index d0658e84fa1f8bc00de562b749ca1be370b735a3..6c1f08141f585e4680c239c7d099b8d8d6ba9209 100644
--- a/src/main/java/net/minecraft/world/entity/item/EntityItem.java
+++ b/src/main/java/net/minecraft/world/entity/item/EntityItem.java
@@ -44,6 +44,7 @@ public class EntityItem extends Entity {
     private static final DataWatcherObject<ItemStack> ITEM = DataWatcher.a(EntityItem.class, DataWatcherRegistry.g);
     public int age;
     public boolean canDespawn = true; // EMC
+    public BlockPosition droppedPosition; // EMC
     public int pickupDelay;
     private int f;
     private UUID thrower;
diff --git a/src/main/java/net/minecraft/world/level/block/Block.java b/src/main/java/net/minecraft/world/level/block/Block.java
index 596b4597313b87296d39027b13555b5ad1cba9e6..9d583f2413c8dd0f70b6e3d3f43f91aa084a370f 100644
--- a/src/main/java/net/minecraft/world/level/block/Block.java
+++ b/src/main/java/net/minecraft/world/level/block/Block.java
@@ -15,6 +15,7 @@ import net.minecraft.core.EnumDirection;
 import net.minecraft.core.IRegistry;
 import net.minecraft.core.NonNullList;
 import net.minecraft.core.RegistryBlockID;
+import net.minecraft.server.MCUtil;
 import net.minecraft.server.level.WorldServer;
 import net.minecraft.stats.StatisticList;
 import net.minecraft.tags.Tag;
@@ -273,8 +274,10 @@ public class Block extends BlockBase implements IMaterial {
             entityitem.defaultPickupDelay();
             // CraftBukkit start
             if (world.captureDrops != null) {
+                entityitem.droppedPosition = blockposition.immutableCopy(); // EMC
                 world.captureDrops.add(entityitem);
             } else {
+                new com.empireminecraft.customevents.BlockBreakNaturallyEvent(MCUtil.toLocation(world, blockposition), (org.bukkit.entity.Item) entityitem.getBukkitEntity()).callEvent(); // EMC
                 world.addEntity(entityitem);
             }
             // CraftBukkit end
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index 3506897a86f2ec91ba2ba921dad67f24665535b3..d7b9da396ffdbc4a62ecda21a985b62802115792 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -407,6 +407,16 @@ public class CraftEventFactory {
         Bukkit.getPluginManager().callEvent(event);
 
         if (!event.isCancelled()) {
+            // EMC start
+            com.google.common.collect.Multimap<org.bukkit.Location, org.bukkit.entity.Item> drops = com.google.common.collect.ArrayListMultimap.create();
+            for (Item item : list) {
+                EntityItem entityItem = (EntityItem) ((org.bukkit.craftbukkit.entity.CraftItem) item).getHandle();
+                drops.put(net.minecraft.server.MCUtil.toLocation(entityItem.world, entityItem.droppedPosition), (org.bukkit.entity.Item) entityItem.getBukkitEntity());
+            }
+            for (org.bukkit.Location location : drops.keySet()) {
+                new com.empireminecraft.customevents.BlockBreakNaturallyEvent(location, drops.get(location)).callEvent();
+            }
+            // EMC end
             // Paper start
             for (Item bukkit : list) {
                 if (!bukkit.isValid()) {
