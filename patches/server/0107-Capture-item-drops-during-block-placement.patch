From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: chickeneer <emcchickeneer@gmail.com>
Date: Thu, 29 Jul 2021 02:07:15 -0500
Subject: [PATCH] Capture item drops during block placement


diff --git a/src/main/java/net/minecraft/world/item/ItemStack.java b/src/main/java/net/minecraft/world/item/ItemStack.java
index eaaa95b8822dc59eda258eaed4dc4130e1833232..ad318ff0351f7423da6f1874be0cb9ad5a28427f 100644
--- a/src/main/java/net/minecraft/world/item/ItemStack.java
+++ b/src/main/java/net/minecraft/world/item/ItemStack.java
@@ -341,6 +341,11 @@ public final class ItemStack {
                     world.captureTreeGeneration = true;
                 }
             }
+            // Paper start
+            world.captureDrops = new java.util.ArrayList<>();
+            org.bukkit.block.Block bblock = CraftBlock.at(world, blockposition);
+            org.bukkit.block.BlockState state = bblock.getState();
+            // Paper end
             Item item = this.getItem();
             InteractionResult enuminteractionresult = item.useOn(itemactioncontext);
             CompoundTag newData = this.getTagClone();
@@ -348,6 +353,10 @@ public final class ItemStack {
             this.setCount(oldCount);
             this.setTagClone(oldData);
             world.captureBlockStates = false;
+            // Paper start
+            List<ItemEntity> itemsToDrop = world.captureDrops;
+            world.captureDrops = null;
+            // Paper end
             if (enuminteractionresult.consumesAction() && world.captureTreeGeneration && world.capturedBlockStates.size() > 0) {
                 world.captureTreeGeneration = false;
                 Location location = new Location(world.getWorld(), blockposition.getX(), blockposition.getY(), blockposition.getZ());
@@ -367,6 +376,7 @@ public final class ItemStack {
                 org.bukkit.Bukkit.getPluginManager().callEvent(fertilizeEvent);
 
                 if (!fertilizeEvent.isCancelled()) {
+                    org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockDropItemEvent(bblock, state, (ServerPlayer) entityhuman, itemsToDrop); // Paper
                     // Change the stack to its new contents if it hasn't been tampered with.
                     if (this.getCount() == oldCount && Objects.equals(this.tag, oldData)) {
                         this.setTag(newData);
@@ -409,6 +419,7 @@ public final class ItemStack {
                         ((ServerPlayer) entityhuman).connection.send(new ClientboundBlockUpdatePacket(world, placedPos.relative(dir)));
                     }
                 } else {
+                    org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockDropItemEvent(bblock, state, (ServerPlayer) entityhuman, itemsToDrop); // Paper
                     // Change the stack to its new contents if it hasn't been tampered with.
                     if (this.getCount() == oldCount && Objects.equals(this.tag, oldData)) {
                         this.setTag(newData);
