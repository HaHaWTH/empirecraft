From fd2666f4247caba145c205078f01b73d04103c07 Mon Sep 17 00:00:00 2001
From: chickeneer <emcchickeneer@gmail.com>
Date: Wed, 22 Jan 2020 01:22:34 -0600
Subject: [PATCH] Do not save entities with player passengers

---
 .../net/minecraft/server/ChunkRegionLoader.java  | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/ChunkRegionLoader.java b/src/main/java/net/minecraft/server/ChunkRegionLoader.java
index 2f8170c202..4bc1dc7ebd 100644
--- a/src/main/java/net/minecraft/server/ChunkRegionLoader.java
+++ b/src/main/java/net/minecraft/server/ChunkRegionLoader.java
@@ -447,7 +447,7 @@ public class ChunkRegionLoader {
                         if (asyncsavedata == null) toUpdate.add(entity); // todo fix this broken code, entityJoinedWorld wont work in this case!
                         continue;
                     }
-                    if (asyncsavedata == null && entity.dead) { // todo
+                    if (asyncsavedata == null && (entity.dead || hasPlayerPassenger(entity))) { // todo // Paper - Add hasPlayerPassenger continue
                         continue;
                     }
                     // Paper end
@@ -528,6 +528,20 @@ public class ChunkRegionLoader {
         return nbttagcompound;
     }
 
+    // Paper start
+    private static boolean hasPlayerPassenger(Entity entity) {
+        for (Entity passenger : entity.passengers) {
+            if (passenger instanceof EntityPlayer) {
+                return true;
+            }
+            if (hasPlayerPassenger(passenger)) {
+                return true;
+            }
+        }
+        return false;
+    }
+    // Paper end
+
     // Paper start
     public static ChunkStatus getStatus(NBTTagCompound compound) {
         if (compound == null) {
-- 
2.25.0

