From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Fri, 6 Dec 2013 20:54:23 -0500
Subject: [PATCH] AchievementBroadcastEvent

Used to control who sees achievement message
---
 .../net/minecraft/server/AdvancementDataPlayer.java | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/AdvancementDataPlayer.java b/src/main/java/net/minecraft/server/AdvancementDataPlayer.java
index 7a8a1960882e291c46301d07da3e1c5415516893..28255639d1cd673e69a31078ca5280b0e2fff700 100644
--- a/src/main/java/net/minecraft/server/AdvancementDataPlayer.java
+++ b/src/main/java/net/minecraft/server/AdvancementDataPlayer.java
@@ -42,6 +42,7 @@ import net.minecraft.advancements.CriterionTriggers;
 import net.minecraft.advancements.critereon.CriterionTriggerAbstract;
 import net.minecraft.network.chat.ChatMessage;
 import net.minecraft.network.chat.ChatMessageType;
+import net.minecraft.network.chat.IChatBaseComponent;
 import net.minecraft.network.protocol.game.PacketPlayOutAdvancements;
 import net.minecraft.network.protocol.game.PacketPlayOutSelectAdvancementTab;
 import net.minecraft.resources.MinecraftKey;
@@ -51,6 +52,9 @@ import net.minecraft.util.datafix.DataFixTypes;
 import net.minecraft.world.level.GameRules;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
+import org.bukkit.craftbukkit.entity.CraftPlayer;
+import org.bukkit.craftbukkit.util.CraftChatMessage;
+import org.bukkit.entity.Player;
 
 public class AdvancementDataPlayer {
 
@@ -316,7 +320,14 @@ public class AdvancementDataPlayer {
                 this.player.world.getServer().getPluginManager().callEvent(new org.bukkit.event.player.PlayerAdvancementDoneEvent(this.player.getBukkitEntity(), advancement.bukkit)); // CraftBukkit
                 advancement.d().a(this.player);
                 if (advancement.c() != null && advancement.c().i() && this.player.world.getGameRules().getBoolean(GameRules.ANNOUNCE_ADVANCEMENTS)) {
-                    this.e.sendMessage(new ChatMessage("chat.type.advancement." + advancement.c().e().a(), new Object[]{this.player.getScoreboardDisplayName(), advancement.j()}), ChatMessageType.SYSTEM, SystemUtils.b);
+                    // EMC start
+                    IChatBaseComponent achv = CraftChatMessage.fixComponent(new ChatMessage("chat.type.advancement." + advancement.c().e().a(), new Object[]{this.player.getScoreboardDisplayName(), advancement.j()}));
+                    com.empireminecraft.customevents.AchievementBroadcastEvent event = new com.empireminecraft.customevents.AchievementBroadcastEvent(this.player.getBukkitEntity());
+                    event.callEvent();
+                    for (Player player : event.getReceivers()) {
+                        ((CraftPlayer) player).getHandle().sendMessage(achv, SystemUtils.b);
+                    }
+                    // EMC end
                 }
             }
         }
