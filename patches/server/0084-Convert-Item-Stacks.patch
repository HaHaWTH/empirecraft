From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Sat, 30 Mar 2019 00:45:12 -0400
Subject: [PATCH] Convert Item Stacks

---
 .../net/minecraft/world/item/ItemStack.java   | 16 ++++++++++++--
 .../inventory/CraftItemFactory.java           | 18 +++++++++++++++-
 .../craftbukkit/inventory/CraftItemStack.java | 21 +++++++++++++++----
 .../craftbukkit/inventory/CraftMetaItem.java  | 11 ++++++----
 4 files changed, 55 insertions(+), 11 deletions(-)

diff --git a/src/main/java/net/minecraft/world/item/ItemStack.java b/src/main/java/net/minecraft/world/item/ItemStack.java
index daf72774a3f4fc9da1d8b42db791f65bdf140a0a..7ffcb5cd6fccb6f1911f378b2a9be0df34cb6ed3 100644
--- a/src/main/java/net/minecraft/world/item/ItemStack.java
+++ b/src/main/java/net/minecraft/world/item/ItemStack.java
@@ -36,6 +36,7 @@ import net.minecraft.network.chat.ChatModifier;
 import net.minecraft.network.chat.IChatBaseComponent;
 import net.minecraft.network.chat.IChatMutableComponent;
 import net.minecraft.resources.MinecraftKey;
+import com.empireminecraft.DataConverters;
 import net.minecraft.server.level.EntityPlayer;
 import net.minecraft.sounds.SoundEffect;
 import net.minecraft.stats.StatisticList;
@@ -198,12 +199,23 @@ public final class ItemStack {
         this.checkEmpty();
     }
 
+    private static final boolean DEBUG_CONVERSIONS = Boolean.getBoolean("debug.conversions"); // Paper
     // Called to run this stack through the data converter to handle older storage methods and serialized items
     public void convertStack(int version) {
-        if (0 < version && version < CraftMagicNumbers.INSTANCE.getDataVersion()) {
+        if (0 < version && version < DataConverters.DATA_VERSION && tag != null) { // EMC
             NBTTagCompound savedStack = new NBTTagCompound();
             this.save(savedStack);
-            savedStack = (NBTTagCompound) MinecraftServer.getServer().dataConverterManager.update(DataConverterTypes.ITEM_STACK, new Dynamic(DynamicOpsNBT.a, savedStack), version, CraftMagicNumbers.INSTANCE.getDataVersion()).getValue();
+            NBTTagCompound orig = DEBUG_CONVERSIONS ? savedStack.clone() : null; // Paper
+            savedStack = DataConverters.convert(DataConverterTypes.ITEM_STACK, savedStack, version); // Paper
+            // Paper start
+            if (DEBUG_CONVERSIONS) {
+                boolean equals = orig.equals(savedStack);
+                System.out.println("Converted " + (!equals ? "CHANGED" : "NOT CHANGED") + " - " + orig);
+                if (!equals) {
+                    System.out.println(savedStack);
+                }
+            }
+            // Paper end
             this.load(savedStack);
         }
     }
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemFactory.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemFactory.java
index 347c23d4b7d47198f214c3f95354e8abb660b191..f298cf0651e063568229a15d5da56e7bba9e3cf2 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemFactory.java
@@ -348,9 +348,25 @@ public final class CraftItemFactory implements ItemFactory {
     }
 
     // Paper start
+    public ItemStack _asServerItemStack(ItemStack item) {
+        if (item instanceof CraftItemStack) {
+            return item;
+        } else {
+            CraftItemStack newStack = CraftItemStack.asCraftMirror(CraftItemStack.asNMSCopy(item));
+            newStack.setDataVersion(item.getDataVersion());
+            return newStack;
+        }
+    }
+
     @Override
     public ItemStack ensureServerConversions(ItemStack item) {
-        return CraftItemStack.asCraftMirror(CraftItemStack.asNMSCopy(item));
+        CraftItemStack newItem = (CraftItemStack) _asServerItemStack(item);
+        net.minecraft.world.item.ItemStack handle = newItem.getHandle();
+        if (handle != null && handle.tag != null) {
+            handle.convertStack(item.getDataVersion());
+        }
+        newItem.setDataVersion(org.bukkit.Bukkit.getUnsafe().getDataVersion());
+        return newItem;
     }
 
     @Override
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemStack.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemStack.java
index 09d7a86b5f6cffdf6664ad657dd4f8dd8eabdd70..b69d0fbc1fd09019277180f88bf3b9574488c98a 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemStack.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftItemStack.java
@@ -39,7 +39,12 @@ public final class CraftItemStack extends ItemStack {
 
         net.minecraft.world.item.ItemStack stack = new net.minecraft.world.item.ItemStack(item, original.getAmount());
         if (original.hasItemMeta()) {
-            setItemMeta(stack, original.getItemMeta());
+            // Paper start
+            ItemMeta itemMeta = original.getItemMeta();
+            itemMeta.setVersion(original.getDataVersion());
+            setItemMeta(stack, itemMeta);
+            stack.convertStack(original.getDataVersion());
+            // Paper end
         }
         return stack;
     }
@@ -71,7 +76,11 @@ public final class CraftItemStack extends ItemStack {
     public static CraftItemStack asCraftCopy(ItemStack original) {
         if (original instanceof CraftItemStack) {
             CraftItemStack stack = (CraftItemStack) original;
-            return new CraftItemStack(stack.handle == null ? null : stack.handle.cloneItemStack());
+            // Paper start
+            CraftItemStack newStack = new CraftItemStack(stack.handle == null ? null : stack.handle.cloneItemStack());
+            newStack.dataVersion = original.getDataVersion();
+            return newStack;
+            // Paper end
         }
         return new CraftItemStack(original);
     }
@@ -272,7 +281,11 @@ public final class CraftItemStack extends ItemStack {
 
     @Override
     public ItemMeta getItemMeta() {
-        return getItemMeta(handle);
+        // Paper start
+        ItemMeta itemMeta = getItemMeta(handle);
+        ((CraftMetaItem) itemMeta).setVersion(this.dataVersion);
+        return itemMeta;
+        // Paper end
     }
 
     public static ItemMeta getItemMeta(net.minecraft.world.item.ItemStack item) {
@@ -533,7 +546,7 @@ public final class CraftItemStack extends ItemStack {
         item.setTag(tag);
 
         ((CraftMetaItem) itemMeta).applyToItem(tag);
-        item.convertStack(((CraftMetaItem) itemMeta).getVersion());
+        //item.convertStack(((CraftMetaItem) itemMeta).getVersion()); // Paper
         // SpigotCraft#463 this is required now by the Vanilla client, so mimic ItemStack constructor in ensuring it
         if (item.getItem() != null && item.getItem().usesDurability()) {
             item.setDamage(item.getDamage());
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaItem.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaItem.java
index d3e366de4e7af0d2f922c81bce87312849d4195e..e69a69b7fbf372cb0e9604766a69caa73fbb7110 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaItem.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftMetaItem.java
@@ -315,7 +315,7 @@ class CraftMetaItem implements ItemMeta, Damageable, Repairable, BlockDataMeta {
         if (meta == null) {
             return;
         }
-
+        this.version = meta.version; // Paper - set before all the code below that might use it...
         this.displayName = meta.displayName;
         this.locName = meta.locName;
 
@@ -355,19 +355,22 @@ class CraftMetaItem implements ItemMeta, Damageable, Repairable, BlockDataMeta {
             deserializeInternal(internalTag, meta);
         }
 
-        this.version = meta.version;
+        // this.version = meta.version; // Paper - move up
     }
 
     CraftMetaItem(NBTTagCompound tag) {
+        boolean isLegacy = version <= com.empireminecraft.DataConverters.LEGACY_VERSION; // Paper
         if (tag.hasKey(DISPLAY.NBT)) {
             NBTTagCompound display = tag.getCompound(DISPLAY.NBT);
 
             if (display.hasKey(NAME.NBT)) {
-                displayName = limit( display.getString(NAME.NBT), com.destroystokyo.paper.PaperConfig.itemValidationDisplayNameLength); // Spigot // Paper - make configurable
+                if (isLegacy) displayName = CraftChatMessage.fromStringOrNullToJSON(limit(display.getString(NAME.NBT), com.destroystokyo.paper.PaperConfig.itemValidationDisplayNameLength)); // Paper
+                else displayName = limit( display.getString(NAME.NBT), com.destroystokyo.paper.PaperConfig.itemValidationDisplayNameLength ); // Spigot // Paper
             }
 
             if (display.hasKey(LOCNAME.NBT)) {
-                locName = limit( display.getString(LOCNAME.NBT), com.destroystokyo.paper.PaperConfig.itemValidationLocNameLength ); // Spigot // Paper - make configurable
+                if (isLegacy) locName = CraftChatMessage.fromStringOrNullToJSON(limit( display.getString(LOCNAME.NBT), com.destroystokyo.paper.PaperConfig.itemValidationLocNameLength )); // Spigot // Paper
+                else locName = limit( display.getString(LOCNAME.NBT), com.destroystokyo.paper.PaperConfig.itemValidationLocNameLength ); // Paper
             }
 
             if (display.hasKey(LORE.NBT)) {
