From 7bf13827a71fed40f8a475c8e1c1a97bcf2b6942 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Wed, 23 Apr 2014 00:53:37 -0400
Subject: [PATCH] Add LivingEntity.getLoot()

Get the common loot this entity might drop on death.
---
 src/main/java/net/minecraft/server/EntityInsentient.java | 7 +++++++
 src/main/java/net/minecraft/server/EntitySlime.java      | 2 +-
 .../org/bukkit/craftbukkit/entity/CraftLivingEntity.java | 9 +++++++++
 3 files changed, 17 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/EntityInsentient.java b/src/main/java/net/minecraft/server/EntityInsentient.java
index 013499541..d3840f2f4 100644
--- a/src/main/java/net/minecraft/server/EntityInsentient.java
+++ b/src/main/java/net/minecraft/server/EntityInsentient.java
@@ -19,6 +19,7 @@ import org.bukkit.event.entity.EntityTargetLivingEntityEvent;
 import org.bukkit.event.entity.EntityTargetEvent;
 import org.bukkit.event.entity.EntityUnleashEvent;
 import org.bukkit.event.entity.EntityUnleashEvent.UnleashReason;
+import org.bukkit.loot.LootTables;
 // CraftBukkit end
 
 public abstract class EntityInsentient extends EntityLiving {
@@ -804,6 +805,12 @@ public abstract class EntityInsentient extends EntityLiving {
 
     }
 
+    // EMC start - Reimplementation of old logic
+    @Nullable
+    public Item getCommonLoot() {
+        return (this instanceof EntitySlime && ((EntitySlime)this).getSize() == 1) ? Items.SLIME_BALL : null;
+    }
+    // EMC end
     @Override
     protected void dropDeathLoot(DamageSource damagesource, int i, boolean flag) {
         super.dropDeathLoot(damagesource, i, flag);
diff --git a/src/main/java/net/minecraft/server/EntitySlime.java b/src/main/java/net/minecraft/server/EntitySlime.java
index 253ff9594..8e852c56f 100644
--- a/src/main/java/net/minecraft/server/EntitySlime.java
+++ b/src/main/java/net/minecraft/server/EntitySlime.java
@@ -273,7 +273,7 @@ public class EntitySlime extends EntityInsentient implements IMonster {
 
     @Override
     protected MinecraftKey getDefaultLootTable() {
-        return this.getSize() == 1 ? this.getEntityType().h() : LootTables.a;
+        return this.getSize() == 1 ? this.getEntityType().h () : LootTables.a;
     }
 
     public static boolean c(EntityTypes<EntitySlime> entitytypes, GeneratorAccess generatoraccess, EnumMobSpawn enummobspawn, BlockPosition blockposition, Random random) {
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java
index e0de3820f..efedc4d41 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java
@@ -524,6 +524,15 @@ public class CraftLivingEntity extends CraftEntity implements LivingEntity {
         }
     }
 
+    // EMC start
+    public ItemStack getLoot() {
+        if (getHandle() instanceof EntityInsentient) {
+            final net.minecraft.server.Item loot = ((EntityInsentient) getHandle()).getCommonLoot();
+            return new org.bukkit.inventory.ItemStack(org.bukkit.craftbukkit.util.CraftMagicNumbers.getMaterial(loot));
+        }
+        return null;
+    }
+    // EMC end
     @Override
     public EntityEquipment getEquipment() {
         return equipment;
-- 
2.22.0

