From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 18 Dec 2014 22:48:46 -0500
Subject: [PATCH] Add BlockBreakNaturally Event

To give reliable control over all blocks dropping to world to restore custom item meta
---
 src/main/java/net/minecraft/server/Block.java            | 2 ++
 src/main/java/net/minecraft/server/EntityItem.java       | 1 +
 .../org/bukkit/craftbukkit/event/CraftEventFactory.java  | 9 +++++++++
 3 files changed, 12 insertions(+)

diff --git a/src/main/java/net/minecraft/server/Block.java b/src/main/java/net/minecraft/server/Block.java
index 4b4f14711d483089a5d5478b57539911a9c7a2fc..955a7c260ec12a3665c9b5b430f4e7b91b47e79a 100644
--- a/src/main/java/net/minecraft/server/Block.java
+++ b/src/main/java/net/minecraft/server/Block.java
@@ -234,8 +234,10 @@ public class Block extends BlockBase implements IMaterial {
             entityitem.defaultPickupDelay();
             // CraftBukkit start
             if (world.captureDrops != null) {
+                entityitem.droppedPosition = blockposition.immutableCopy(); // EMC
                 world.captureDrops.add(entityitem);
             } else {
+                new com.empireminecraft.customevents.BlockBreakNaturallyEvent(MCUtil.toLocation(world, blockposition), (org.bukkit.entity.Item) entityitem.getBukkitEntity()).callEvent(); // EMC
                 world.addEntity(entityitem);
             }
             // CraftBukkit end
diff --git a/src/main/java/net/minecraft/server/EntityItem.java b/src/main/java/net/minecraft/server/EntityItem.java
index 85b4f053f3034fcc4f2345dd5d2499d4253ec2bf..0847f1909ebba2285246d7ff67751d1624180b3e 100644
--- a/src/main/java/net/minecraft/server/EntityItem.java
+++ b/src/main/java/net/minecraft/server/EntityItem.java
@@ -17,6 +17,7 @@ public class EntityItem extends Entity {
     private static final DataWatcherObject<ItemStack> ITEM = DataWatcher.a(EntityItem.class, DataWatcherRegistry.g);
     public int age;
     public boolean canDespawn = true; // EMC
+    public BlockPosition droppedPosition; // EMC
     public int pickupDelay;
     private int f;
     private UUID thrower;
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index 8e9550f3405c1ac34773e3943b51fb5adba63b66..e18a77e76971251a92da45fda71850793a1b12ca 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -385,6 +385,15 @@ public class CraftEventFactory {
         Bukkit.getPluginManager().callEvent(event);
 
         if (!event.isCancelled()) {
+            // EMC start
+            com.google.common.collect.Multimap<org.bukkit.Location, org.bukkit.entity.Item> drops = com.google.common.collect.ArrayListMultimap.create();
+            for (EntityItem item : items) {
+                drops.put(net.minecraft.server.MCUtil.toLocation(item.world, item.droppedPosition), (org.bukkit.entity.Item) item.getBukkitEntity());
+            }
+            for (org.bukkit.Location location : drops.keySet()) {
+                new com.empireminecraft.customevents.BlockBreakNaturallyEvent(location, drops.get(location)).callEvent();
+            }
+            // EMC end
             for (EntityItem item : items) {
                 item.world.addEntity(item);
             }
