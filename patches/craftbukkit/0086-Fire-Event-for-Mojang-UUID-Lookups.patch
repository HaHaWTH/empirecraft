From 9bf7a5d8aafb064b08673976ee57cf7a83a13d07 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 30 Apr 2015 23:22:06 -0400
Subject: [PATCH] Fire Event for Mojang UUID Lookups

---
 .../customevents/UUIDLookupEvent.java              | 75 ++++++++++++++++++++++
 .../java/net/minecraft/server/MinecraftServer.java |  2 +-
 2 files changed, 76 insertions(+), 1 deletion(-)
 create mode 100644 src/main/java/com/empireminecraft/customevents/UUIDLookupEvent.java

diff --git a/src/main/java/com/empireminecraft/customevents/UUIDLookupEvent.java b/src/main/java/com/empireminecraft/customevents/UUIDLookupEvent.java
new file mode 100644
index 0000000..0886768
--- /dev/null
+++ b/src/main/java/com/empireminecraft/customevents/UUIDLookupEvent.java
@@ -0,0 +1,75 @@
+package com.empireminecraft.customevents;
+
+import com.google.common.collect.Lists;
+import com.mojang.authlib.Agent;
+import com.mojang.authlib.GameProfile;
+import com.mojang.authlib.GameProfileRepository;
+import com.mojang.authlib.ProfileLookupCallback;
+import org.bukkit.event.Event;
+import org.bukkit.event.HandlerList;
+
+import java.util.List;
+import java.util.UUID;
+
+public class UUIDLookupEvent extends Event {
+    private final String name;
+
+    private UUID uuid = null;
+
+    public UUIDLookupEvent(String name) {
+        this.name = name;
+    }
+
+    public String getName() {
+        return name;
+    }
+
+    public UUID getUUID() {
+        return uuid;
+    }
+
+    public void setUUID(UUID uuid) {
+        this.uuid = uuid;
+    }
+
+
+    private static final HandlerList handlers = new HandlerList();
+
+    public HandlerList getHandlers() {
+        return handlers;
+    }
+
+    public static HandlerList getHandlerList() {
+        return handlers;
+    }
+
+    private static GameProfileRepository repository = null;
+    private static GameProfileRepository repositoryOrig = null;
+    public static GameProfileRepository getProfileRepository(final GameProfileRepository orig) {
+        if (repository == null || orig != repositoryOrig) {
+            repositoryOrig = orig;
+            repository = new GameProfileRepository() {
+                @Override
+                public void findProfilesByNames(String[] names, Agent agent,
+                                                ProfileLookupCallback callback) {
+                    List<String> unfoundNames = Lists.newArrayList();
+                    for (String name : names) {
+                        UUIDLookupEvent event = new UUIDLookupEvent(name);
+                        event.callEvent();
+                        if (event.getUUID() != null) {
+                            GameProfile gameprofile = new GameProfile(event.getUUID(), name);
+                            callback.onProfileLookupSucceeded(gameprofile);
+                        } else {
+                            unfoundNames.add(name);
+                        }
+                    }
+                    if (!unfoundNames.isEmpty() && orig != null) {
+                        orig.findProfilesByNames(unfoundNames.toArray(new String[unfoundNames.size()]), agent,
+                            callback);
+                    }
+                }
+            };
+        }
+        return repository;
+    }
+}
diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index 0895f6b..dc0adaa 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -1493,7 +1493,7 @@ public abstract class MinecraftServer implements Runnable, ICommandListener, IAs
     }
 
     public GameProfileRepository getGameProfileRepository() {
-        return this.Y;
+        return com.empireminecraft.customevents.UUIDLookupEvent.getProfileRepository(this.Y);
     }
 
     public UserCache getUserCache() {
-- 
1.9.1

