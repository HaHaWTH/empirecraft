From a1d4b0fba0897a70da62dcf9e09fb7f40ea071f1 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Sat, 19 Sep 2015 01:38:29 -0400
Subject: [PATCH] Auto remove duplicate entities

CB Bug caused us to get duplicated entities (same UUID).
This will auto clean them up.
---
 src/main/java/net/minecraft/server/WorldServer.java | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/WorldServer.java b/src/main/java/net/minecraft/server/WorldServer.java
index 49af0c4..5f5ad58 100644
--- a/src/main/java/net/minecraft/server/WorldServer.java
+++ b/src/main/java/net/minecraft/server/WorldServer.java
@@ -980,7 +980,8 @@ public class WorldServer extends World implements IAsyncTaskHandler {
     protected void a(Entity entity) {
         super.a(entity);
         this.entitiesById.a(entity.getId(), entity);
-        this.entitiesByUUID.put(entity.getUniqueID(), entity);
+        final Entity old = this.entitiesByUUID.put(entity.getUniqueID(), entity); // EMC
+        if (old != null && old.getId() != entity.getId()) { old.dead = true; System.err.println("[DUPLICATE-REMOVAL] Removing duplicate " + old.getBukkitEntity() + " at " + old.getBukkitEntity().getLocation());} // EMC - auto remove duplicates
         Entity[] aentity = entity.aB();
 
         if (aentity != null) {
-- 
1.9.1

