From 448fb501b7c5b76f4ebb3b100b50a6f016ca7cdc Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Wed, 7 Aug 2013 19:52:14 -0400
Subject: [PATCH] VehicleExitEvent Dismount Reason API

---
 src/main/java/net/minecraft/server/Entity.java       | 5 +++++
 src/main/java/net/minecraft/server/EntityHuman.java  | 2 ++
 src/main/java/net/minecraft/server/EntityLiving.java | 1 +
 src/main/java/net/minecraft/server/World.java        | 2 ++
 4 files changed, 10 insertions(+)

diff --git a/src/main/java/net/minecraft/server/Entity.java b/src/main/java/net/minecraft/server/Entity.java
index c9ae41a..4727a97 100644
--- a/src/main/java/net/minecraft/server/Entity.java
+++ b/src/main/java/net/minecraft/server/Entity.java
@@ -1549,7 +1549,10 @@ public abstract class Entity implements ICommandListener {
         return bukkitEntity;
     }
 
+    VehicleExitEvent.DismountReason dismountReason = VehicleExitEvent.DismountReason.UNKNOWN; // EMC
     public void mount(Entity entity) {
+        VehicleExitEvent.DismountReason reason = dismountReason; // EMC
+        dismountReason = VehicleExitEvent.DismountReason.UNKNOWN; // EMC
         Entity originalVehicle = this.vehicle;
         Entity originalPassenger = this.vehicle == null ? null : this.vehicle.passenger;
         PluginManager pluginManager = Bukkit.getPluginManager();
@@ -1562,6 +1565,7 @@ public abstract class Entity implements ICommandListener {
                 // CraftBukkit start
                 if ((this.bukkitEntity instanceof LivingEntity) && (this.vehicle.getBukkitEntity() instanceof Vehicle)) {
                     VehicleExitEvent event = new VehicleExitEvent((Vehicle) this.vehicle.getBukkitEntity(), (LivingEntity) this.bukkitEntity);
+                    event.reason = reason; // EMC
                     pluginManager.callEvent(event);
 
                     if (event.isCancelled() || vehicle != originalVehicle) {
@@ -1582,6 +1586,7 @@ public abstract class Entity implements ICommandListener {
                 VehicleExitEvent exitEvent = null;
                 if (this.vehicle != null && this.vehicle.getBukkitEntity() instanceof Vehicle) {
                     exitEvent = new VehicleExitEvent((Vehicle) this.vehicle.getBukkitEntity(), (LivingEntity) this.bukkitEntity);
+                    exitEvent.reason = VehicleExitEvent.DismountReason.TRANSFER; // EMC
                     pluginManager.callEvent(exitEvent);
 
                     if (exitEvent.isCancelled() || this.vehicle != originalVehicle || (this.vehicle != null && this.vehicle.passenger != originalPassenger)) {
diff --git a/src/main/java/net/minecraft/server/EntityHuman.java b/src/main/java/net/minecraft/server/EntityHuman.java
index 29ca670..c13f068 100644
--- a/src/main/java/net/minecraft/server/EntityHuman.java
+++ b/src/main/java/net/minecraft/server/EntityHuman.java
@@ -344,6 +344,7 @@ public abstract class EntityHuman extends EntityLiving {
 
     public void ak() {
         if (!this.world.isClientSide && this.isSneaking()) {
+            this.dismountReason = org.bukkit.event.vehicle.VehicleExitEvent.DismountReason.PLAYER; // EMC
             this.mount((Entity) null);
             this.setSneaking(false);
         } else {
@@ -1143,6 +1144,7 @@ public abstract class EntityHuman extends EntityLiving {
         }
 
         if (this.au()) {
+            this.dismountReason = org.bukkit.event.vehicle.VehicleExitEvent.DismountReason.PLAYER; // EMC
             this.mount((Entity) null);
         }
 
diff --git a/src/main/java/net/minecraft/server/EntityLiving.java b/src/main/java/net/minecraft/server/EntityLiving.java
index 9673f3a..940e5a7 100644
--- a/src/main/java/net/minecraft/server/EntityLiving.java
+++ b/src/main/java/net/minecraft/server/EntityLiving.java
@@ -209,6 +209,7 @@ public abstract class EntityLiving extends Entity {
                 }
 
                 if (!this.world.isClientSide && this.au() && this.vehicle instanceof EntityLiving) {
+                    this.dismountReason = org.bukkit.event.vehicle.VehicleExitEvent.DismountReason.WATER; // EMC
                     this.mount((Entity) null);
                 }
             } else {
diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index a8882e1..12dc42c 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -1081,10 +1081,12 @@ public abstract class World implements IBlockAccess {
 
     public void kill(Entity entity) {
         if (entity.passenger != null) {
+            entity.passenger.dismountReason = org.bukkit.event.vehicle.VehicleExitEvent.DismountReason.DEAD; // EMC
             entity.passenger.mount((Entity) null);
         }
 
         if (entity.vehicle != null) {
+            entity.dismountReason = org.bukkit.event.vehicle.VehicleExitEvent.DismountReason.DEAD; // EMC
             entity.mount((Entity) null);
         }
 
-- 
1.9.1

