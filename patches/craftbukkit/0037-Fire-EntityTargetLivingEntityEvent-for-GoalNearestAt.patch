From 0135a50afb094059d8fd18aeaac46eee70209237 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Fri, 28 Feb 2014 22:25:04 -0500
Subject: [PATCH] Fire EntityTargetLivingEntityEvent for
 GoalNearestAttackableTarget

If cancelled, move to next in list
---
 .../server/PathfinderGoalNearestAttackableTarget.java      | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/PathfinderGoalNearestAttackableTarget.java b/src/main/java/net/minecraft/server/PathfinderGoalNearestAttackableTarget.java
index c110e0c..056e982 100644
--- a/src/main/java/net/minecraft/server/PathfinderGoalNearestAttackableTarget.java
+++ b/src/main/java/net/minecraft/server/PathfinderGoalNearestAttackableTarget.java
@@ -76,7 +76,19 @@ public class PathfinderGoalNearestAttackableTarget<T extends EntityLiving> exten
             if (list.isEmpty()) {
                 return false;
             } else {
-                this.d = (EntityLiving) list.get(0);
+                // EMC start
+                for (EntityLiving entity : ((List<EntityLiving>) list)) {
+                    if (org.bukkit.craftbukkit.event.CraftEventFactory
+                        .callEntityTargetLivingEvent(
+                            this.e,
+                            entity,
+                            org.bukkit.event.entity.EntityTargetEvent.TargetReason.CLOSEST_PLAYER).isCancelled()) {
+                        continue;
+                    }
+                    this.d = entity;
+                    break;
+                }
+                // EMC end
                 return true;
             }
         }
-- 
1.9.1

