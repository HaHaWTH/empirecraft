From 4c36bd6ee5806172e4ad982321705077196d4ba2 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 27 Aug 2015 00:43:02 -0400
Subject: [PATCH] Optimize hot spot with isValidLocation

While this method is simple, its so hot its showing up in samplings.

Replace with a version much more likely to be inlined that only checks
Y value will speed things up, with no risk when worlds are expected to
never be at the 3 billion distance.

Also static the existing isValidLocation to assist with inlining.
---
 src/main/java/net/minecraft/server/World.java | 17 +++++++++++++----
 1 file changed, 13 insertions(+), 4 deletions(-)

diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index c9cecfc..8800f83 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -281,9 +281,18 @@ public abstract class World implements IBlockAccess {
         return this.getType(blockposition1).getBlock();
     }
 
-    private boolean isValidLocation(BlockPosition blockposition) {
-        return blockposition.getX() >= -30000000 && blockposition.getZ() >= -30000000 && blockposition.getX() < 30000000 && blockposition.getZ() < 30000000 && blockposition.getY() >= 0 && blockposition.getY() < 256;
+    // EMC start
+    private static boolean isFastValidLocation(final BlockPosition blockposition) {
+        final int y = blockposition.getY();
+        return y >= 0 && y < 256;
     }
+    private static boolean isValidLocation(final BlockPosition blockposition) {
+        final int x = blockposition.getX();
+        final int z = blockposition.getZ();
+        final int y = blockposition.getY();
+        return x >= -30000000 && z >= -30000000 && x < 30000000 && z < 30000000 && y >= 0 && y < 256;
+    }
+    // EMC end
 
     public boolean isEmpty(BlockPosition blockposition) {
         return this.getType(blockposition).getBlock().getMaterial() == Material.AIR;
@@ -376,7 +385,7 @@ public abstract class World implements IBlockAccess {
             return true;
         }
         // CraftBukkit end
-        if (!this.isValidLocation(blockposition)) {
+        if (!isFastValidLocation(blockposition)) { // EMC - use a simpler check
             return false;
         } else if (!this.isClientSide && this.worldData.getType() == WorldType.DEBUG_ALL_BLOCK_STATES) {
             return false;
@@ -778,7 +787,7 @@ public abstract class World implements IBlockAccess {
             }
         }
         // CraftBukkit end
-        if (!this.isValidLocation(blockposition)) {
+        if (!this.isFastValidLocation(blockposition)) { // EMC
             return Blocks.AIR.getBlockData();
         } else {
             Chunk chunk = this.getChunkAtWorldCoords(blockposition);
-- 
2.6.4

