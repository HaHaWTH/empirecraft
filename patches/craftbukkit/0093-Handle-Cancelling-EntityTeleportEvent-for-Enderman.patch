From b5f562692bcf86380caa3830105732ed6b74cad4 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Sun, 17 May 2015 14:47:17 -0400
Subject: [PATCH] Handle Cancelling EntityTeleportEvent for Enderman

---
 src/main/java/net/minecraft/server/EntityEnderman.java | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/src/main/java/net/minecraft/server/EntityEnderman.java b/src/main/java/net/minecraft/server/EntityEnderman.java
index a250062..1f2f125 100644
--- a/src/main/java/net/minecraft/server/EntityEnderman.java
+++ b/src/main/java/net/minecraft/server/EntityEnderman.java
@@ -15,7 +15,7 @@ import org.bukkit.event.entity.EntityTeleportEvent;
 // CraftBukkit end
 
 public class EntityEnderman extends EntityMonster {
-
+    boolean abortTeleport = false; // EMC
     private static final UUID a = UUID.fromString("020E0DFB-87AE-4653-9556-831010E291A0");
     private static final AttributeModifier b = (new AttributeModifier(EntityEnderman.a, "Attacking speed boost", 0.15000000596046448D, 0)).a(false);
     private static final Set<Block> c = Sets.newIdentityHashSet();
@@ -188,6 +188,8 @@ public class EntityEnderman extends EntityMonster {
                 EntityTeleportEvent teleport = new EntityTeleportEvent(this.getBukkitEntity(), new Location(this.world.getWorld(), d3, d4, d5), new Location(this.world.getWorld(), this.locX, this.locY, this.locZ));
                 this.world.getServer().getPluginManager().callEvent(teleport);
                 if (teleport.isCancelled()) {
+                    setPosition(d3, d4, d5); // CraftBukkit
+                    abortTeleport = true; // EMC
                     return false;
                 }
 
@@ -281,13 +283,14 @@ public class EntityEnderman extends EntityMonster {
                 if (damagesource instanceof EntityDamageSourceIndirect) {
                     this.bm = false;
 
-                    for (int i = 0; i < 64; ++i) {
+                    abortTeleport = false; // EMC
+                    for (int i = 0; i < 64 && !abortTeleport; ++i) { // EMC
                         if (this.n()) {
                             return true;
                         }
                     }
 
-                    return false;
+                    if (!abortTeleport) return false; // EMC
                 }
             }
 
-- 
1.9.1

