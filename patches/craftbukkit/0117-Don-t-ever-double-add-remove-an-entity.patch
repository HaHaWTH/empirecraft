From 8c01369fbd06ba726cd69c55bc33b7e42ca54a82 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Tue, 22 Sep 2015 23:46:17 -0400
Subject: [PATCH] Don't ever double add/remove an entity

---
 src/main/java/net/minecraft/server/World.java | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index 69171a8..ebc3a5b 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -1407,6 +1407,7 @@ public abstract class World implements IBlockAccess {
 
         for (i = 0; i < this.g.size(); ++i) {
             entity = (Entity) this.g.get(i);
+            if (!entity.valid) continue; // EMC
             j = entity.ae;
             k = entity.ag;
             if (entity.ad && this.isChunkLoaded(j, k, true)) {
@@ -2682,7 +2683,7 @@ public abstract class World implements IBlockAccess {
         while (iterator.hasNext()) {
             Entity entity = (Entity) iterator.next();
 
-            if (entity == null) {
+            if (entity == null || entity.valid) { // EMC - don't add if already added to world
                 continue;
             }
             this.entityList.add(entity);
-- 
1.9.1

