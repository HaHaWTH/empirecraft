From f7cd134e3e785e025c2c0f34f6c5b79ca5d8eb1b Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Mon, 15 Sep 2014 21:36:25 -0400
Subject: [PATCH] Limit damage of EntityPlayer memory leaks

If a plugin leaks EntityPlayer references by storing Player objects and never cleaning them up,
then the server will leak a ton of memory by buffering up packets into the outgoing queue that will
never be processed. These packets themselves then hold on to lots of other references, causing massive leaks.

This change does not prevent plugins from leaking EntityPlayer references, but will drastically reduce the impact
of the bug to the level one would expect of a Minecraft Server of memory leaks anyways.
---
 src/main/java/net/minecraft/server/NetworkManager.java   | 6 ++++--
 src/main/java/net/minecraft/server/PlayerConnection.java | 4 +++-
 2 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/src/main/java/net/minecraft/server/NetworkManager.java b/src/main/java/net/minecraft/server/NetworkManager.java
index 6003bad..2ad9152 100644
--- a/src/main/java/net/minecraft/server/NetworkManager.java
+++ b/src/main/java/net/minecraft/server/NetworkManager.java
@@ -61,8 +61,10 @@ public class NetworkManager extends SimpleChannelInboundHandler<Packet> {
         }
     };
     private final EnumProtocolDirection h;
-    private final Queue<NetworkManager.QueuedPacket> i = Queues.newConcurrentLinkedQueue();
+    private final Queue<NetworkManager.QueuedPacket> i = Queues.newConcurrentLinkedQueue(); public void clearQueue() { i.clear(); } // Spigot - add clearQueues // PAIL: Rename queue
+
     private final ReentrantReadWriteLock j = new ReentrantReadWriteLock();
+    EntityPlayer player; // Spigot
     public Channel k; // CraftBukkit - public, PAIL: Rename channel
     // Spigot Start
     public SocketAddress l;
@@ -140,7 +142,7 @@ public class NetworkManager extends SimpleChannelInboundHandler<Packet> {
         if (this.g()) {
             this.m();
             this.a(packet, (GenericFutureListener[]) null);
-        } else {
+        } else if (player != null && !player.playerConnection.processedDisconnect) { // Spigot
             this.j.writeLock().lock();
 
             try {
diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index 0965792..4c5d5af 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -82,9 +82,10 @@ public class PlayerConnection implements PacketListenerPlayIn, IUpdatePlayerList
     private double p;
     private double q;
     private boolean checkMovement = true;
-    private boolean processedDisconnect; // CraftBukkit - added
+    public boolean processedDisconnect; // CraftBukkit - added // Spigot - private -> public
 
     public PlayerConnection(MinecraftServer minecraftserver, NetworkManager networkmanager, EntityPlayer entityplayer) {
+        networkmanager.player = entityplayer; // Spigot
         this.minecraftServer = minecraftserver;
         this.networkManager = networkmanager;
         networkmanager.a((PacketListener) this);
@@ -852,6 +853,7 @@ public class PlayerConnection implements PacketListenerPlayIn, IUpdatePlayerList
         if ((quitMessage != null) && (quitMessage.length() > 0)) {
             this.minecraftServer.getPlayerList().sendMessage(CraftChatMessage.fromString(quitMessage));
         }
+        this.player.playerConnection.networkManager.clearQueue(); // Spigot
         // CraftBukkit end
         if (this.minecraftServer.S() && this.player.getName().equals(this.minecraftServer.R())) {
             PlayerConnection.c.info("Stopping singleplayer server as player logged out");
-- 
1.9.1

