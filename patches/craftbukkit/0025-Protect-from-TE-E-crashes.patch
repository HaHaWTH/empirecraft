From 3884f9c223c07de6bca465d3236cde22e94ebd17 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Wed, 3 Jul 2013 08:29:26 -0400
Subject: [PATCH] Protect from TE/E crashes

---
 src/main/java/net/minecraft/server/World.java | 26 +++++++++++++++++++++-----
 1 file changed, 21 insertions(+), 5 deletions(-)

diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index 12dc42c..1f1b8e6 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -1429,10 +1429,19 @@ public abstract class World implements IBlockAccess {
                     this.g(entity);
                     SpigotTimings.tickEntityTimer.stopTiming(); // Spigot
                 } catch (Throwable throwable1) {
+                    // EMC start
+                    SpigotTimings.tickEntityTimer.stopTiming(); // Spigot
+                    System.err.println("Entity threw exception at " + entity.world.getWorld().getName()+":"+entity.locX +"," + entity.locY+","+entity.locZ);
+                    throwable1.printStackTrace();
+                    entity.dead = true;
+                    continue;
+                    /*
                     crashreport = CrashReport.a(throwable1, "Ticking entity");
                     crashreportsystemdetails = crashreport.a("Entity being ticked");
                     entity.appendEntityCrashDetails(crashreportsystemdetails);
                     throw new ReportedException(crashreport);
+                    */
+                    // EMC end
                 }
             }
 
@@ -1490,11 +1499,18 @@ public abstract class World implements IBlockAccess {
                         tileentity.tickTimer.startTiming(); // Spigot
                         ((IUpdatePlayerListBox) tileentity).c();
                     } catch (Throwable throwable2) {
-                        CrashReport crashreport1 = CrashReport.a(throwable2, "Ticking block entity");
-                        CrashReportSystemDetails crashreportsystemdetails1 = crashreport1.a("Block entity being ticked");
-
-                        tileentity.a(crashreportsystemdetails1);
-                        throw new ReportedException(crashreport1);
+                        // EMC start
+                        System.err.println("TileEntity threw exception at " + tileentity.world.getWorld().getName()+":"+tileentity.getPosition().getX() +"," + tileentity.getPosition().getY()+","+tileentity.getPosition().getZ());
+                        throwable2.printStackTrace();
+                        //CrashReport crashreport1 = CrashReport.a(throwable2, "Ticking block entity");
+                        //CrashReportSystemDetails crashreportsystemdetails1 = crashreport1.a("Block entity being ticked");
+
+                        //tileentity.a(crashreportsystemdetails1);
+                        //throw new ReportedException(crashreport1);
+                        this.tileEntityList.remove(tileTickPosition);
+                        tileTickPosition--;
+                        continue;
+                        // EMC end
                     }
                     // Spigot start
                     finally {
-- 
1.9.1

