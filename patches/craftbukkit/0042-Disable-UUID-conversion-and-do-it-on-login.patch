From 87aad6a39d858f5c172430701dba186b2bfb2640 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Mon, 14 Apr 2014 20:44:38 -0400
Subject: [PATCH] Disable UUID conversion and do it on login

---
 src/main/java/net/minecraft/server/DedicatedServer.java            | 4 ++--
 .../java/net/minecraft/server/NameReferencingFileConverter.java    | 1 +
 src/main/java/net/minecraft/server/WorldNBTStorage.java            | 7 +++++++
 3 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/src/main/java/net/minecraft/server/DedicatedServer.java b/src/main/java/net/minecraft/server/DedicatedServer.java
index 86ff385..f551adf 100644
--- a/src/main/java/net/minecraft/server/DedicatedServer.java
+++ b/src/main/java/net/minecraft/server/DedicatedServer.java
@@ -569,7 +569,7 @@ public class DedicatedServer extends MinecraftServer implements IMinecraftServer
             flag3 = NameReferencingFileConverter.d((MinecraftServer) this);
         }
 
-        boolean flag4 = false;
+        boolean flag4 = true; // EMC - Disable Full Player data conversion, it will happen on login.
 
         for (i = 0; !flag4 && i <= 2; ++i) {
             if (i > 0) {
@@ -577,7 +577,7 @@ public class DedicatedServer extends MinecraftServer implements IMinecraftServer
                 this.aT();
             }
 
-            flag4 = NameReferencingFileConverter.a(this, this.propertyManager);
+            // flag4 = NameReferencingFileConverter.a(this, this.propertyManager); // EMC - Disable Full Player data conversion, it will happen on login.
         }
 
         return flag || flag1 || flag2 || flag3 || flag4;
diff --git a/src/main/java/net/minecraft/server/NameReferencingFileConverter.java b/src/main/java/net/minecraft/server/NameReferencingFileConverter.java
index c1f8ff6..468b12a 100644
--- a/src/main/java/net/minecraft/server/NameReferencingFileConverter.java
+++ b/src/main/java/net/minecraft/server/NameReferencingFileConverter.java
@@ -481,6 +481,7 @@ public class NameReferencingFileConverter {
     }
 
     private static boolean c(PropertyManager propertymanager) {
+        if (true) return true; // EMC
         File file = d(propertymanager);
 
         if (file.exists() && file.isDirectory() && (file.list().length > 0 || !file.delete())) {
diff --git a/src/main/java/net/minecraft/server/WorldNBTStorage.java b/src/main/java/net/minecraft/server/WorldNBTStorage.java
index 4acc8bd..65fcb56 100644
--- a/src/main/java/net/minecraft/server/WorldNBTStorage.java
+++ b/src/main/java/net/minecraft/server/WorldNBTStorage.java
@@ -205,6 +205,13 @@ public class WorldNBTStorage implements IDataManager, IPlayerFileData {
 
         try {
             File file = new File(this.playerDir, entityhuman.getUniqueID().toString() + ".dat");
+            // EMC start
+            File fileold = new File(this.baseDir, "players/" + entityhuman.getName() + ".dat");
+            if (!file1.exists() && fileold.exists() && fileold.isFile()) {
+                fileold.renameTo(file1);
+                System.out.println("Converting " + entityhuman.getName() + " to UUID storage");
+            }
+            // EMC end
             // Spigot Start
             boolean usingWrongFile = false;
             if ( !file.exists() )
-- 
1.9.1

