From 4b97d3fd2bc5d2b5c5e8696f913a125c79300aca Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Fri, 29 May 2015 21:58:24 -0400
Subject: [PATCH] Fix Minecraft: Fix Hoppers

Major: Remove duplicate .update() calls. Chests call update themselves, and mc
  decided to throw in an ultimately useless duplicate of its own!
  Bring it down to 1 per update by ignoring .update() during hopper manipulation
Major: Item Suck In, Only do a "Suck in" action once per second
Minor: Remove itemstack cloning until the hopper has actually performed an item move
Minor: remove InventoryMoveEvent code for extra performance since we dont use it,
  is also full of item stack cloning
---
 src/main/java/net/minecraft/server/EntityItem.java | 15 +++++
 .../net/minecraft/server/EntityMinecartHopper.java |  1 +
 .../java/net/minecraft/server/MinecraftServer.java |  2 +
 src/main/java/net/minecraft/server/TileEntity.java |  2 +
 .../net/minecraft/server/TileEntityHopper.java     | 74 +++++++++++++++++-----
 5 files changed, 77 insertions(+), 17 deletions(-)

diff --git a/src/main/java/net/minecraft/server/EntityItem.java b/src/main/java/net/minecraft/server/EntityItem.java
index 306c7e4..d0f6e28 100644
--- a/src/main/java/net/minecraft/server/EntityItem.java
+++ b/src/main/java/net/minecraft/server/EntityItem.java
@@ -118,10 +118,24 @@ public class EntityItem extends Entity {
                 // CraftBukkit end
                 this.die();
             }
+            markHopperCarts(); // EMC
 
         }
     }
 
+    // EMC start
+    public void markHopperCarts() {
+        if (!this.dead && this.onGround && this.age < 20 * 60 && this.age % 20 == 0) {
+            AxisAlignedBB aabb = this.getBoundingBox().grow(32, 4, 32);
+            for (Entity entity : this.world.getEntities(this, aabb)) {
+                if (entity instanceof EntityMinecartHopper) {
+                    ((EntityMinecartHopper) entity).pickupImmunity = MinecraftServer.currentTick + 200;
+                }
+            }
+        }
+    }
+    // EMC end
+
     // Spigot start - copied from above
     @Override
     public void inactiveTick() {
@@ -141,6 +155,7 @@ public class EntityItem extends Entity {
             // CraftBukkit end
             this.die();
         }
+        markHopperCarts(); // EMC
     }
     // Spigot end
 
diff --git a/src/main/java/net/minecraft/server/EntityMinecartHopper.java b/src/main/java/net/minecraft/server/EntityMinecartHopper.java
index eefbdc6..4a1d84b 100644
--- a/src/main/java/net/minecraft/server/EntityMinecartHopper.java
+++ b/src/main/java/net/minecraft/server/EntityMinecartHopper.java
@@ -7,6 +7,7 @@ public class EntityMinecartHopper extends EntityMinecartContainer implements IHo
     private boolean a = true;
     private int b = -1;
     private BlockPosition c;
+    public int pickupImmunity = 0; // EMC
 
     public EntityMinecartHopper(World world) {
         super(world);
diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index 33d6c15..7ca3f41 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -561,6 +561,7 @@ public abstract class MinecraftServer implements Runnable, ICommandListener, IAs
         }
     }
     // Spigot End
+    public static double currentTPS = 20D; // EMC
 
     public void run() {
         try {
@@ -702,6 +703,7 @@ public abstract class MinecraftServer implements Runnable, ICommandListener, IAs
             this.methodProfiler.a = true;
             this.methodProfiler.a();
         }
+        currentTPS = tps1.getAverage(); // EMC
 
         this.methodProfiler.a("root");
         this.B();
diff --git a/src/main/java/net/minecraft/server/TileEntity.java b/src/main/java/net/minecraft/server/TileEntity.java
index 741f86c..a41503a 100644
--- a/src/main/java/net/minecraft/server/TileEntity.java
+++ b/src/main/java/net/minecraft/server/TileEntity.java
@@ -22,6 +22,7 @@ public abstract class TileEntity {
     private int h;
     protected Block e;
 
+    public static boolean IGNORE_TILE_UPDATES = false; // EMC
     public TileEntity() {
         this.position = BlockPosition.ZERO;
         this.h = -1;
@@ -99,6 +100,7 @@ public abstract class TileEntity {
 
     public void update() {
         if (this.world != null) {
+            if (IGNORE_TILE_UPDATES) return;
             IBlockData iblockdata = this.world.getType(this.position);
 
             this.h = iblockdata.getBlock().toLegacyData(iblockdata);
diff --git a/src/main/java/net/minecraft/server/TileEntityHopper.java b/src/main/java/net/minecraft/server/TileEntityHopper.java
index a41b88a..a44e523 100644
--- a/src/main/java/net/minecraft/server/TileEntityHopper.java
+++ b/src/main/java/net/minecraft/server/TileEntityHopper.java
@@ -135,6 +135,19 @@ public class TileEntityHopper extends TileEntityContainer implements IHopper, IU
         }
     }
 
+    // EMC start
+    public static boolean shouldSuckin(IHopper hopper) {
+        final int tick = MinecraftServer.currentTick;
+        final int hopperId = (int) hopper.A() + (int) hopper.B() + (int) hopper.C();
+        if ((tick + hopperId) % 60 == 0) {
+            return true;
+        }
+        if (hopper instanceof EntityMinecartHopper && ((EntityMinecartHopper) hopper).pickupImmunity > tick) {
+            return true;
+        }
+        return false;
+    }
+    // EMC end
     public void setItem(int i, ItemStack itemstack) {
         this.items[i] = itemstack;
         if (itemstack != null && itemstack.count > this.getMaxStackSize()) {
@@ -201,6 +214,8 @@ public class TileEntityHopper extends TileEntityContainer implements IHopper, IU
                     return true;
                 }
             }
+
+            if (isFull()) { resetCooldown(); } // EMC
             return false;
         } else {
             return false;
@@ -222,6 +237,7 @@ public class TileEntityHopper extends TileEntityContainer implements IHopper, IU
         return true;
     }
 
+    boolean isFull() { return q(); } // EMC
     private boolean q() {
         ItemStack[] aitemstack = this.items;
         int i = aitemstack.length;
@@ -251,9 +267,13 @@ public class TileEntityHopper extends TileEntityContainer implements IHopper, IU
             } else {
                 for (int i = 0; i < this.getSize(); ++i) {
                     if (this.getItem(i) != null) {
-                        ItemStack itemstack = this.getItem(i).cloneItemStack();
-                        // ItemStack itemstack1 = addItem(iinventory, this.splitStack(i, 1), enumdirection);
+                        // EMC start - replace whole method
+                        ItemStack itemstack = this.getItem(i);
+                        int origCount = itemstack.count;
+                        itemstack.count = 1;
+                        ItemStack itemstack1 = addItem(iinventory, itemstack, enumdirection);
 
+                        /*
                         // CraftBukkit start - Call event when pushing items into other inventories
                         CraftItemStack oitemstack = CraftItemStack.asCraftMirror(this.splitStack(i, world.spigotConfig.hopperAmount)); // Spigot
 
@@ -274,18 +294,24 @@ public class TileEntityHopper extends TileEntityContainer implements IHopper, IU
                         }
                         int origCount = event.getItem().getAmount(); // Spigot
                         ItemStack itemstack1 = addItem(iinventory, CraftItemStack.asNMSCopy(event.getItem()), enumdirection);
-
+                        */
                         if (itemstack1 == null || itemstack1.count == 0) {
-                            if (event.getItem().equals(oitemstack)) {
+                            itemstack = itemstack.cloneItemStack();
+                            itemstack.count = origCount - 1;
+                            if (itemstack.count <= 0) {
+                                itemstack = null;
+                            }
+                            this.setItem(i, itemstack);
+                            iinventory.update();
+                            /*if (event.getItem().equals(oitemstack)) {
                                 iinventory.update();
                             } else {
                                 this.setItem(i, itemstack);
-                            }
-                            // CraftBukkit end
+                            }*/
                             return true;
                         }
-                        itemstack.count -= origCount - itemstack1.count; // Spigot
-                        this.setItem(i, itemstack);
+                        itemstack.count = origCount;
+                        // EMC end
                     }
                 }
 
@@ -372,7 +398,7 @@ public class TileEntityHopper extends TileEntityContainer implements IHopper, IU
                     }
                 }
             }
-        } else {
+        } else if (shouldSuckin(ihopper)) { // EMC
             Iterator iterator = a(ihopper.getWorld(), ihopper.A(), ihopper.B() + 1.0D, ihopper.C()).iterator(); // EMC - No change here - but if ihopper.A/B/C() changes, update drain event little above
 
             while (iterator.hasNext()) {
@@ -387,12 +413,16 @@ public class TileEntityHopper extends TileEntityContainer implements IHopper, IU
         return false;
     }
 
+    // EMC - Drain chest into this hopper
     private static boolean a(IHopper ihopper, IInventory iinventory, int i, EnumDirection enumdirection) {
         ItemStack itemstack = iinventory.getItem(i);
 
         if (itemstack != null && b(iinventory, itemstack, i, enumdirection)) {
-            ItemStack itemstack1 = itemstack.cloneItemStack();
-            // ItemStack itemstack2 = addItem(ihopper, iinventory.splitStack(i, 1), (EnumDirection) null);
+            // EMC start - whole method
+            int origCount = itemstack.count; // EMC
+            itemstack.count = 1;
+            ItemStack itemstack2 = addItem(ihopper, itemstack, (EnumDirection) null);
+            /*
             // CraftBukkit start - Call event on collection of items from inventories into the hopper
             CraftItemStack oitemstack = CraftItemStack.asCraftMirror(iinventory.splitStack(i, ihopper.getWorld().spigotConfig.hopperAmount)); // Spigot
 
@@ -419,19 +449,26 @@ public class TileEntityHopper extends TileEntityContainer implements IHopper, IU
             }
             int origCount = event.getItem().getAmount(); // Spigot
             ItemStack itemstack2 = addItem(ihopper, CraftItemStack.asNMSCopy(event.getItem()), null);
-
+            */
             if (itemstack2 == null || itemstack2.count == 0) {
-                if (event.getItem().equals(oitemstack)) {
+                itemstack = itemstack.cloneItemStack();
+                itemstack.count = origCount - 1;
+                if (itemstack.count <= 0) {
+                    itemstack = null;
+                }
+                iinventory.setItem(i, itemstack);
+                iinventory.update();
+                /*if (event.getItem().equals(oitemstack)) {
                     iinventory.update();
                 } else {
                     iinventory.setItem(i, itemstack1);
                 }
+                */
                 // CraftBukkit end
                 return true;
             }
-            itemstack1.count -= origCount - itemstack2.count; // Spigot
-
-            iinventory.setItem(i, itemstack1);
+            itemstack.count = origCount;
+            // EMC end
         }
 
         return false;
@@ -502,7 +539,9 @@ public class TileEntityHopper extends TileEntityContainer implements IHopper, IU
             boolean flag = false;
 
             if (itemstack1 == null) {
+                IGNORE_TILE_UPDATES = true; // EMC - chests call update themselves, which is called below
                 iinventory.setItem(i, itemstack);
+                IGNORE_TILE_UPDATES = false; // EMC
                 itemstack = null;
                 flag = true;
             } else if (a(itemstack1, itemstack)) {
@@ -522,7 +561,7 @@ public class TileEntityHopper extends TileEntityContainer implements IHopper, IU
                         tileentityhopper.d(tileentityhopper.world.spigotConfig.hopperTransfer); // Spigot
                     }
 
-                    iinventory.update();
+                    //iinventory.update(); // EMC - duplicate
                 }
 
                 iinventory.update();
@@ -593,6 +632,7 @@ public class TileEntityHopper extends TileEntityContainer implements IHopper, IU
         return (double) this.position.getZ() + 0.5D;
     }
 
+    void resetCooldown() { d(world.spigotConfig.hopperTransfer); } // EMC
     public void d(int i) {
         this.g = i;
     }
-- 
2.7.0

