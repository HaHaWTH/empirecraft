From cbd1440b36b68bbc81a6e65b7695375eea70d5c8 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 7 Feb 2013 11:34:50 -0500
Subject: [PATCH] Timings improvements.

---
 src/main/java/org/bukkit/CustomTimingsHandler.java | 73 ++++++++++++++++++++++
 .../org/bukkit/command/defaults/ReloadCommand.java |  2 +-
 .../bukkit/command/defaults/TimingsCommand.java    |  2 +-
 .../org/bukkit/event/CustomTimingsHandler.java     | 60 ------------------
 4 files changed, 75 insertions(+), 62 deletions(-)
 create mode 100644 src/main/java/org/bukkit/CustomTimingsHandler.java
 delete mode 100644 src/main/java/org/bukkit/event/CustomTimingsHandler.java

diff --git a/src/main/java/org/bukkit/CustomTimingsHandler.java b/src/main/java/org/bukkit/CustomTimingsHandler.java
new file mode 100644
index 0000000..be5ff0c
--- /dev/null
+++ b/src/main/java/org/bukkit/CustomTimingsHandler.java
@@ -0,0 +1,73 @@
+package org.bukkit;
+
+import java.io.PrintStream;
+import java.util.ArrayList;
+
+/**
+ * Extends RegisteredListener to include timing information
+ */
+public class CustomTimingsHandler {
+
+    private final String name;
+    public int count = 0;
+    public long totalTime = 0;
+    long start = 0;
+    CustomTimingsHandler other = null;
+
+    static public ArrayList<CustomTimingsHandler> allList = new ArrayList<>();
+    public CustomTimingsHandler(String name) {
+        this.name = name;
+        allList.add(this);
+    }
+
+    static public void printTimings(PrintStream printStream) {
+        printStream.println("Minecraft - ** indicates it's already counted by another timing");
+        for (CustomTimingsHandler t : allList) {
+            long time = t.totalTime;
+            int count = t.count;
+            if (count == 0) continue;
+            long avg = time / count;
+
+            printStream.println("    " + t.name + " Time: " + time + " Count: " + count + " Avg: " + avg);
+        }
+    }
+
+    static public void reload() {
+        if (!Bukkit.getServer().getPluginManager().useTimings()) return;
+        for (CustomTimingsHandler t : allList) {
+            t.reset();
+        }
+    }
+
+    public void startTiming(CustomTimingsHandler other) {
+        if (!Bukkit.getServer().getPluginManager().useTimings()) return;
+        startTiming();
+        other.start = start;
+        this.other = other;
+    }
+
+    public void startTiming() {
+        if (!Bukkit.getServer().getPluginManager().useTimings()) return;
+        start = System.nanoTime();
+    }
+
+    public void stopTiming() {
+        if (!Bukkit.getServer().getPluginManager().useTimings() || start == 0) return;
+
+        long diff = System.nanoTime() - start;
+        totalTime += diff;
+        count++;
+        if (other != null) {
+            other.totalTime += diff;
+            other.count++;
+            other = null;
+        }
+    }
+
+    public void reset() {
+        count = 0;
+        start = 0;
+        totalTime = 0;
+    }
+}
+
diff --git a/src/main/java/org/bukkit/command/defaults/ReloadCommand.java b/src/main/java/org/bukkit/command/defaults/ReloadCommand.java
index fffafa5..89c8414 100644
--- a/src/main/java/org/bukkit/command/defaults/ReloadCommand.java
+++ b/src/main/java/org/bukkit/command/defaults/ReloadCommand.java
@@ -6,7 +6,7 @@ import org.bukkit.Bukkit;
 import org.bukkit.ChatColor;
 import org.bukkit.command.Command;
 import org.bukkit.command.CommandSender;
-import org.bukkit.event.CustomTimingsHandler;
+import org.bukkit.CustomTimingsHandler;
 
 public class ReloadCommand extends BukkitCommand {
     public ReloadCommand(String name) {
diff --git a/src/main/java/org/bukkit/command/defaults/TimingsCommand.java b/src/main/java/org/bukkit/command/defaults/TimingsCommand.java
index e0628d0..c4c6514 100644
--- a/src/main/java/org/bukkit/command/defaults/TimingsCommand.java
+++ b/src/main/java/org/bukkit/command/defaults/TimingsCommand.java
@@ -10,7 +10,7 @@ import org.apache.commons.lang.Validate;
 import org.bukkit.Bukkit;
 import org.bukkit.ChatColor;
 import org.bukkit.command.CommandSender;
-import org.bukkit.event.CustomTimingsHandler;
+import org.bukkit.CustomTimingsHandler;
 import org.bukkit.event.Event;
 import org.bukkit.event.HandlerList;
 import org.bukkit.plugin.Plugin;
diff --git a/src/main/java/org/bukkit/event/CustomTimingsHandler.java b/src/main/java/org/bukkit/event/CustomTimingsHandler.java
deleted file mode 100644
index 83294e3..0000000
--- a/src/main/java/org/bukkit/event/CustomTimingsHandler.java
+++ /dev/null
@@ -1,60 +0,0 @@
-package org.bukkit.event;
-
-
-import org.bukkit.Bukkit;
-
-import java.io.PrintStream;
-import java.util.ArrayList;
-
-/**
- * Extends RegisteredListener to include timing information
- */
-public class CustomTimingsHandler {
-
-    private final String name;
-    public int count = 0;
-    public long totalTime = 0;
-    long start = 0;
-
-    static public ArrayList<CustomTimingsHandler> allList = new ArrayList<>();
-    public CustomTimingsHandler(String name) {
-        this.name = name;
-        allList.add(this);
-    }
-
-    static public void printTimings(PrintStream printStream) {
-        printStream.println("Minecraft - ** indicates it's already counted by another timing");
-        for (CustomTimingsHandler t : allList) {
-            long time = t.totalTime;
-            int count = t.count;
-            if (count == 0) continue;
-            long avg = time / count;
-
-            printStream.println("    " + t.name + " Time: " + time + " Count: " + count + " Avg: " + avg);
-        }
-    }
-
-    static public void reload() {
-        if (!Bukkit.getServer().getPluginManager().useTimings()) return;
-        for (CustomTimingsHandler t : allList) {
-            t.reset();
-        }
-    }
-
-    public void startTiming() {
-        if (!Bukkit.getServer().getPluginManager().useTimings()) return;
-        start = System.nanoTime();
-    }
-
-    public void stopTiming() {
-        if (!Bukkit.getServer().getPluginManager().useTimings()) return;
-        totalTime += System.nanoTime() - start;
-        count++;
-    }
-
-    public void reset() {
-        count = 0;
-        totalTime = 0;
-    }
-}
-
-- 
1.8.1.1

