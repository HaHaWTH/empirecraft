From e74115c301f0f46cff91cdaca52c7d261f47f2a4 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 10 Jan 2013 01:16:39 -0500
Subject: [PATCH] Make BlockFromToEvent default cancel if the flow would
 trigger a chunk load.

---
 src/main/java/org/bukkit/event/block/BlockFromToEvent.java | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/src/main/java/org/bukkit/event/block/BlockFromToEvent.java b/src/main/java/org/bukkit/event/block/BlockFromToEvent.java
index 70fd672..9c7482d 100644
--- a/src/main/java/org/bukkit/event/block/BlockFromToEvent.java
+++ b/src/main/java/org/bukkit/event/block/BlockFromToEvent.java
@@ -20,7 +20,11 @@ public class BlockFromToEvent extends BlockEvent implements Cancellable {
     public BlockFromToEvent(final Block block, final BlockFace face) {
         super(block);
         this.face = face;
-        this.cancel = false;
+        // EMC start- do not flow into unloaded chunks
+        int x = block.getX() + face.getModX();
+        int z = block.getZ() + face.getModZ();
+        this.cancel = !block.getWorld().isChunkLoaded(x >> 4, z >> 4);
+        // EMC end
     }
 
     public BlockFromToEvent(final Block block, final Block toBlock) {
@@ -45,6 +49,7 @@ public class BlockFromToEvent extends BlockEvent implements Cancellable {
      * @return The faced Block
      */
     public Block getToBlock() {
+        if (isCancelled()) { return getBlock(); } // EMC - it should be cancelled anyways, but prevent plugins still checking.
         if (to == null) {
             to = block.getRelative(face);
         }
-- 
1.8.1.1

