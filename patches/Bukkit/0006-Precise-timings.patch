From ef17ff96abf75b7fdd04d9befea9a92d6cef449e Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Sun, 26 May 2013 19:40:50 -0400
Subject: [PATCH] Precise timings

---
 .../org/bukkit/command/defaults/TimingsCommand.java   | 11 ++++++++---
 src/main/java/org/spigotmc/CustomTimingsHandler.java  | 19 +++++++++++++++----
 2 files changed, 23 insertions(+), 7 deletions(-)

diff --git a/src/main/java/org/bukkit/command/defaults/TimingsCommand.java b/src/main/java/org/bukkit/command/defaults/TimingsCommand.java
index ec1320f..cfabd2d 100644
--- a/src/main/java/org/bukkit/command/defaults/TimingsCommand.java
+++ b/src/main/java/org/bukkit/command/defaults/TimingsCommand.java
@@ -29,13 +29,14 @@ import java.util.logging.Level;
 // Spigot end
 
 public class TimingsCommand extends BukkitCommand {
-    private static final List<String> TIMINGS_SUBCOMMANDS = ImmutableList.of("merged", "reset", "separate");
+    private static final List<String> TIMINGS_SUBCOMMANDS = ImmutableList.of("merged", "reset", "separate", "paste", "on", "off", "precise"); // Spigot
     public static long timingStart = 0; // Spigot
+    public static boolean precise = false;
 
     public TimingsCommand(String name) {
         super(name);
         this.description = "Records timings for all plugin events";
-        this.usageMessage = "/timings <reset|merged|separate|on|off> [paste]"; // Spigot
+        this.usageMessage = "/timings <reset|merged|separate|on|off|precise> [paste]"; // Spigot
         this.setPermission("bukkit.command.timings");
     }
 
@@ -50,7 +51,11 @@ public class TimingsCommand extends BukkitCommand {
             sender.sendMessage("Please enable timings by setting \"settings.plugin-profiling\" to true in bukkit.yml");
             return true;
         }*/
-
+        if ("precise".equals(args[0])) {
+            precise = !precise;
+            sender.sendMessage("Timings Precise: " + precise);
+            return true;
+        }
         // Spigot start - dynamic enable
         if ( "on".equals( args[0] ) )
         {
diff --git a/src/main/java/org/spigotmc/CustomTimingsHandler.java b/src/main/java/org/spigotmc/CustomTimingsHandler.java
index 9fca481..047952e 100644
--- a/src/main/java/org/spigotmc/CustomTimingsHandler.java
+++ b/src/main/java/org/spigotmc/CustomTimingsHandler.java
@@ -1,5 +1,6 @@
 package org.spigotmc;
 
+import org.bukkit.command.defaults.TimingsCommand;
 import org.bukkit.event.HandlerList;
 import org.bukkit.plugin.Plugin;
 import org.bukkit.plugin.RegisteredListener;
@@ -21,6 +22,7 @@ public class CustomTimingsHandler
     /*========================================================================*/
     private final String name;
     private final CustomTimingsHandler parent;
+    private final boolean precise;
     private long count = 0;
     private long start = 0;
     private long timingDepth = 0;
@@ -28,15 +30,20 @@ public class CustomTimingsHandler
     private long curTickTotal = 0;
     private long violations = 0;
 
-    public CustomTimingsHandler(String name)
-    {
+    public CustomTimingsHandler(String name) {
         this( name, null );
     }
 
-    public CustomTimingsHandler(String name, CustomTimingsHandler parent)
-    {
+    public CustomTimingsHandler(String name, CustomTimingsHandler parent) {
+        this(name, parent, false);
+    }
+    public CustomTimingsHandler(String name, boolean precise) {
+        this(name, null, precise);
+    }
+    public CustomTimingsHandler(String name, CustomTimingsHandler parent, boolean precise) {
         this.name = name;
         this.parent = parent;
+        this.precise = precise;
         ALL_HANDLERS.add( this );
         BAKED_HANDLERS = ALL_HANDLERS.toArray( new CustomTimingsHandler[ ALL_HANDLERS.size() ] );
     }
@@ -131,6 +138,8 @@ public class CustomTimingsHandler
         // If second condtion fails we are already timing
         if ( Bukkit.getPluginManager().useTimings() && ++timingDepth == 1 )
         {
+            if (precise && !TimingsCommand.precise) return;
+
             start = System.nanoTime();
             if ( parent != null && ++parent.timingDepth == 1 )
             {
@@ -146,6 +155,8 @@ public class CustomTimingsHandler
     {
         if ( Bukkit.getPluginManager().useTimings() )
         {
+            if (precise && !TimingsCommand.precise) return;
+
             if ( --timingDepth != 0 || start == 0 )
             {
                 return;
-- 
1.8.4

