From c5faa92e5d5891676b98e5061bc02b39c57405f4 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Fri, 28 Feb 2014 22:25:04 -0500
Subject: [PATCH] Fire EntityTargetLivingEntityEvent for
 GoalNearestAttackableTarget

If cancelled, move to next in list
---
 .../server/PathfinderGoalNearestAttackableTarget.java      | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/PathfinderGoalNearestAttackableTarget.java b/src/main/java/net/minecraft/server/PathfinderGoalNearestAttackableTarget.java
index 8f939bc..a52d784 100644
--- a/src/main/java/net/minecraft/server/PathfinderGoalNearestAttackableTarget.java
+++ b/src/main/java/net/minecraft/server/PathfinderGoalNearestAttackableTarget.java
@@ -39,7 +39,19 @@ public class PathfinderGoalNearestAttackableTarget extends PathfinderGoalTarget
             if (list.isEmpty()) {
                 return false;
             } else {
-                this.g = (EntityLiving) list.get(0);
+                // EMC start
+                for (EntityLiving entity : ((List<EntityLiving>) list)) {
+                    if (org.bukkit.craftbukkit.event.CraftEventFactory
+                        .callEntityTargetLivingEvent(
+                            this.c,
+                            entity,
+                            org.bukkit.event.entity.EntityTargetEvent.TargetReason.CLOSEST_PLAYER).isCancelled()) {
+                        continue;
+                    }
+                    this.g = entity;
+                    break;
+                }
+                // EMC end
                 return true;
             }
         }
-- 
1.9.1

