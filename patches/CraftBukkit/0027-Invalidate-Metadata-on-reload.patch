From f59fd9a8a3b7a0c907ff10cdbec2d32535360d97 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Tue, 16 Jul 2013 20:45:12 -0400
Subject: [PATCH] Invalidate Metadata on reload

Metadata is not meant to persist reload as things break badly with non primitive types
This will invalidate metadata on reload so it does not crash everything if a plugin uses it.
---
 src/main/java/org/bukkit/craftbukkit/CraftServer.java | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index 8ace2b7..d692cb1 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -578,6 +578,13 @@ public final class CraftServer implements Server {
             }
             world.spigotConfig.init(); // Spigot
         }
+        // Spigot start
+        for (Plugin plugin : pluginManager.getPlugins()) {
+            entityMetadata.invalidateAll(plugin);
+            worldMetadata.invalidateAll(plugin);
+            playerMetadata.invalidateAll(plugin);
+        }
+        // Spigot end
 
         pluginManager.clearPlugins();
         commandMap.clearCommands();
-- 
1.8.3.2

