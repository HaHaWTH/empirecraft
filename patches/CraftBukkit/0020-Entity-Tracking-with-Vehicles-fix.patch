From b9c33b0dc56b0fbaeac20cef8c581c11de32704c Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Mon, 17 Jun 2013 01:24:00 -0400
Subject: [PATCH] Entity Tracking with Vehicles fix

If an entity untracks from a player while a vehicle/passenger, the rider can become frozen
and stop receiving updates correctly.

This patch makes it so passengers track the same way as their vehicle.
---
 src/main/java/net/minecraft/server/Entity.java      |  1 +
 .../net/minecraft/server/EntityTrackerEntry.java    | 21 ++++++++++++++++++++-
 2 files changed, 21 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/Entity.java b/src/main/java/net/minecraft/server/Entity.java
index 7ef6e03..0e01388 100644
--- a/src/main/java/net/minecraft/server/Entity.java
+++ b/src/main/java/net/minecraft/server/Entity.java
@@ -38,6 +38,7 @@ public abstract class Entity {
     static boolean isLevelAtLeast(NBTTagCompound tag, int level) {
         return tag.hasKey("Bukkit.updateLevel") && tag.getInt("Bukkit.updateLevel") >= level;
     }
+    EntityTrackerEntry tracker; // EMC
     // CraftBukkit end
 
     private static int entityCount;
diff --git a/src/main/java/net/minecraft/server/EntityTrackerEntry.java b/src/main/java/net/minecraft/server/EntityTrackerEntry.java
index aee38f5..e4126de 100644
--- a/src/main/java/net/minecraft/server/EntityTrackerEntry.java
+++ b/src/main/java/net/minecraft/server/EntityTrackerEntry.java
@@ -38,6 +38,7 @@ public class EntityTrackerEntry {
     public Set trackedPlayers = new HashSet();
 
     public EntityTrackerEntry(Entity entity, int i, int j, boolean flag) {
+        entity.tracker = this; // EMC
         this.tracker = entity;
         this.b = i;
         this.c = j;
@@ -297,7 +298,15 @@ public class EntityTrackerEntry {
             double d0 = entityplayer.locX - (double) (this.xLoc / 32);
             double d1 = entityplayer.locZ - (double) (this.zLoc / 32);
 
-            if (d0 >= (double) (-this.b) && d0 <= (double) this.b && d1 >= (double) (-this.b) && d1 <= (double) this.b) {
+            // EMC start
+            boolean parent = true;
+            boolean force = false;
+            if (tracker.vehicle != null) {
+                parent = tracker.vehicle.tracker != null && tracker.vehicle.tracker.trackedPlayers.contains(entityplayer);
+                force = true;
+            }
+            if (parent && (force || (d0 >= (double) (-this.b) && d0 <= (double) this.b && d1 >= (double) (-this.b) && d1 <= (double) this.b))) {
+            // EMC end
                 if (!this.trackedPlayers.contains(entityplayer) && (this.d(entityplayer) || this.tracker.p)) {
                     // CraftBukkit start
                     if (this.tracker instanceof EntityPlayer) {
@@ -311,6 +320,11 @@ public class EntityTrackerEntry {
                     // CraftBukkit end
 
                     this.trackedPlayers.add(entityplayer);
+                    // EMC start
+                    if (tracker.passenger != null && tracker.passenger.tracker != null) {
+                        tracker.passenger.tracker.updatePlayer(entityplayer);
+                    }
+                    // EMC end
                     Packet packet = this.c();
                     // EMC start - colored name tags
                     if (packet != null && packet instanceof Packet20NamedEntitySpawn && this.tracker instanceof EntityPlayer) {
@@ -387,6 +401,11 @@ public class EntityTrackerEntry {
                 }
             } else if (this.trackedPlayers.contains(entityplayer)) {
                 this.trackedPlayers.remove(entityplayer);
+                // EMC start
+                if (tracker.passenger != null && tracker.passenger.tracker != null) {
+                    tracker.passenger.tracker.updatePlayer(entityplayer);
+                }
+                // EMC end
                 entityplayer.playerConnection.sendPacket(new Packet29DestroyEntity(this.tracker.id)); // SportBukkit
             }
         }
-- 
1.8.3.2

