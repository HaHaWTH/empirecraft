From 23d041ae86aa14ea31f7ae41ae5ddd35a5425cea Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Tue, 8 Jul 2014 19:21:28 -0400
Subject: [PATCH] Revert Bukkit Damage API

---
 .../java/net/minecraft/server/EntityLiving.java    | 27 +++++++++++++++++-----
 1 file changed, 21 insertions(+), 6 deletions(-)

diff --git a/src/main/java/net/minecraft/server/EntityLiving.java b/src/main/java/net/minecraft/server/EntityLiving.java
index 41af741..1e9af1e 100644
--- a/src/main/java/net/minecraft/server/EntityLiving.java
+++ b/src/main/java/net/minecraft/server/EntityLiving.java
@@ -988,6 +988,16 @@ public abstract class EntityLiving extends Entity {
     // CraftBukkit start
     protected boolean d(DamageSource damagesource, float f) { // void -> boolean
         if (!this.isInvulnerable()) {
+            // EMC start - moved up from below to bring back old behavior.
+            EntityDamageEvent event = CraftEventFactory.handleLivingEntityDamageEvent(this, damagesource, f, 0, 0, 0, 0, 0, 0);
+
+            if (event.isCancelled()) {
+                return false;
+            }
+
+            f = (float) event.getDamage();
+            // EMC end
+
             boolean human = this instanceof EntityHuman;
             float originalDamage = f;
             float preDamage = f;
@@ -1027,13 +1037,18 @@ public abstract class EntityLiving extends Entity {
             f = Math.max(f - this.br(), 0.0F);
             float absorptionModifier = Math.max(f1 - f, 0.0F);
 
-            EntityDamageEvent event = CraftEventFactory.handleLivingEntityDamageEvent(this, damagesource, originalDamage, -hardHatModifier, -blockingModifier, -armorModifier, -resistanceModifier, -magicModifier, -absorptionModifier);
-
-            if (event.isCancelled()) {
-                return false;
+            // EMC start - Moved event call up
+            event.setDamage(DamageModifier.ARMOR,      -armorModifier);
+            if (damagesource == DamageSource.FALLING_BLOCK || damagesource == DamageSource.ANVIL) {
+                event.setDamage(DamageModifier.HARD_HAT, -hardHatModifier);
             }
-
-            f = (float) event.getFinalDamage();
+            if (human) {
+                event.setDamage(DamageModifier.BLOCKING, -blockingModifier);
+            }
+            event.setDamage(DamageModifier.RESISTANCE, -resistanceModifier);
+            event.setDamage(DamageModifier.MAGIC,      -magicModifier);
+            event.setDamage(DamageModifier.ABSORPTION, -absorptionModifier);
+            // EMC end
 
             // Apply damage to helmet
             if ((damagesource == DamageSource.ANVIL || damagesource == DamageSource.FALLING_BLOCK) && this.getEquipment(4) != null) {
-- 
1.9.1

