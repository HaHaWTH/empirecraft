From 19669e774feb53d7589f4f0b23e2638d937aaffe Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Mon, 31 Dec 2012 01:25:46 -0500
Subject: [PATCH] EMC Anvil Tweaks

Make Items not have a repair cost increase due to Anvil usage. Renaming is only 5 levels, combines include free renames.
---
 src/main/java/net/minecraft/server/ContainerAnvil.java | 5 ++++-
 src/main/java/net/minecraft/server/ItemStack.java      | 7 +++++++
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/ContainerAnvil.java b/src/main/java/net/minecraft/server/ContainerAnvil.java
index 328db44..c35e74c 100644
--- a/src/main/java/net/minecraft/server/ContainerAnvil.java
+++ b/src/main/java/net/minecraft/server/ContainerAnvil.java
@@ -268,8 +268,11 @@ public class ContainerAnvil extends Container {
                 this.a = 39;
             }
 
+            if (j == i && j > 0) { this.a = 5; } // EMC - renames only cost 5 levels.
+            else if (j > 0) { this.a -= j; }     // EMC - Free renames on combining
+
             if (this.a >= 40 && !this.n.abilities.canInstantlyBuild) {
-                itemstack1 = null;
+                //itemstack1 = null; // EMC - no level restriction
             }
 
             if (itemstack1 != null) {
diff --git a/src/main/java/net/minecraft/server/ItemStack.java b/src/main/java/net/minecraft/server/ItemStack.java
index 049d89f..cc3ce57 100644
--- a/src/main/java/net/minecraft/server/ItemStack.java
+++ b/src/main/java/net/minecraft/server/ItemStack.java
@@ -109,6 +109,12 @@ public final class ItemStack {
         if (nbttagcompound.hasKey("tag")) {
             // CraftBukkit - clear name from compound and make defensive copy as this data may be coming from the save thread
             this.tag = (NBTTagCompound) nbttagcompound.getCompound("tag").clone().setName("");
+
+            
+            // EMC - No repair cost on EMC.
+            if (this.tag.hasKey("RepairCost")) {
+                this.tag.setInt("RepairCost", 0);
+            }
         }
     }
 
@@ -391,6 +397,7 @@ public final class ItemStack {
     }
 
     public void setRepairCost(int i) {
+        i = 0; // EMC - no repair cost increases for EMC.
         if (!this.hasTag()) {
             this.tag = new NBTTagCompound();
         }
-- 
1.8.1.5

