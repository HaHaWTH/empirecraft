From f7be44c600ecb3dc15ba3fb1c9157028b732decf Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Wed, 5 Jun 2013 23:42:49 -0400
Subject: [PATCH] Fix Breeding issues with EAR

---
 src/main/java/net/minecraft/server/Entity.java     |  1 +
 .../java/net/minecraft/server/EntityAgeable.java   | 17 ++++++++++
 .../java/net/minecraft/server/EntityLiving.java    |  6 ++++
 src/main/java/net/minecraft/server/World.java      |  1 +
 src/main/java/org/bukkit/craftbukkit/Spigot.java   | 37 +++-------------------
 5 files changed, 30 insertions(+), 32 deletions(-)

diff --git a/src/main/java/net/minecraft/server/Entity.java b/src/main/java/net/minecraft/server/Entity.java
index 26aebf5..04f4838 100644
--- a/src/main/java/net/minecraft/server/Entity.java
+++ b/src/main/java/net/minecraft/server/Entity.java
@@ -118,6 +118,7 @@ public abstract class Entity {
     public final byte activationType = org.bukkit.craftbukkit.Spigot.initializeEntityActivationType(this);
     public final boolean defaultActivationState;
     public long activatedTick = 0;
+    public void inactiveTick() { }
     // Spigot end
 
     public Entity(World world) {
diff --git a/src/main/java/net/minecraft/server/EntityAgeable.java b/src/main/java/net/minecraft/server/EntityAgeable.java
index fdc9167..82e3978 100644
--- a/src/main/java/net/minecraft/server/EntityAgeable.java
+++ b/src/main/java/net/minecraft/server/EntityAgeable.java
@@ -5,7 +5,24 @@ public abstract class EntityAgeable extends EntityCreature {
     private float d = -1.0F;
     private float e;
     public boolean ageLocked = false; // CraftBukkit
+    // Spigot start
+    public void inactiveTick() {
+        super.inactiveTick();
+        if (this.world.isStatic || this.ageLocked) { // CraftBukkit
+            this.a(this.isBaby());
+        } else {
+            int i = this.getAge();
 
+            if (i < 0) {
+                ++i;
+                this.setAge(i);
+            } else if (i > 0) {
+                --i;
+                this.setAge(i);
+            }
+        }
+    }
+    // Spigot end
     public EntityAgeable(World world) {
         super(world);
     }
diff --git a/src/main/java/net/minecraft/server/EntityLiving.java b/src/main/java/net/minecraft/server/EntityLiving.java
index ba8564e..7b11247 100644
--- a/src/main/java/net/minecraft/server/EntityLiving.java
+++ b/src/main/java/net/minecraft/server/EntityLiving.java
@@ -112,6 +112,12 @@ public abstract class EntityLiving extends Entity {
     public int expToDrop = 0;
     public int maxAirTicks = 300;
     public int maxHealth = this.getMaxHealth();
+    // Spigot start
+    public void inactiveTick() {
+        super.inactiveTick();
+        ++this.bC;
+    }
+    // Spigot end
     // CraftBukkit end
 
     public EntityLiving(World world) {
diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index 484c841..9a75778 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -1442,6 +1442,7 @@ public abstract class World implements IBlockAccess {
         // Spigot start
         if (!Spigot.checkIfActive(entity)) {
             entity.ticksLived++;
+            entity.inactiveTick();
         } else {
             entity.tickTimer.startTiming();
             // Spigot end
diff --git a/src/main/java/org/bukkit/craftbukkit/Spigot.java b/src/main/java/org/bukkit/craftbukkit/Spigot.java
index 2f4dcd9..20bc035 100644
--- a/src/main/java/org/bukkit/craftbukkit/Spigot.java
+++ b/src/main/java/org/bukkit/craftbukkit/Spigot.java
@@ -7,38 +7,8 @@ import java.util.ArrayList;
 import java.util.List;
 import java.util.logging.Level;
 import java.util.regex.Pattern;
-import net.minecraft.server.AxisAlignedBB;
-import net.minecraft.server.Chunk;
-import net.minecraft.server.Entity;
-import net.minecraft.server.EntityAmbient;
-import net.minecraft.server.EntityAnimal;
-import net.minecraft.server.EntityArrow;
-import net.minecraft.server.EntityComplexPart;
-import net.minecraft.server.EntityCreature;
-import net.minecraft.server.EntityEnderCrystal;
-import net.minecraft.server.EntityEnderDragon;
-import net.minecraft.server.EntityExperienceOrb;
-import net.minecraft.server.EntityFireball;
-import net.minecraft.server.EntityFireworks;
-import net.minecraft.server.EntityGhast;
-import net.minecraft.server.EntityHuman;
-import net.minecraft.server.EntityItem;
-import net.minecraft.server.EntityItemFrame;
-import net.minecraft.server.EntityLiving;
-import net.minecraft.server.EntityMonster;
-import net.minecraft.server.EntityPainting;
-import net.minecraft.server.EntityPlayer;
-import net.minecraft.server.EntityProjectile;
-import net.minecraft.server.EntitySheep;
-import net.minecraft.server.EntitySlime;
-import net.minecraft.server.EntityTNTPrimed;
-import net.minecraft.server.EntityWeather;
-import net.minecraft.server.EntityWither;
-import net.minecraft.server.MathHelper;
-import net.minecraft.server.MinecraftServer;
-import net.minecraft.server.Packet255KickDisconnect;
-import net.minecraft.server.PendingConnection;
-import net.minecraft.server.World;
+
+import net.minecraft.server.*;
 import org.bukkit.Bukkit;
 import org.bukkit.command.SimpleCommandMap;
 import org.bukkit.configuration.file.YamlConfiguration;
@@ -274,6 +244,9 @@ public class Spigot {
             if (entity instanceof EntityCreature && ((EntityCreature) entity).target != null) {
                 return true;
             }
+            if (entity instanceof EntityVillager && ((EntityVillager) entity).n()) {
+                return true;
+            }
             if (entity instanceof EntityAnimal) {
                 EntityAnimal animal = (EntityAnimal) entity;
                 if (animal.isBaby() || animal.r() /*love*/) {
-- 
1.8.3

