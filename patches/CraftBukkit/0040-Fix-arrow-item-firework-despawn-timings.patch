From 0a5fa307177d356cf8667db366741353d6d6f438 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Fri, 10 Jan 2014 19:21:31 -0500
Subject: [PATCH] Fix arrow/item/firework despawn timings

If Inactive tick, bump counters
---
 src/main/java/net/minecraft/server/EntityArrow.java     | 12 +++++++++++-
 src/main/java/net/minecraft/server/EntityFireworks.java |  8 ++++++++
 src/main/java/net/minecraft/server/EntityItem.java      |  8 ++++++++
 3 files changed, 27 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/EntityArrow.java b/src/main/java/net/minecraft/server/EntityArrow.java
index 8ba2d67..511e8d3 100644
--- a/src/main/java/net/minecraft/server/EntityArrow.java
+++ b/src/main/java/net/minecraft/server/EntityArrow.java
@@ -19,6 +19,16 @@ public class EntityArrow extends Entity implements IProjectile {
     public int fromPlayer;
     public int shake;
     public Entity shooter;
+    // Spigot Start
+    @Override
+    public void inactiveTick() {
+        if (this.inGround) {
+            this.j += 19;
+        }
+        super.inactiveTick();
+    }
+    // Make sure this increments the despawn counter if conflict here
+    // Spigot End
     private int j;
     private int au;
     private double damage = 2.0D;
@@ -142,7 +152,7 @@ public class EntityArrow extends Entity implements IProjectile {
 
             if (block == this.g && i == this.h) {
                 ++this.j;
-                if (this.j == world.spigotConfig.arrowDespawnRate) { // Spigot
+                if (this.j >= world.spigotConfig.arrowDespawnRate) { // Spigot
                     this.die();
                 }
             } else {
diff --git a/src/main/java/net/minecraft/server/EntityFireworks.java b/src/main/java/net/minecraft/server/EntityFireworks.java
index 261262e..40f6d62 100644
--- a/src/main/java/net/minecraft/server/EntityFireworks.java
+++ b/src/main/java/net/minecraft/server/EntityFireworks.java
@@ -5,6 +5,14 @@ public class EntityFireworks extends Entity {
     private int ticksFlown;
     public int expectedLifespan; // CraftBukkit - private -> public
 
+    // Spigot Start
+    @Override
+    public void inactiveTick() {
+        this.ticksFlown += 19;
+        super.inactiveTick();
+    }
+    // Spigot End
+
     public EntityFireworks(World world) {
         super(world);
         this.a(0.25F, 0.25F);
diff --git a/src/main/java/net/minecraft/server/EntityItem.java b/src/main/java/net/minecraft/server/EntityItem.java
index 8ea7abc..e9106e5 100644
--- a/src/main/java/net/minecraft/server/EntityItem.java
+++ b/src/main/java/net/minecraft/server/EntityItem.java
@@ -18,6 +18,14 @@ public class EntityItem extends Entity {
     public float c;
     private int lastTick = MinecraftServer.currentTick; // CraftBukkit
 
+    // Spigot Start - Bump age for skipped ticks
+    @Override
+    public void inactiveTick() {
+        this.age += 19;
+        super.inactiveTick();
+    }
+    // Spigot End
+
     public EntityItem(World world, double d0, double d1, double d2) {
         super(world);
         this.e = 5;
-- 
1.8.3.2

