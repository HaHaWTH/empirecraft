From e714264e99e55e0087806a8bc83e795228e78050 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Sun, 14 Sep 2014 23:46:32 -0400
Subject: [PATCH] Improve Network Manager packet handling

Removes an unnecessary "peek at head of queue", and also makes the number of packets
processed per player per tick configurable, so larger servers can slow down incoming processing.
---
 src/main/java/net/minecraft/server/NetworkManager.java | 8 ++++----
 src/main/java/org/spigotmc/SpigotConfig.java           | 5 +++++
 2 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/src/main/java/net/minecraft/server/NetworkManager.java b/src/main/java/net/minecraft/server/NetworkManager.java
index 068f82f..4506494 100644
--- a/src/main/java/net/minecraft/server/NetworkManager.java
+++ b/src/main/java/net/minecraft/server/NetworkManager.java
@@ -155,8 +155,8 @@ public class NetworkManager extends SimpleChannelInboundHandler {
 
     private void i() {
         if (this.m != null && this.m.isOpen()) {
-            while (!this.l.isEmpty()) {
-                QueuedPacket queuedpacket = (QueuedPacket) this.l.poll();
+            QueuedPacket queuedpacket; // Spigot
+            while ((queuedpacket = (QueuedPacket) this.l.poll()) != null) { // Spigot
 
                 this.b(QueuedPacket.a(queuedpacket), QueuedPacket.b(queuedpacket));
             }
@@ -176,8 +176,8 @@ public class NetworkManager extends SimpleChannelInboundHandler {
         }
 
         if (this.o != null) {
-            for (int i = 1000; !this.k.isEmpty() && i >= 0; --i) {
-                Packet packet = (Packet) this.k.poll();
+            Packet packet; // Spigot
+            for (int i = org.spigotmc.SpigotConfig.maxPacketsPerPlayer; (packet = (Packet) this.k.poll()) != null && i >= 0; --i) { // Spigot
 
                 // CraftBukkit start
                 if (!this.isConnected() || !this.m.config().isAutoRead()) {
diff --git a/src/main/java/org/spigotmc/SpigotConfig.java b/src/main/java/org/spigotmc/SpigotConfig.java
index 87017b4..aee93cd 100644
--- a/src/main/java/org/spigotmc/SpigotConfig.java
+++ b/src/main/java/org/spigotmc/SpigotConfig.java
@@ -401,4 +401,9 @@ public class SpigotConfig
             Bukkit.getLogger().info( "Debug logging is disabled" );
         }
     }
+
+    public static int maxPacketsPerPlayer;
+    private static void maxPacketsPerPlayer() {
+        maxPacketsPerPlayer = getInt("max-packets-per-player", 1000);
+    }
 }
-- 
1.9.1

