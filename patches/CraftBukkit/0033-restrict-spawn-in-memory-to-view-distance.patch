From e19f964549261e870712f9976f121af0d9bc15d0 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Wed, 24 Jul 2013 22:29:18 -0400
Subject: [PATCH] restrict spawn in memory to view distance

---
 src/main/java/net/minecraft/server/MinecraftServer.java | 5 +++--
 src/main/java/org/bukkit/craftbukkit/CraftServer.java   | 2 +-
 2 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index e6900b4..06c0847 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -279,8 +279,9 @@ public abstract class MinecraftServer implements ICommandListener, Runnable, IMo
             long j = aq();
             i = 0;
 
-            for (int k = -192; k <= 192 && this.isRunning(); k += 16) {
-                for (int l = -192; l <= 192 && this.isRunning(); l += 16) {
+            int view = worldserver.spigotConfig.viewDistance * 16; // Spigot
+            for (int k = -view; k <= view && this.isRunning(); k += 16) { // Spigot
+                for (int l = -view; l <= view && this.isRunning(); l += 16) { // Spigot
                     long i1 = aq();
 
                     if (i1 - j > 1000L) {
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index d692cb1..2735352 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -753,7 +753,7 @@ public final class CraftServer implements Server {
         System.out.print("Preparing start region for level " + (console.worlds.size() - 1) + " (Seed: " + internal.getSeed() + ")");
 
         if (internal.getWorld().getKeepSpawnInMemory()) {
-            short short1 = 196;
+            short short1 = (short) (internal.spigotConfig.viewDistance * 16); // Spigot
             long i = System.currentTimeMillis();
             for (int j = -short1; j <= short1; j += 16) {
                 for (int k = -short1; k <= short1; k += 16) {
-- 
1.8.3.4

