From 6ea17bf9e1326a1c72aeaf23666c49e06c710d11 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Fri, 18 Jan 2013 18:58:25 -0500
Subject: [PATCH] Entity Activation range check

---
 src/main/java/net/minecraft/server/Entity.java      |  9 +++++++++
 .../java/net/minecraft/server/EntityLiving.java     |  1 +
 src/main/java/net/minecraft/server/World.java       |  1 +
 .../java/org/bukkit/craftbukkit/CraftWorld.java     |  8 +++++++-
 src/main/java/org/bukkit/craftbukkit/Spigot.java    | 21 +++++++++++++++++++++
 src/main/resources/configurations/bukkit.yml        |  1 +
 6 files changed, 40 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/Entity.java b/src/main/java/net/minecraft/server/Entity.java
index 2340fad..0b131d8 100644
--- a/src/main/java/net/minecraft/server/Entity.java
+++ b/src/main/java/net/minecraft/server/Entity.java
@@ -110,6 +110,14 @@ public abstract class Entity {
     public EnumEntitySize as;
     public UUID uniqueId = UUID.randomUUID(); // CraftBukkit
     public boolean valid = false; // CraftBukkit
+    // Spigot start
+    public boolean inWater = false;
+    public boolean isActivated = true;
+
+    public boolean isActivated() {
+        return isActivated || world.getWorld().entityActivationRange == 0 || this instanceof EntityPlayer || this.ticksLived % 20 == 0 || !this.onGround || this.inWater;
+    }
+    // Spigot end
 
     public Entity(World world) {
         this.id = entityCount++;
@@ -862,6 +870,7 @@ public abstract class Entity {
             this.ad = false;
         }
 
+        this.inWater = this.ad; // Spigot
         return this.ad;
     }
 
diff --git a/src/main/java/net/minecraft/server/EntityLiving.java b/src/main/java/net/minecraft/server/EntityLiving.java
index d33cfb4..6466f5d 100644
--- a/src/main/java/net/minecraft/server/EntityLiving.java
+++ b/src/main/java/net/minecraft/server/EntityLiving.java
@@ -1241,6 +1241,7 @@ public abstract class EntityLiving extends Entity {
     }
 
     public void c() {
+        if (!this.isActivated()) { return; } // Spigot
         timerEntityAI.startTiming(); // Spigot
         if (this.bV > 0) {
             --this.bV;
diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index cd7ad64..fa46c4e 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -1241,6 +1241,7 @@ public abstract class World implements IBlockAccess {
         this.methodProfiler.c("regular");
         timings.entityBaseTick.stopTiming(); // Spigot
 
+        org.bukkit.craftbukkit.Spigot.activateEntities(this); // Spigot
         timings.entityTick.startTiming(); // Spigot
         for (i = 0; i < this.entityList.size(); ++i) {
             entity = (Entity) this.entityList.get(i);
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
index 21bd64a..2636ed4 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
@@ -100,10 +100,12 @@ public class CraftWorld implements World {
         treeGrowthModifier = configuration.getInt("world-settings.default.tree-growth-modifier", treeGrowthModifier);
         mushroomGrowthModifier = configuration.getInt("world-settings.default.mushroom-growth-modifier", mushroomGrowthModifier);
 
+        entityActivationRange = configuration.getInt("world-settings.default.entity-activation-range", entityActivationRange);
+
         //override defaults with world specific, if they exist
         growthPerTick = configuration.getInt("world-settings." + name + ".growth-chunks-per-tick", growthPerTick);
         itemMergeRadius = configuration.getDouble("world-settings." + name + ".item-merge-radius", itemMergeRadius);
-      expMergeRadius = configuration.getDouble("world-settings." + name + ".exp-merge-radius", expMergeRadius);
+        expMergeRadius = configuration.getDouble("world-settings." + name + ".exp-merge-radius", expMergeRadius);
         randomLightingUpdates = configuration.getBoolean("world-settings." + name + ".random-light-updates", randomLightingUpdates);
         mobSpawnRange = configuration.getInt("world-settings." + name + ".mob-spawn-range", mobSpawnRange);
         aggregateTicks = Math.max(1, configuration.getInt("world-settings." + name + ".aggregate-chunkticks", aggregateTicks));
@@ -120,6 +122,7 @@ public class CraftWorld implements World {
         viewDistance = configuration.getInt("world-settings." + name + ".view-distance", viewDistance);
 
         obfuscated = !world.getServer().orebfuscatorDisabledWorlds.contains(name);
+        entityActivationRange = configuration.getInt("world-settings." + name + ".entity-activation-range", entityActivationRange);
 
         server.getLogger().info("-------------- Spigot ----------------");
         server.getLogger().info("-------- World Settings For [" + name + "] --------");
@@ -138,6 +141,7 @@ public class CraftWorld implements World {
         server.getLogger().info("Mushroom Growth Modifier: " + mushroomGrowthModifier);
         server.getLogger().info("View distance: " + viewDistance);
         server.getLogger().info("Oreobfuscator: " + obfuscated);
+        server.getLogger().info("Entity Activation Range: " + entityActivationRange);
         server.getLogger().info("-------------------------------------------------");
         // Spigot end
     }
@@ -158,6 +162,8 @@ public class CraftWorld implements World {
     public int sugarGrowthModifier = 100;
     public int treeGrowthModifier = 100;
     public int mushroomGrowthModifier = 100;
+
+    public int entityActivationRange = 0;
     // Spigot end
 
     public Block getBlockAt(int x, int y, int z) {
diff --git a/src/main/java/org/bukkit/craftbukkit/Spigot.java b/src/main/java/org/bukkit/craftbukkit/Spigot.java
index 83988c3..1f511ef 100644
--- a/src/main/java/org/bukkit/craftbukkit/Spigot.java
+++ b/src/main/java/org/bukkit/craftbukkit/Spigot.java
@@ -1,8 +1,12 @@
 package org.bukkit.craftbukkit;
 
+import net.minecraft.server.Entity;
+import net.minecraft.server.World;
 import org.bukkit.command.SimpleCommandMap;
 import org.bukkit.configuration.file.YamlConfiguration;
 
+import java.util.List;
+
 public class Spigot {
     public static void initialize(CraftServer server, SimpleCommandMap commandMap, YamlConfiguration configuration) {
         commandMap.register("bukkit", new org.bukkit.craftbukkit.command.RestartCommand("restart"));
@@ -33,4 +37,21 @@ public class Spigot {
             server.chunkGCPeriod = 600;
         }
     }
+
+    public static void activateEntities(World world) {
+        int activationRange = world.getWorld().entityActivationRange;
+        if (activationRange == 0) {
+            return;
+        }
+        for (Entity entity : (List<Entity>) world.entityList) {
+            entity.isActivated = false;
+        }
+
+        for (Entity player : (List<Entity>) world.players) {
+            List<Entity> list = world.getEntities(player, player.boundingBox.grow(activationRange, 256, activationRange));
+            for (Entity entity : list) {
+                entity.isActivated  = true;
+            }
+        }
+    }
 }
diff --git a/src/main/resources/configurations/bukkit.yml b/src/main/resources/configurations/bukkit.yml
index 6931712..a22c6d2 100644
--- a/src/main/resources/configurations/bukkit.yml
+++ b/src/main/resources/configurations/bukkit.yml
@@ -49,6 +49,7 @@ world-settings:
         sugar-growth-modifier: 100
         tree-growth-modifier: 100
         mushroom-growth-modifier: 100
+        entity-activation-range: 0
     world:
         growth-chunks-per-tick: 1000
     world_nether:
-- 
1.8.1.1

