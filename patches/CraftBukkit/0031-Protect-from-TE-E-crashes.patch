From cdaf2cc532eac9160c741af1cc5d1464754432bb Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Wed, 3 Jul 2013 08:29:26 -0400
Subject: [PATCH] Protect from TE/E crashes

---
 src/main/java/net/minecraft/server/TileEntity.java |  3 +++
 src/main/java/net/minecraft/server/World.java      | 17 +++++++++++++++++
 2 files changed, 20 insertions(+)

diff --git a/src/main/java/net/minecraft/server/TileEntity.java b/src/main/java/net/minecraft/server/TileEntity.java
index 3de32fe..a59feaa 100644
--- a/src/main/java/net/minecraft/server/TileEntity.java
+++ b/src/main/java/net/minecraft/server/TileEntity.java
@@ -143,7 +143,10 @@ public class TileEntity {
 
     public void a(CrashReportSystemDetails crashreportsystemdetails) {
         crashreportsystemdetails.a("Name", (Callable) (new CrashReportTileEntityName(this)));
+        Block block = this.q(); // EMC
+        if (block != null) { // EMC
         CrashReportSystemDetails.a(crashreportsystemdetails, this.x, this.y, this.z, this.q(), this.p());
+        } // EMC
         crashreportsystemdetails.a("Actual block type", (Callable) (new CrashReportTileEntityType(this)));
         crashreportsystemdetails.a("Actual block data value", (Callable) (new CrashReportTileEntityData(this)));
     }
diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index dcf9aa1..f0ca6d4 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -1321,10 +1321,19 @@ public abstract class World implements IBlockAccess {
                     this.playerJoinedWorld(entity);
                     SpigotTimings.tickEntityTimer.stopTiming(); // Spigot
                 } catch (Throwable throwable1) {
+                    // EMC start
+                    SpigotTimings.tickEntityTimer.stopTiming(); // Spigot
+                    System.err.println("Entity threw exception at " + entity.world.getWorld().getName()+":"+entity.locX +"," + entity.locY+","+entity.locZ);
+                    throwable1.printStackTrace();
+                    entity.dead = true;
+                    continue;
+                    /*
                     crashreport = CrashReport.a(throwable1, "Ticking entity");
                     crashreportsystemdetails = crashreport.a("Entity being ticked");
                     entity.a(crashreportsystemdetails);
                     throw new ReportedException(crashreport);
+                    */
+                    // EMC end
                 }
             }
 
@@ -1375,11 +1384,19 @@ public abstract class World implements IBlockAccess {
                     tileentity.h();
                     tileentity.tickTimer.stopTiming(); // Spigot
                 } catch (Throwable throwable2) {
+                    // EMC start
                     tileentity.tickTimer.stopTiming(); // Spigot
+                    System.err.println("TileEntity threw exception at " + tileentity.world.getWorld().getName()+":"+tileentity.x +"," + tileentity.y+","+tileentity.z);
+                    throwable2.printStackTrace();
+                    iterator.remove();
+                    continue;
+                    /*
                     crashreport = CrashReport.a(throwable2, "Ticking block entity");
                     crashreportsystemdetails = crashreport.a("Block entity being ticked");
                     tileentity.a(crashreportsystemdetails);
                     throw new ReportedException(crashreport);
+                    */
+                    // EMC end
                 }
             }
 
-- 
1.8.3.2

