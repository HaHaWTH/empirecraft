From d53146b7a045cec8f89ae13b4186c235bbb1a349 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Mon, 31 Mar 2014 19:28:25 -0400
Subject: [PATCH] Properly clean up tile entities

Prevents weird behavior
---
 src/main/java/net/minecraft/server/World.java | 16 ++++++++++++----
 1 file changed, 12 insertions(+), 4 deletions(-)

diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index 7aa28aa..4fffbb4 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -1373,6 +1373,12 @@ public abstract class World implements IBlockAccess {
 
         timings.entityTick.stopTiming(); // Spigot
         this.methodProfiler.c("blockEntities");
+        // EMC start - clean up TE's before ticking them.
+        if (!this.b.isEmpty()) {
+            this.tileEntityList.removeAll(this.b);
+            this.b.clear();
+        }
+        // EMC end
         timings.tileEntityTick.startTiming(); // Spigot
         this.N = true;
         Iterator iterator = this.tileEntityList.iterator();
@@ -1430,10 +1436,12 @@ public abstract class World implements IBlockAccess {
         timings.tileEntityTick.stopTiming(); // Spigot
         timings.tileEntityPending.startTiming(); // Spigot
         this.N = false;
-        if (!this.b.isEmpty()) {
-            this.tileEntityList.removeAll(this.b);
-            this.b.clear();
-        }
+        // EMC start - moved up
+//        if (!this.b.isEmpty()) {
+//            this.tileEntityList.removeAll(this.b);
+//            this.b.clear();
+//        }
+        // EMC end
 
         this.methodProfiler.c("pendingBlockEntities");
         if (!this.a.isEmpty()) {
-- 
1.8.3.2

