From e6b6ac79bce3a819c47f84f46c8c4313ba136948 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 25 Jul 2013 23:08:50 -0400
Subject: [PATCH] Improvements to Player lookup - Resolves BUKKIT-4608

Here is the rest of my changes that someone decided to remove for no reason at all...
---
 src/main/java/org/bukkit/craftbukkit/CraftServer.java | 17 ++++++++++-------
 1 file changed, 10 insertions(+), 7 deletions(-)

diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index cdcf861..cac5827 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -508,12 +508,12 @@ public final class CraftServer implements Server {
             return directLookup;
         }
         // Spigot End
-        Player[] players = getOnlinePlayers();
 
         Player found = null;
         String lowerName = name.toLowerCase();
         int delta = Integer.MAX_VALUE;
-        for (Player player : players) {
+        for (EntityPlayer entityPlayer : (List<EntityPlayer>) playerList.players) {
+            Player player = entityPlayer.playerConnection.getPlayer();
             if (player.getName().toLowerCase().startsWith(lowerName)) {
                 int curDelta = player.getName().length() - lowerName.length();
                 if (curDelta < delta) {
@@ -548,7 +548,8 @@ public final class CraftServer implements Server {
 
         List<Player> matchedPlayers = new ArrayList<Player>();
 
-        for (Player iterPlayer : this.getOnlinePlayers()) {
+        for (EntityPlayer entityPlayer : (List<EntityPlayer>) playerList.players) {
+            Player iterPlayer = entityPlayer.getBukkitEntity();
             String iterPlayerName = iterPlayer.getName();
 
             if (partialName.equalsIgnoreCase(iterPlayerName)) {
@@ -1488,7 +1489,8 @@ public final class CraftServer implements Server {
     public void sendPluginMessage(Plugin source, String channel, byte[] message) {
         StandardMessenger.validatePluginMessage(getMessenger(), source, channel, message);
 
-        for (Player player : getOnlinePlayers()) {
+        for (EntityPlayer entityPlayer : (List<EntityPlayer>) playerList.players) {
+            Player player = entityPlayer.getBukkitEntity();
             player.sendPluginMessage(source, channel, message);
         }
     }
@@ -1496,7 +1498,8 @@ public final class CraftServer implements Server {
     public Set<String> getListeningPluginChannels() {
         Set<String> result = new HashSet<String>();
 
-        for (Player player : getOnlinePlayers()) {
+        for (EntityPlayer entityPlayer : (List<EntityPlayer>) playerList.players) {
+            Player player = entityPlayer.getBukkitEntity();
             result.addAll(player.getListeningPluginChannels());
         }
 
@@ -1597,11 +1600,11 @@ public final class CraftServer implements Server {
     }
 
     public List<String> tabCompleteChat(Player player, String message) {
-        Player[] players = getOnlinePlayers();
         List<String> completions = new ArrayList<String>();
         PlayerChatTabCompleteEvent event = new PlayerChatTabCompleteEvent(player, message, completions);
         String token = event.getLastToken();
-        for (Player p : players) {
+        for (EntityPlayer entityPlayer : (List<EntityPlayer>) playerList.players) {
+            Player p = entityPlayer.getBukkitEntity();
             if (player.canSee(p) && StringUtil.startsWithIgnoreCase(p.getName(), token)) {
                 completions.add(p.getName());
             }
-- 
1.8.3.2

