From dfbe81acb4aeca9eab36be3f7d2a1f3deebbc8ae Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Wed, 3 Jul 2013 08:29:26 -0400
Subject: [PATCH] Protect from tile entity crash

---
 src/main/java/net/minecraft/server/TileEntity.java | 7 ++++++-
 src/main/java/net/minecraft/server/World.java      | 5 ++++-
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/src/main/java/net/minecraft/server/TileEntity.java b/src/main/java/net/minecraft/server/TileEntity.java
index 6ae7cb3..8f470d2 100644
--- a/src/main/java/net/minecraft/server/TileEntity.java
+++ b/src/main/java/net/minecraft/server/TileEntity.java
@@ -139,7 +139,12 @@ public class TileEntity {
 
     public void a(CrashReportSystemDetails crashreportsystemdetails) {
         crashreportsystemdetails.a("Name", (Callable) (new CrashReportTileEntityName(this)));
-        CrashReportSystemDetails.a(crashreportsystemdetails, this.x, this.y, this.z, this.q().id, this.p());
+	    Block block = this.q(); // EMC
+	    if (block != null) { // EMC
+            CrashReportSystemDetails.a(crashreportsystemdetails, this.x, this.y, this.z, this.q().id, this.p());
+	    } else {
+		    System.err.println("TileEntity crash but null block: " + this.x +":" + this.y+":"+ this.z +" - " + this.world.getTypeId(this.x, this.y, this.z)); // EMC
+	    }
         crashreportsystemdetails.a("Actual block type", (Callable) (new CrashReportTileEntityType(this)));
         crashreportsystemdetails.a("Actual block data value", (Callable) (new CrashReportTileEntityData(this)));
     }
diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index f4c0f2c..8ae330a 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -1361,7 +1361,10 @@ public abstract class World implements IBlockAccess {
                     crashreport = CrashReport.a(throwable2, "Ticking tile entity");
                     crashreportsystemdetails = crashreport.a("Tile entity being ticked");
                     tileentity.a(crashreportsystemdetails);
-                    throw new ReportedException(crashreport);
+	                throwable2.printStackTrace(); // EMC
+	                iterator.remove(); // EMC
+	                continue; // EMC
+                    //throw new ReportedException(crashreport); // EMC
                 }
             }
 
-- 
1.8.3.2

