From 85becd6d3a30290705ff0b2c2cfb83bc0a5f0bcb Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Mon, 9 Sep 2013 19:41:07 -0400
Subject: [PATCH] Better hopper events

---
 .../empireminecraft/customevents/HopperEvents.java | 87 ++++++++++++++++++++++
 .../net/minecraft/server/TileEntityHopper.java     |  5 ++
 2 files changed, 92 insertions(+)
 create mode 100644 src/main/java/com/empireminecraft/customevents/HopperEvents.java

diff --git a/src/main/java/com/empireminecraft/customevents/HopperEvents.java b/src/main/java/com/empireminecraft/customevents/HopperEvents.java
new file mode 100644
index 0000000..ac26131
--- /dev/null
+++ b/src/main/java/com/empireminecraft/customevents/HopperEvents.java
@@ -0,0 +1,87 @@
+package com.empireminecraft.customevents;
+
+import net.minecraft.server.IInventory;
+import org.bukkit.Bukkit;
+import org.bukkit.Location;
+import org.bukkit.World;
+import org.bukkit.craftbukkit.CraftWorld;
+import org.bukkit.craftbukkit.inventory.CraftInventory;
+import org.bukkit.event.Cancellable;
+import org.bukkit.event.Event;
+import org.bukkit.event.HandlerList;
+import org.bukkit.inventory.Inventory;
+
+
+public class HopperEvents {
+    public static boolean drain(CraftWorld world, double x, double y, double z) {
+        Drain event = new Drain(world, x, y, z);
+        Bukkit.getPluginManager().callEvent(event);
+        return event.isCancelled();
+    }
+    public static boolean fill(CraftWorld world, double x, double y, double z, double tx, double ty, double tz) {
+        Fill event = new Fill(world, x, y, z, tx, ty, tz);
+        Bukkit.getPluginManager().callEvent(event);
+        return event.isCancelled();
+    }
+
+    public static class Drain extends Event implements Cancellable {
+        private static final HandlerList handlers = new HandlerList();
+        private boolean canceled;
+        Location loc;
+        public Drain(World world, double x, double y, double z) {
+            loc = new Location(world, x, y, z);
+        }
+        public Location getHopperLocation() {
+            return this.loc;
+        }
+
+        public boolean isCancelled() {
+            return canceled;
+        }
+
+        public void setCancelled(boolean cancel) {
+            canceled = cancel;
+        }
+
+        public HandlerList getHandlers() {
+            return handlers;
+        }
+
+        public static HandlerList getHandlerList() {
+            return handlers;
+        }
+    }
+
+    public static class Fill extends Event implements Cancellable {
+        private static final HandlerList handlers = new HandlerList();
+        private boolean canceled;
+        Location loc;
+        Location target;
+        public Fill(World world, double x, double y, double z, double tx, double ty, double tz) {
+            loc = new Location(world, x, y, z);
+            target = new Location(world, x, y, z);
+        }
+        public Location getHopperLocation() {
+            return this.loc;
+        }
+        public Location getTarget() {
+            return this.target;
+        }
+
+        public boolean isCancelled() {
+            return canceled;
+        }
+
+        public void setCancelled(boolean cancel) {
+            canceled = cancel;
+        }
+
+        public HandlerList getHandlers() {
+            return handlers;
+        }
+
+        public static HandlerList getHandlerList() {
+            return handlers;
+        }
+    }
+}
diff --git a/src/main/java/net/minecraft/server/TileEntityHopper.java b/src/main/java/net/minecraft/server/TileEntityHopper.java
index d406fbd..0d48f9f 100644
--- a/src/main/java/net/minecraft/server/TileEntityHopper.java
+++ b/src/main/java/net/minecraft/server/TileEntityHopper.java
@@ -3,6 +3,7 @@ package net.minecraft.server;
 import java.util.List;
 
 // CraftBukkit start
+import com.empireminecraft.customevents.HopperEvents;
 import org.bukkit.craftbukkit.entity.CraftHumanEntity;
 import org.bukkit.craftbukkit.inventory.CraftItemStack;
 import org.bukkit.entity.HumanEntity;
@@ -200,6 +201,9 @@ public class TileEntityHopper extends TileEntity implements IHopper {
         if (iinventory == null) {
             return false;
         } else {
+            int facing = BlockHopper.c(this.p());
+
+            if (HopperEvents.fill(world.getWorld(), x, y, z, (double) (this.x + Facing.b[facing]), (double) (this.y + Facing.c[facing]), (double) (this.z + Facing.d[facing]))) { return false; } // EMC
             for (int i = 0; i < this.getSize(); ++i) {
                 if (this.getItem(i) != null) {
                     ItemStack itemstack = this.getItem(i).cloneItemStack();
@@ -247,6 +251,7 @@ public class TileEntityHopper extends TileEntity implements IHopper {
         if (iinventory != null) {
             byte b0 = 0;
 
+            if (HopperEvents.drain(ihopper.getWorld().getWorld(), ihopper.aA(), ihopper.aB(), ihopper.aC())) { return false; } // EMC
             if (iinventory instanceof IWorldInventory && b0 > -1) {
                 IWorldInventory iworldinventory = (IWorldInventory) iinventory;
                 int[] aint = iworldinventory.getSlotsForFace(b0);
-- 
1.8.4

