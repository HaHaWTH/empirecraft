From 741cb9c0f8b23540303a1f9930d9f4196ef0d7e4 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Wed, 28 Jan 2015 01:01:17 -0500
Subject: [PATCH] Allow changing of player name in Prelogin

This is so we can disable player renames and force them to use old name temporarily.
---
 src/main/java/net/minecraft/server/LoginListener.java          | 2 +-
 src/main/java/net/minecraft/server/ThreadPlayerLookupUUID.java | 6 ++++++
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/LoginListener.java b/src/main/java/net/minecraft/server/LoginListener.java
index 8c9abdb..1bad1de 100644
--- a/src/main/java/net/minecraft/server/LoginListener.java
+++ b/src/main/java/net/minecraft/server/LoginListener.java
@@ -26,7 +26,7 @@ public class LoginListener implements PacketLoginInListener {
     public final NetworkManager networkManager;
     private EnumProtocolState g;
     private int h;
-    private GameProfile i;
+    public GameProfile i; // EMC
     private String j;
     private SecretKey loginKey;
     public String hostname = ""; // CraftBukkit - add field
diff --git a/src/main/java/net/minecraft/server/ThreadPlayerLookupUUID.java b/src/main/java/net/minecraft/server/ThreadPlayerLookupUUID.java
index 5086861..929e256 100644
--- a/src/main/java/net/minecraft/server/ThreadPlayerLookupUUID.java
+++ b/src/main/java/net/minecraft/server/ThreadPlayerLookupUUID.java
@@ -78,6 +78,12 @@ class ThreadPlayerLookupUUID extends Thread {
         AsyncPlayerPreLoginEvent asyncEvent = new AsyncPlayerPreLoginEvent(playerName, address, uniqueId);
         server.getPluginManager().callEvent(asyncEvent);
 
+        // EMC start
+        GameProfile old = a.i;
+        a.i = new GameProfile(uniqueId, asyncEvent.getName());
+        a.i.getProperties().putAll(old.getProperties());
+        // EMC end
+
         if (PlayerPreLoginEvent.getHandlerList().getRegisteredListeners().length != 0) {
             final PlayerPreLoginEvent event = new PlayerPreLoginEvent(playerName, address, uniqueId);
             if (asyncEvent.getResult() != PlayerPreLoginEvent.Result.ALLOWED) {
-- 
1.9.1

