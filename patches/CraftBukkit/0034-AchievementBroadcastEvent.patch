From 2f43dbf54ac0f61a728d8acc235f9860e2319328 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Fri, 6 Dec 2013 20:54:23 -0500
Subject: [PATCH] AchievementBroadcastEvent

Used to control who sees achievement message
---
 .../customevents/AchievementBroadcastEvent.java    | 37 ++++++++++++++++++++++
 .../minecraft/server/ServerStatisticManager.java   | 14 +++++++-
 2 files changed, 50 insertions(+), 1 deletion(-)
 create mode 100644 src/main/java/com/empireminecraft/customevents/AchievementBroadcastEvent.java

diff --git a/src/main/java/com/empireminecraft/customevents/AchievementBroadcastEvent.java b/src/main/java/com/empireminecraft/customevents/AchievementBroadcastEvent.java
new file mode 100644
index 0000000..129c0fa
--- /dev/null
+++ b/src/main/java/com/empireminecraft/customevents/AchievementBroadcastEvent.java
@@ -0,0 +1,37 @@
+package com.empireminecraft.customevents;
+
+import org.bukkit.entity.Player;
+import org.bukkit.event.Event;
+import org.bukkit.event.HandlerList;
+
+import java.util.ArrayList;
+import java.util.List;
+
+public class AchievementBroadcastEvent extends Event {
+    List<Player> players = new ArrayList<Player>();
+
+    public Player getTarget() {
+        return target;
+    }
+
+    public List<Player> getPlayers() {
+        return players;
+    }
+
+    public void setPlayers(List<Player> players) {
+        this.players = players;
+    }
+
+    final Player target;
+    private static final HandlerList handlers = new HandlerList();
+
+    public AchievementBroadcastEvent(Player target) {this.target = target;}
+
+    public HandlerList getHandlers() {
+        return handlers;
+    }
+
+    public static HandlerList getHandlerList() {
+        return handlers;
+    }
+}
diff --git a/src/main/java/net/minecraft/server/ServerStatisticManager.java b/src/main/java/net/minecraft/server/ServerStatisticManager.java
index 2f980cb..d116aa8 100644
--- a/src/main/java/net/minecraft/server/ServerStatisticManager.java
+++ b/src/main/java/net/minecraft/server/ServerStatisticManager.java
@@ -10,6 +10,7 @@ import java.util.Map;
 import java.util.Set;
 import java.util.Map.Entry;
 
+import com.empireminecraft.customevents.AchievementBroadcastEvent;
 import net.minecraft.util.com.google.common.collect.Maps;
 import net.minecraft.util.com.google.common.collect.Sets;
 import net.minecraft.util.com.google.gson.JsonElement;
@@ -19,6 +20,8 @@ import net.minecraft.util.com.google.gson.JsonParser;
 import net.minecraft.util.org.apache.commons.io.FileUtils;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
+import org.bukkit.craftbukkit.entity.CraftPlayer;
+import org.bukkit.entity.Player;
 
 public class ServerStatisticManager extends StatisticManager {
 
@@ -63,7 +66,16 @@ public class ServerStatisticManager extends StatisticManager {
         if (statistic.d() && j == 0 && i > 0) {
             this.g = true;
             if (this.c.ar()) {
-                this.c.getPlayerList().sendMessage(new ChatMessage("chat.type.achievement", new Object[] { entityhuman.getScoreboardDisplayName(), statistic.j()}));
+                // EMC start
+                ChatMessage achv = new ChatMessage("chat.type.achievement", new Object[] { entityhuman.getScoreboardDisplayName(), statistic.j()});
+                com.empireminecraft.customevents.AchievementBroadcastEvent event = new AchievementBroadcastEvent(
+                    (Player) entityhuman.getBukkitEntity());
+                event.callEvent();
+                for (Player player : event.getPlayers()) {
+                    ((CraftPlayer) player).getHandle().sendMessage(achv);
+                }
+                //this.c.getPlayerList().sendMessage(new ChatMessage("chat.type.achievement", new Object[] { entityhuman.getScoreboardDisplayName(), statistic.j()}));
+                // EMC end
             }
         }
     }
-- 
1.8.5

