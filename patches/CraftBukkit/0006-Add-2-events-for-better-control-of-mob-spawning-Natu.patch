From cb1ff7b4c4874461f73724f8f9e82d5af057f824 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 29 Nov 2012 10:48:07 -0500
Subject: [PATCH 6/9] Add 2 events for better control of mob spawning (Natural
 and Spawners)

---
 .../java/net/minecraft/server/SpawnerCreature.java |   13 ++++
 .../net/minecraft/server/TileEntityMobSpawner.java |   16 ++++-
 .../org/bukkit/event/entity/SpawnTickEvent.java    |   62 +++++++++++++++++++
 .../bukkit/event/entity/SpawnerInitiateEvent.java  |   65 ++++++++++++++++++++
 4 files changed, 155 insertions(+), 1 deletion(-)
 create mode 100644 src/main/java/org/bukkit/event/entity/SpawnTickEvent.java
 create mode 100644 src/main/java/org/bukkit/event/entity/SpawnerInitiateEvent.java

diff --git a/src/main/java/net/minecraft/server/SpawnerCreature.java b/src/main/java/net/minecraft/server/SpawnerCreature.java
index 576cbd3..96b7bde 100644
--- a/src/main/java/net/minecraft/server/SpawnerCreature.java
+++ b/src/main/java/net/minecraft/server/SpawnerCreature.java
@@ -5,11 +5,15 @@ import java.util.HashMap;
 import java.util.Iterator;
 import java.util.List;
 import java.util.Random;
+import org.bukkit.Bukkit;
+import org.bukkit.craftbukkit.CraftChunk;
 
 // CraftBukkit start
 import org.bukkit.craftbukkit.util.LongHash;
 import org.bukkit.craftbukkit.util.LongObjectHashMap;
+import org.bukkit.event.Cancellable;
 import org.bukkit.event.entity.CreatureSpawnEvent.SpawnReason;
+import org.bukkit.event.entity.SpawnTickEvent;
 // CraftBukkit end
 
 public final class SpawnerCreature {
@@ -51,6 +55,15 @@ public final class SpawnerCreature {
                 j = MathHelper.floor(entityhuman.locZ / 16.0D);
                 byte b0 = spawnRadius; // Spigot - replace 8 with view distance constrained value
 
+                // EMC start - SpawnTickEvent
+                SpawnTickEvent event = new SpawnTickEvent(worldserver.getWorld(), spawnRadius, entityhuman.getBukkitEntity());
+                Bukkit.getPluginManager().callEvent(event);
+                if (event.isCancelled()) {
+                    continue;
+                }
+                b0 = event.getSpawnRadius();
+                // EMC end
+
                 for (int l = -b0; l <= b0; ++l) {
                     for (int i1 = -b0; i1 <= b0; ++i1) {
                         boolean flag3 = l == -b0 || l == b0 || i1 == -b0 || i1 == b0;
diff --git a/src/main/java/net/minecraft/server/TileEntityMobSpawner.java b/src/main/java/net/minecraft/server/TileEntityMobSpawner.java
index b6ad98c..5977f65 100644
--- a/src/main/java/net/minecraft/server/TileEntityMobSpawner.java
+++ b/src/main/java/net/minecraft/server/TileEntityMobSpawner.java
@@ -4,6 +4,8 @@ import java.util.ArrayList;
 import java.util.Collection;
 import java.util.Iterator;
 import java.util.List;
+import org.bukkit.Bukkit;
+import org.bukkit.event.entity.SpawnerInitiateEvent;
 
 public class TileEntityMobSpawner extends TileEntity {
 
@@ -34,7 +36,19 @@ public class TileEntityMobSpawner extends TileEntity {
     }
 
     public boolean b() {
-        return this.world.findNearbyPlayer((double) this.x + 0.5D, (double) this.y + 0.5D, (double) this.z + 0.5D, (double) this.requiredPlayerRange) != null;
+        // EMC start - Add in SpawnerInitiateEvent
+        EntityHuman entity = this.world.findNearbyPlayer((double) this.x + 0.5D, (double) this.y + 0.5D, (double) this.z + 0.5D, (double) this.requiredPlayerRange);
+        if (entity == null) {
+            return false;
+        }
+        org.bukkit.Location loc = new org.bukkit.Location(this.world.getWorld(), this.x, this.y, this.z);
+        SpawnerInitiateEvent event = new SpawnerInitiateEvent(this.mobName, this.world.getWorld(), loc, entity.getBukkitEntity());
+        Bukkit.getPluginManager().callEvent(event);
+        if (event.isCancelled()) {
+            return false;
+        }
+        return true;
+        // EMC end
     }
 
     public void g() {
diff --git a/src/main/java/org/bukkit/event/entity/SpawnTickEvent.java b/src/main/java/org/bukkit/event/entity/SpawnTickEvent.java
new file mode 100644
index 0000000..64e0311
--- /dev/null
+++ b/src/main/java/org/bukkit/event/entity/SpawnTickEvent.java
@@ -0,0 +1,62 @@
+/*
+ * To change this template, choose Tools | Templates
+ * and open the template in the editor.
+ */
+package org.bukkit.event.entity;
+
+
+
+import org.bukkit.World;
+import org.bukkit.entity.HumanEntity;
+import org.bukkit.event.Cancellable;
+import org.bukkit.event.Event;
+import org.bukkit.event.HandlerList;
+
+/**
+ *
+ * @author aikar
+ */
+public class SpawnTickEvent extends Event implements Cancellable {
+    private static final HandlerList handlers = new HandlerList();
+    private boolean canceled;
+    byte radius;
+    World world;
+    HumanEntity entity;
+    public SpawnTickEvent(World world, byte radius, HumanEntity entity) {        
+        this.world = world;
+        this.radius = radius;
+        this.entity = entity;
+    }
+
+    public World getWorld() {
+        return this.world;
+    }
+
+    public HumanEntity getEntity() {
+        return this.entity;
+    }
+
+    public byte getSpawnRadius() {
+        return this.radius;
+    }
+
+    public void setSpawnRadius(byte radius) {
+        this.radius = radius;
+    }
+
+    public boolean isCancelled() {
+        return canceled;
+    }
+
+    public void setCancelled(boolean cancel) {
+        canceled = cancel;
+    }
+
+    public HandlerList getHandlers() {
+        return handlers;
+    }
+
+    public static HandlerList getHandlerList() {
+        return handlers;
+    }
+}
diff --git a/src/main/java/org/bukkit/event/entity/SpawnerInitiateEvent.java b/src/main/java/org/bukkit/event/entity/SpawnerInitiateEvent.java
new file mode 100644
index 0000000..3dac565
--- /dev/null
+++ b/src/main/java/org/bukkit/event/entity/SpawnerInitiateEvent.java
@@ -0,0 +1,65 @@
+/*
+ * To change this template, choose Tools | Templates
+ * and open the template in the editor.
+ */
+package org.bukkit.event.entity;
+
+
+
+import org.bukkit.Location;
+import org.bukkit.World;
+import org.bukkit.entity.HumanEntity;
+import org.bukkit.event.Cancellable;
+import org.bukkit.event.Event;
+import org.bukkit.event.HandlerList;
+
+/**
+ *
+ * @author aikar
+ */
+public class SpawnerInitiateEvent extends Event implements Cancellable {
+    private static final HandlerList handlers = new HandlerList();
+    private boolean canceled;
+    Location loc;
+    World world;
+    String mob;
+    HumanEntity entity;
+    public SpawnerInitiateEvent(String mob, World world, Location loc, HumanEntity entity) {        
+        this.world = world;
+        this.loc = loc;
+        this.mob = mob;
+        this.entity = entity;
+    }
+
+    public World getWorld() {
+        return this.world;
+    }
+    
+    public String getMobName() {
+        return this.mob;
+    }
+    
+    public HumanEntity getTriggeringPlayer() {
+        return this.entity;
+    }
+
+    public Location getSpawnerLocation() {
+        return this.loc;
+    }
+
+    public boolean isCancelled() {
+        return canceled;
+    }
+
+    public void setCancelled(boolean cancel) {
+        canceled = cancel;
+    }
+
+    public HandlerList getHandlers() {
+        return handlers;
+    }
+
+    public static HandlerList getHandlerList() {
+        return handlers;
+    }
+}
-- 
1.7.10.4

