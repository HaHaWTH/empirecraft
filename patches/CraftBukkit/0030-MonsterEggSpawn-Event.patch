From 44ee682d613bb1f9c1b9d9a42c72ec92b347cf83 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Sat, 20 Jul 2013 22:40:56 -0400
Subject: [PATCH] MonsterEggSpawn Event

Get the itemstack used to spawn an entity
---
 .../customevents/MonsterEggSpawnEvent.java         | 56 ++++++++++++++++++++++
 .../java/net/minecraft/server/ItemMonsterEgg.java  | 32 +++++++++++--
 2 files changed, 85 insertions(+), 3 deletions(-)
 create mode 100644 src/main/java/com/empireminecraft/customevents/MonsterEggSpawnEvent.java

diff --git a/src/main/java/com/empireminecraft/customevents/MonsterEggSpawnEvent.java b/src/main/java/com/empireminecraft/customevents/MonsterEggSpawnEvent.java
new file mode 100644
index 0000000..879625f
--- /dev/null
+++ b/src/main/java/com/empireminecraft/customevents/MonsterEggSpawnEvent.java
@@ -0,0 +1,56 @@
+package com.empireminecraft.customevents;
+
+
+import org.bukkit.entity.LivingEntity;
+import org.bukkit.event.Cancellable;
+import org.bukkit.event.Event;
+import org.bukkit.event.HandlerList;
+import org.bukkit.inventory.ItemStack;
+
+public class MonsterEggSpawnEvent extends Event implements Cancellable {
+    private static final HandlerList handlers = new HandlerList();
+    private boolean canceled;
+
+
+
+    LivingEntity entity;
+    final ItemStack item;
+
+    public MonsterEggSpawnEvent(LivingEntity entity, ItemStack item) {
+        this.entity = entity;
+        this.item = item;
+    }
+
+    public LivingEntity getEntity() {
+        return entity;
+    }
+
+    public void setEntity(LivingEntity entity) {
+        if (entity == null) {
+            canceled = true;
+            return;
+        }
+        this.entity = entity;
+    }
+
+    public ItemStack getItem() {
+        return item;
+    }
+
+    public boolean isCancelled() {
+        return canceled;
+    }
+
+    public void setCancelled(boolean cancel) {
+        canceled = cancel;
+    }
+
+    public HandlerList getHandlers() {
+        return handlers;
+    }
+
+    public static HandlerList getHandlerList() {
+        return handlers;
+    }
+
+}
diff --git a/src/main/java/net/minecraft/server/ItemMonsterEgg.java b/src/main/java/net/minecraft/server/ItemMonsterEgg.java
index 06967d8..822528b 100644
--- a/src/main/java/net/minecraft/server/ItemMonsterEgg.java
+++ b/src/main/java/net/minecraft/server/ItemMonsterEgg.java
@@ -1,5 +1,10 @@
 package net.minecraft.server;
 
+import com.empireminecraft.customevents.MonsterEggSpawnEvent;
+import org.bukkit.craftbukkit.entity.CraftEntity;
+import org.bukkit.craftbukkit.inventory.CraftItemStack;
+import org.bukkit.entity.LivingEntity;
+
 public class ItemMonsterEgg extends Item {
 
     public ItemMonsterEgg(int i) {
@@ -34,7 +39,7 @@ public class ItemMonsterEgg extends Item {
                 d0 = 0.5D;
             }
 
-            Entity entity = a(world, itemstack.getData(), (double) i + 0.5D, (double) j + d0, (double) k + 0.5D);
+            Entity entity = a(world, itemstack, itemstack.getData(), (double) i + 0.5D, (double) j + d0, (double) k + 0.5D);
 
             if (entity != null) {
                 if (entity instanceof EntityLiving && itemstack.hasName()) {
@@ -73,7 +78,7 @@ public class ItemMonsterEgg extends Item {
                     }
 
                     if (world.getMaterial(i, j, k) == Material.WATER) {
-                        Entity entity = a(world, itemstack.getData(), (double) i, (double) j, (double) k);
+                        Entity entity = a(world, itemstack, itemstack.getData(), (double) i, (double) j, (double) k); // add
 
                         if (entity != null) {
                             if (entity instanceof EntityLiving && itemstack.hasName()) {
@@ -92,7 +97,12 @@ public class ItemMonsterEgg extends Item {
         }
     }
 
+    // EMC start -- add itemstack parameter
     public static Entity a(World world, int i, double d0, double d1, double d2) {
+        return a(world, null, i, d0, d1, d2);
+    }
+    public static Entity a(World world, ItemStack item, int i, double d0, double d1, double d2) {
+    // EMC end
         if (!EntityTypes.a.containsKey(Integer.valueOf(i))) {
             return null;
         } else {
@@ -107,7 +117,23 @@ public class ItemMonsterEgg extends Item {
                     entityinsentient.aP = entityinsentient.yaw;
                     entityinsentient.aN = entityinsentient.yaw;
                     entityinsentient.a((GroupDataEntity) null);
-                    world.addEntity(entity, org.bukkit.event.entity.CreatureSpawnEvent.SpawnReason.SPAWNER_EGG); // CraftBukkit
+                    // EMC start - if false the spawn was cancelled, add new event
+                    if (!world.addEntity(entity, org.bukkit.event.entity.CreatureSpawnEvent.SpawnReason.SPAWNER_EGG)) { // CraftBukkit
+                        return null;
+                    }
+                    if (item != null) {
+                        final MonsterEggSpawnEvent event = new MonsterEggSpawnEvent((LivingEntity) entity.getBukkitEntity(), CraftItemStack.asCraftMirror(item));
+
+                        if (!event.callEvent()) {
+                            world.removeEntity(entity);
+                            return null;
+                        }
+                        if (event.getEntity().getEntityId() != entity.id) {
+                            world.removeEntity(entity);
+                            entity = entityinsentient = (EntityInsentient) ((CraftEntity) event.getEntity()).getHandle();
+                        }
+                    }
+                    // EMC end
                     entityinsentient.p();
                 }
             }
-- 
1.8.3.2

