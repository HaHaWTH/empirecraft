From 300faa25cc5307cbe4fbde98d01772f35c4a7621 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Tue, 16 Jul 2013 20:45:12 -0400
Subject: [PATCH] Invalidate Metadata on reload

Metadata is not meant to persist reload as things break badly with non primitive types
This will invalidate metadata on reload so it does not crash everything if a plugin uses it.
---
 src/main/java/org/bukkit/craftbukkit/CraftServer.java | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index e96810b..dd97003 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -788,6 +788,13 @@ public final class CraftServer implements Server {
             }
             world.spigotConfig.init(); // Spigot
         }
+        // Spigot start
+        for (Plugin plugin : pluginManager.getPlugins()) {
+            entityMetadata.invalidateAll(plugin);
+            worldMetadata.invalidateAll(plugin);
+            playerMetadata.invalidateAll(plugin);
+        }
+        // Spigot end
 
         pluginManager.clearPlugins();
         commandMap.clearCommands();
-- 
1.9.1

