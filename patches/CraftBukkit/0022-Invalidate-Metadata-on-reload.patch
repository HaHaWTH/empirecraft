From c80c5007cc3001d7d5687caf4aa2a83eacced5fc Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Tue, 16 Jul 2013 20:45:12 -0400
Subject: [PATCH] Invalidate Metadata on reload

Metadata is not meant to persist reload as things break badly with non primitive types
This will invalidate metadata on reload so it does not crash everything if a plugin uses it.
---
 src/main/java/org/bukkit/craftbukkit/CraftServer.java | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index 04b44cd..cbbf1a3 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -832,6 +832,13 @@ public final class CraftServer implements Server {
             }
             world.spigotConfig.init(); // Spigot
         }
+        // Spigot start
+        for (Plugin plugin : pluginManager.getPlugins()) {
+            entityMetadata.invalidateAll(plugin);
+            worldMetadata.invalidateAll(plugin);
+            playerMetadata.invalidateAll(plugin);
+        }
+        // Spigot end
 
         pluginManager.clearPlugins();
         commandMap.clearCommands();
-- 
1.9.1

