From 63b8ba883b4f85922899c0b43c6433ed9f9019c3 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Wed, 27 Feb 2013 23:27:45 -0500
Subject: [PATCH] Hidden Item Meta

This adds the ability to store hidden metadata in item lore.

Simply set a line to "&&::META" and every blank line before, that line, and every line after will be hidden from view on the client.

for example, you can set &&::META on line 20, and there will not be 19 blank lines before it.
Then you can store Data on 21+

Also adds a &&::SHINY tag to send a fake enchantment aura if it does not exists.
Must be set before META
---
 src/main/java/net/minecraft/server/Packet.java | 49 ++++++++++++++++++++++++++
 1 file changed, 49 insertions(+)

diff --git a/src/main/java/net/minecraft/server/Packet.java b/src/main/java/net/minecraft/server/Packet.java
index c4212e8..ac9b233 100644
--- a/src/main/java/net/minecraft/server/Packet.java
+++ b/src/main/java/net/minecraft/server/Packet.java
@@ -205,6 +205,23 @@ public abstract class Packet {
 
             itemstack = new ItemStack(short1, b0, short2);
             itemstack.tag = d(datainputstream);
+            // EMC start - get around creative menu having ultimate control of the NBT...
+            if (itemstack.tag != null) {
+                if (itemstack.tag.hasKey("display")) {
+                    NBTTagCompound display = itemstack.tag.getCompound("display");
+                    if (display.hasKey("OriginalLore")) {
+                        display.set("Lore", display.getList("OriginalLore"));
+                        display.remove("OriginalLore");
+                    }
+                }
+                // If shiny was used
+                if (itemstack.tag.hasKey("ench")) {
+                    if (itemstack.tag.getList("ench").size() == 0) {
+                        itemstack.tag.remove("ench");
+                    }
+                }
+            }
+            // EMC end
         }
 
         return itemstack;
@@ -221,6 +238,38 @@ public abstract class Packet {
 
             if (itemstack.getItem().o() || itemstack.getItem().r()) {
                 nbttagcompound = itemstack.tag;
+                // EMC start
+                if (nbttagcompound != null && nbttagcompound.hasKey("display")) {
+                    NBTTagCompound display = nbttagcompound.getCompound("display");
+                    if (display.hasKey("Lore")) {
+                        NBTTagList lore = display.getList("Lore");
+                        int lastLine = 0;
+                        for (int i = 0; i < lore.size(); i++) {
+                            String line = ((NBTTagString) lore.get(i)).data;
+
+                            if (line.equals("&&::META")) {
+                                NBTTagList newlore = new NBTTagList("Lore");
+                                for (int x = 0; x < lastLine; x++) {
+                                    newlore.add(lore.get(x));
+                                }
+                                nbttagcompound = (NBTTagCompound) nbttagcompound.clone();
+                                display = nbttagcompound.getCompound("display");
+                                display.set("Lore", newlore);
+                                display.set("OriginalLore", lore);
+                                break;
+                            } else if (!line.isEmpty()) {
+                                if (line.equals("&&::SHINY")) {
+                                    if (!nbttagcompound.hasKey("ench")) {
+                                        nbttagcompound.set("ench" , new NBTTagList());
+                                    }
+                                } else {
+                                    lastLine = i+1;
+                                }
+                            }
+                        }
+                    }
+                }
+                // EMC end
             }
 
             a(nbttagcompound, dataoutputstream);
-- 
1.8.2

