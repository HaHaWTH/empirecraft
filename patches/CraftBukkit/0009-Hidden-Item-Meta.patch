From c3919553bc2fcde8465d67393baa01f6de9ee918 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Wed, 27 Feb 2013 23:27:45 -0500
Subject: [PATCH] Hidden Item Meta

This adds the ability to store hidden metadata in item lore.

Simply set a line to "&&::META" and every blank line before, that line, and every line after will be hidden from view on the client.

for example, you can set &&::META on line 20, and there will not be 19 blank lines before it.
Then you can store Data on 21+

Also adds a &&::SHINY tag to send a fake enchantment aura if it does not exists.
Must be set before META
---
 .../com/empireminecraft/cbmisc/HiddenItemMeta.java | 53 ++++++++++++++++++++++
 .../net/minecraft/server/PacketDataSerializer.java | 16 +++++++
 2 files changed, 69 insertions(+)
 create mode 100644 src/main/java/com/empireminecraft/cbmisc/HiddenItemMeta.java

diff --git a/src/main/java/com/empireminecraft/cbmisc/HiddenItemMeta.java b/src/main/java/com/empireminecraft/cbmisc/HiddenItemMeta.java
new file mode 100644
index 0000000..6f8b7e6
--- /dev/null
+++ b/src/main/java/com/empireminecraft/cbmisc/HiddenItemMeta.java
@@ -0,0 +1,53 @@
+package com.empireminecraft.cbmisc;
+
+import net.minecraft.server.NBTTagCompound;
+import net.minecraft.server.NBTTagList;
+import net.minecraft.server.NBTTagString;
+
+public class HiddenItemMeta {
+    public static NBTTagCompound filterItemLore(NBTTagCompound nbttagcompound, boolean storeOriginal) {
+        // EMC start
+        if (nbttagcompound != null && nbttagcompound.hasKey("display")) {
+            NBTTagCompound display = nbttagcompound.getCompound("display");
+            if (display.hasKey("Lore")) {
+                NBTTagList lore = display.getList("Lore", 8);
+                int lastLine = 0;
+                boolean hasSpecial = false;
+                boolean hasShiny = false;
+                for (int i = 0; i < lore.size(); i++) {
+                    String line = lore.f(i);
+
+                    if (line.equals("&&::META")) {
+                        hasSpecial = true;
+                        break;
+                    } else if (!line.isEmpty()) {
+                        if (line.equals("&&::SHINY")) {
+                            hasShiny = true;
+                            hasSpecial = true;
+                            break;
+                        } else {
+                            lastLine = i+1;
+                        }
+                    }
+                }
+                if (hasSpecial) {
+                    NBTTagList newlore = new NBTTagList();
+                    for (int x = 0; x < lastLine; x++) {
+                        newlore.add(new NBTTagString(lore.f(x)));
+                    }
+
+                    nbttagcompound = (NBTTagCompound) nbttagcompound.clone();
+                    if (hasShiny && !nbttagcompound.hasKey("ench")) {
+                        nbttagcompound.set("ench" , new NBTTagList());
+                    }
+                    display = nbttagcompound.getCompound("display");
+                    display.set("Lore", newlore);
+                    if (storeOriginal) {
+                        display.set("OriginalLore", lore);
+                    }
+                }
+            }
+        }
+        return nbttagcompound;
+    }
+}
diff --git a/src/main/java/net/minecraft/server/PacketDataSerializer.java b/src/main/java/net/minecraft/server/PacketDataSerializer.java
index fe2b24d..8d6a062 100644
--- a/src/main/java/net/minecraft/server/PacketDataSerializer.java
+++ b/src/main/java/net/minecraft/server/PacketDataSerializer.java
@@ -89,6 +89,7 @@ public class PacketDataSerializer extends ByteBuf {
 
             if (itemstack.getItem().usesDurability() || itemstack.getItem().s()) {
                 nbttagcompound = itemstack.tag;
+                com.empireminecraft.cbmisc.HiddenItemMeta.filterItemLore(nbttagcompound, true); // EMC
             }
 
             this.a(nbttagcompound);
@@ -107,6 +108,21 @@ public class PacketDataSerializer extends ByteBuf {
             itemstack.tag = this.b();
             // CraftBukkit start
             if (itemstack.tag != null) {
+                // EMC start - get around creative menu having ultimate control of the NBT...
+                if (itemstack.tag.hasKey("display")) {
+                    NBTTagCompound display = itemstack.tag.getCompound("display");
+                    if (display.hasKey("OriginalLore")) {
+                        display.set("Lore", display.getList("OriginalLore", 8));
+                        display.remove("OriginalLore");
+                    }
+                }
+                // If shiny was used
+                if (itemstack.tag.hasKey("ench")) {
+                    if (itemstack.tag.getList("ench", 10).size() == 0) {
+                        itemstack.tag.remove("ench");
+                    }
+                }
+                // EMC end
                 CraftItemStack.setItemMeta(itemstack, CraftItemStack.getItemMeta(itemstack));
             }
             // CraftBukkit end
-- 
1.8.3.2

