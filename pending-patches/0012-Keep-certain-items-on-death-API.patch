From b3274785516a1e023ec889b9811d8123d704015e Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Mon, 11 Mar 2013 21:05:05 -0400
Subject: [PATCH] Keep certain items on death API

This adds a getItemsToKeep to PlayerDeathEvent that can be modified for what item a player should keep upon death.

This can be used for never-to-be-dropped items.
---
 .../java/net/minecraft/server/EntityPlayer.java    | 30 ++++++++++++++++++++++
 1 file changed, 30 insertions(+)

diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index 6e80242..5be306f 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -397,6 +397,10 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
 
         // we clean the player's inventory after the EntityDeathEvent is called so plugins can get the exact state of the inventory.
         if (!event.getKeepInventory()) {
+            // EMC start - replace logic
+            processKeep(event, this.inventory.armor);
+            processKeep(event, this.inventory.items);
+            /*
             for (int i = 0; i < this.inventory.items.length; ++i) {
                 this.inventory.items[i] = null;
             }
@@ -404,6 +408,8 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
             for (int i = 0; i < this.inventory.armor.length; ++i) {
                 this.inventory.armor[i] = null;
             }
+            */
+            // EMC end
         }
 
         this.closeInventory();
@@ -436,6 +442,30 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
         this.aW().g();
     }
 
+    // EMC start
+    private void processKeep(org.bukkit.event.entity.PlayerDeathEvent event, ItemStack[] inv) {
+        for (int i = 0; i < inv.length; ++i) {
+            if (inv[i] == null) continue;
+            final org.bukkit.inventory.ItemStack bukkitStack = inv[i].getBukkitStack();
+
+            boolean keep = false;
+            final Iterator<org.bukkit.inventory.ItemStack> iterator = event.getItemsToKeep().iterator();
+            while (iterator.hasNext()) {
+                final org.bukkit.inventory.ItemStack keepStack = iterator.next();
+                if (bukkitStack.equals(keepStack)) {
+                    iterator.remove();
+                    keep = true;
+                    break;
+                }
+            }
+            if (!keep) {
+                inv[i] = null;
+            }
+        }
+
+    }
+    // EMC end
+
     public boolean damageEntity(DamageSource damagesource, float f) {
         if (this.isInvulnerable()) {
             return false;
-- 
1.9.1

