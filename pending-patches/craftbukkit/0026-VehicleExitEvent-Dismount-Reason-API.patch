From bb765e34280b71bba478593b3175d20dd290c23c Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Wed, 7 Aug 2013 19:52:14 -0400
Subject: [PATCH] VehicleExitEvent Dismount Reason API

---
 src/main/java/net/minecraft/server/Entity.java       | 5 +++++
 src/main/java/net/minecraft/server/EntityHuman.java  | 2 ++
 src/main/java/net/minecraft/server/EntityLiving.java | 1 +
 src/main/java/net/minecraft/server/World.java        | 2 ++
 4 files changed, 10 insertions(+)

diff --git a/src/main/java/net/minecraft/server/Entity.java b/src/main/java/net/minecraft/server/Entity.java
index e9e85ad..e5b550b 100644
--- a/src/main/java/net/minecraft/server/Entity.java
+++ b/src/main/java/net/minecraft/server/Entity.java
@@ -1457,7 +1457,10 @@ public abstract class Entity {
         return this.bukkitEntity;
     }
 
+    VehicleExitEvent.DismountReason dismountReason = VehicleExitEvent.DismountReason.UNKNOWN; // EMC
     public void setPassengerOf(Entity entity) {
+        VehicleExitEvent.DismountReason reason = dismountReason; // EMC
+        dismountReason = VehicleExitEvent.DismountReason.UNKNOWN; // EMC
         // b(null) doesn't really fly for overloaded methods,
         // so this method is needed
 
@@ -1473,6 +1476,7 @@ public abstract class Entity {
                 // CraftBukkit start
                 if ((this.bukkitEntity instanceof LivingEntity) && (this.vehicle.getBukkitEntity() instanceof Vehicle)) {
                     VehicleExitEvent event = new VehicleExitEvent((Vehicle) this.vehicle.getBukkitEntity(), (LivingEntity) this.bukkitEntity);
+                    event.reason = reason; // EMC
                     pluginManager.callEvent(event);
 
                     if (event.isCancelled() || this.vehicle != originalVehicle) {
@@ -1494,6 +1498,7 @@ public abstract class Entity {
                 VehicleExitEvent exitEvent = null;
                 if (this.vehicle != null && this.vehicle.getBukkitEntity() instanceof Vehicle) {
                     exitEvent = new VehicleExitEvent((Vehicle) this.vehicle.getBukkitEntity(), (LivingEntity) this.bukkitEntity);
+                    exitEvent.reason = VehicleExitEvent.DismountReason.TRANSFER; // EMC
                     pluginManager.callEvent(exitEvent);
 
                     if (exitEvent.isCancelled() || this.vehicle != originalVehicle || (this.vehicle != null && this.vehicle.passenger != originalPassenger)) {
diff --git a/src/main/java/net/minecraft/server/EntityHuman.java b/src/main/java/net/minecraft/server/EntityHuman.java
index 7f8d6b4..e54803d 100644
--- a/src/main/java/net/minecraft/server/EntityHuman.java
+++ b/src/main/java/net/minecraft/server/EntityHuman.java
@@ -356,6 +356,7 @@ public abstract class EntityHuman extends EntityLiving implements ICommandListen
 
     public void ab() {
         if (!this.world.isStatic && this.isSneaking()) {
+            this.dismountReason = org.bukkit.event.vehicle.VehicleExitEvent.DismountReason.PLAYER; // EMC
             this.mount((Entity) null);
             this.setSneaking(false);
         } else {
@@ -1065,6 +1066,7 @@ public abstract class EntityHuman extends EntityLiving implements ICommandListen
         }
 
         if (this.am()) {
+            this.dismountReason = org.bukkit.event.vehicle.VehicleExitEvent.DismountReason.PLAYER; // EMC
             this.mount((Entity) null);
         }
 
diff --git a/src/main/java/net/minecraft/server/EntityLiving.java b/src/main/java/net/minecraft/server/EntityLiving.java
index a11793d..7528520 100644
--- a/src/main/java/net/minecraft/server/EntityLiving.java
+++ b/src/main/java/net/minecraft/server/EntityLiving.java
@@ -194,6 +194,7 @@ public abstract class EntityLiving extends Entity {
             }
 
             if (!this.world.isStatic && this.am() && this.vehicle instanceof EntityLiving) {
+                this.dismountReason = org.bukkit.event.vehicle.VehicleExitEvent.DismountReason.WATER; // EMC
                 this.mount((Entity) null);
             }
         } else {
diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index 419d9f0..9d09b0d 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -1162,10 +1162,12 @@ public abstract class World implements IBlockAccess {
 
     public void kill(Entity entity) {
         if (entity.passenger != null) {
+            entity.passenger.dismountReason = org.bukkit.event.vehicle.VehicleExitEvent.DismountReason.DEAD; // EMC
             entity.passenger.mount((Entity) null);
         }
 
         if (entity.vehicle != null) {
+            entity.dismountReason = org.bukkit.event.vehicle.VehicleExitEvent.DismountReason.DEAD; // EMC
             entity.mount((Entity) null);
         }
 
-- 
1.9.1

