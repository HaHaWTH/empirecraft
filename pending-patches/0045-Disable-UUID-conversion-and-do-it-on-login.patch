From 2169787c0426b7697b8a815999514deab7c15b91 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Mon, 14 Apr 2014 20:44:38 -0400
Subject: [PATCH] Disable UUID conversion and do it on login

---
 src/main/java/net/minecraft/server/DedicatedServer.java            | 4 ++--
 .../java/net/minecraft/server/NameReferencingFileConverter.java    | 1 +
 src/main/java/net/minecraft/server/WorldNBTStorage.java            | 7 +++++++
 src/main/java/org/bukkit/craftbukkit/Main.java                     | 2 +-
 4 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/src/main/java/net/minecraft/server/DedicatedServer.java b/src/main/java/net/minecraft/server/DedicatedServer.java
index 9cc0526..08853e1 100644
--- a/src/main/java/net/minecraft/server/DedicatedServer.java
+++ b/src/main/java/net/minecraft/server/DedicatedServer.java
@@ -473,7 +473,7 @@ public class DedicatedServer extends MinecraftServer implements IMinecraftServer
             flag3 = NameReferencingFileConverter.d((MinecraftServer) this);
         }
 
-        boolean flag4 = false;
+        boolean flag4 = true; // EMC - Disable Full Player data conversion, it will happen on login.
 
         for (i = 0; !flag4 && i <= 2; ++i) {
             if (i > 0) {
@@ -482,7 +482,7 @@ public class DedicatedServer extends MinecraftServer implements IMinecraftServer
                 this.aG();
             }
 
-            flag4 = NameReferencingFileConverter.a(this, this.propertyManager);
+            // flag4 = NameReferencingFileConverter.a(this, this.propertyManager); // EMC - Disable Full Player data conversion, it will happen on login.
         }
 
         return flag || flag1 || flag2 || flag3 || flag4;
diff --git a/src/main/java/net/minecraft/server/NameReferencingFileConverter.java b/src/main/java/net/minecraft/server/NameReferencingFileConverter.java
index 56fb152..947e39e 100644
--- a/src/main/java/net/minecraft/server/NameReferencingFileConverter.java
+++ b/src/main/java/net/minecraft/server/NameReferencingFileConverter.java
@@ -347,6 +347,7 @@ public class NameReferencingFileConverter {
     }
 
     private static boolean c(PropertyManager propertymanager) {
+        if (true) return true; // EMC
         File file1 = d(propertymanager);
 
         if (file1.exists() && file1.isDirectory()) {
diff --git a/src/main/java/net/minecraft/server/WorldNBTStorage.java b/src/main/java/net/minecraft/server/WorldNBTStorage.java
index b1c0ea3..3009d8d 100644
--- a/src/main/java/net/minecraft/server/WorldNBTStorage.java
+++ b/src/main/java/net/minecraft/server/WorldNBTStorage.java
@@ -201,6 +201,13 @@ public class WorldNBTStorage implements IDataManager, IPlayerFileData {
 
         try {
             File file1 = new File(this.playerDir, entityhuman.getUniqueID().toString() + ".dat");
+            // EMC start
+            File fileold = new File(this.baseDir, "players/" + entityhuman.getName() + ".dat");
+            if (!file1.exists() && fileold.exists() && fileold.isFile()) {
+                fileold.renameTo(file1);
+                System.out.println("Converting " + entityhuman.getName() + " to UUID storage");
+            }
+            // EMC end
             // Spigot Start
             boolean usingWrongFile = false;
             if ( !file1.exists() )
diff --git a/src/main/java/org/bukkit/craftbukkit/Main.java b/src/main/java/org/bukkit/craftbukkit/Main.java
index 2e8d6f9..b5db950 100644
--- a/src/main/java/org/bukkit/craftbukkit/Main.java
+++ b/src/main/java/org/bukkit/craftbukkit/Main.java
@@ -24,7 +24,7 @@ public class Main {
     public static void main(String[] args) throws Exception {
         // Spigot Start
         File lock = new File( ".update-lock" );
-        if ( !new File( "update-lock" ).exists() && !lock.exists()  && System.getProperty( "IReallyKnowWhatIAmDoingThisUpdate" ) == null )
+        if ( !new File( "update-lock" ).exists() && !lock.exists()  && System.getProperty( "IReallyKnowWhatIAmDoingThisUpdate") == null && false) // E<C
         {
             System.err.println( "WARNING: This Minecraft update alters the way in which saved data is stored." );
             System.err.println( "Please ensure your server is in the correct online/offline mode state, as the changes made are PERMANENT" );
-- 
1.9.1

